{% extends "admin/base_site.html" %}
{% load static %}
{% load grid_extras %}

{% block extrastyle %}
<style>
  .grid-toolbar { margin: 0 0 12px; display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
  table.grid { width:100%; border-collapse: collapse; font-size:13px; }
  table.grid th, table.grid td { border:1px solid #e0e0e0; padding:4px 6px; vertical-align: top; }
  table.grid thead th { position: sticky; top: 0; background:#f8f8f8; z-index: 2; }
  .role-select { width: 220px; } /* —à–∏—Ä–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª–∏ —Ä—É—Å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
  .head-role { font-size: 11px; color:#666; }
  .head-caption { font-size: 11px; color:#333; margin-top:4px; max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é */
  .hidden-col { display:none; }
  .hidden-row { display:none; }
  .control-col { width: 36px; position: sticky; left: 0; background: #f8f8f8; z-index: 3; }
  .control-cell { position: sticky; left: 0; background: #fff; z-index: 2; }

  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (NAME_OF_WORK + UNIT (+QTY)) */
  .tc-row td { background: rgba(121, 174, 200, 0.18) !important; }

  /* –ù–µ—É—á—Ç—ë–Ω–Ω—ã–µ UNIT */
  td.unit-bad { background: rgba(220, 20, 60, 0.14) !important; }
</style>
{% endblock %}

{% block content %}
<div class="module">
  <h2>{{ title }}</h2>

  <div class="grid-toolbar">
    <a class="button" href="../change/">–ù–∞–∑–∞–¥</a>

    <label>–õ–∏—Å—Ç:&nbsp;
      <select id="sheet">
        {% for name in sheet_names %}
          <option value="{{ forloop.counter0 }}" {% if forloop.counter0 == sheet_index %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </label>

    <label style="display:flex;gap:6px;align-items:center">
      <input id="toggle-all" type="checkbox" {% if show_all %}checked{% endif %}>
      –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
    </label>

    <a class="button" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ö–µ–º—É</a>
    <a class="button" id="btn-extract">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã</a>

    <a class="button" id="btn-hide-rows">–°–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</a>
    <a class="button" id="btn-hide-cols">–°–∫—Ä—ã—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏</a>
    <a class="button" id="btn-show-all">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</a>

    <span style="margin-left:auto;display:flex;gap:12px;align-items:center;">
      <label style="display:flex;gap:6px;align-items:center">
        –Æ–Ω–∏—Ç—ã:&nbsp;
        <input id="unit-allow" type="text" value="{{ unit_allow_raw }}" style="width:180px"
               title="–°–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –µ–¥–∏–Ω–∏—Ü —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
      </label>
      <label style="display:flex;gap:6px;align-items:center">
        <input id="require-qty" type="checkbox" {% if require_qty %}checked{% endif %}>
        –¢—Ä–µ–±–æ–≤–∞—Ç—å –ö–û–õ-–í–û &gt; 0
      </label>
    </span>
  </div>

  <div style="margin:-8px 0 10px 0;color:#666;">
    –ü–æ–∫–∞–∑–∞–Ω–æ —Å—Ç—Ä–æ–∫: <strong>{{ rows|length }}</strong> –∏–∑ <strong>{{ total_rows }}</strong>.
    &nbsp; –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: <strong id="tc-counter">0</strong>.
    &nbsp; –ù–µ—É—á—Ç—ë–Ω–Ω—ã—Ö UNIT: <strong id="unit-bad-counter">0</strong>
    <span id="unit-bad-list" style="margin-left:8px;"></span>
  </div>

  <div style="overflow:auto; max-height: calc(100vh - 260px); border:1px solid #e0e0e0;">
    <table class="grid" id="grid">
      <thead>
        <tr>
          <th class="control-col"></th>
          {% for col in cols %}
            <th data-col="{{ col }}">
              <div><input type="checkbox" class="col-check" data-col="{{ col }}" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è"></div>

              <select class="role-select" data-col="{{ col }}">
                {% for r in role_defs %}
                  <option value="{{ r.id }}"
                          data-color="{{ r.color }}"
                          data-required="{{ r.required|yesno:'1,0' }}"
                          {% if col_roles|index:col == r.id %}selected{% endif %}>
                    {{ r.title }}
                  </option>
                {% endfor %}
              </select>

              <div class="head-role">–ö–æ–ª–æ–Ω–∫–∞ {{ col|excel_col }}</div>
              {% if col_headers|index:col %}
                <div class="head-caption">{{ col_headers|index:col }}</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for r in rows %}
        <tr data-row="{{ r.row_index }}" class="row">
          <td class="control-cell">
            <input type="checkbox" class="row-check" title="–û—Ç–º–µ—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è">
          </td>
          {% for col in cols %}
            {% with val=r.cells|index:col %}
              <td data-col="{{ col }}">{{ val }}</td>
            {% endwith %}
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p style="margin-top:8px;color:#666;">
    –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏: <strong>–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –†–ê–ë–û–¢/–¢–ö</strong>, <strong>–ï–î. –ò–ó–ú.</strong>, <strong>–ö–û–õ-–í–û</strong>.<br>
    –î–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –æ–Ω–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ö–æ—Ç—è –±—ã –ø–æ –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ç–∫–∏ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
  </p>
</div>
{% endblock %}

{% block footer %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // helpers
  function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():'';}
  const CSRF = getCookie('csrftoken');

  function navigateWith(params){
    const base = window.location.pathname;
    const p = new URLSearchParams(window.location.search);
    if (params.sheet != null) p.set('sheet', params.sheet);
    if (params.all != null)   p.set('all', params.all ? '1' : '0');
    const qs = p.toString();
    window.location.assign(qs ? (base + '?' + qs) : base);
  }

  // endpoints
  const SAVE_URL = window.location.pathname.replace(/\/grid\/?$/, "/api/save-schema/");
  const EXTRACT_URL = window.location.pathname.replace(/\/grid\/?$/, "/api/extract-from-grid/");

  // sheet + show_all controls
  document.getElementById('sheet')?.addEventListener('change', (e)=> navigateWith({sheet: e.target.value}));
  document.getElementById('toggle-all')?.addEventListener('change', (e)=> navigateWith({all: e.target.checked}));

  // roles helpers
  function collectRoles(){
    const roles = [];
    document.querySelectorAll('.role-select').forEach(sel=>{
      roles[parseInt(sel.dataset.col,10)] = sel.value;
    });
    return roles;
  }
  function getColsByRole(roleId){
    return Array.from(document.querySelectorAll('.role-select'))
      .filter(sel => sel.value === roleId)
      .map(sel => parseInt(sel.dataset.col, 10));
  }

  // colorize headers by selected role color
  function applyHeaderColors(){
    document.querySelectorAll('.role-select').forEach(sel=>{
      const th = sel.closest('th');
      const opt = sel.selectedOptions[0];
      const color = opt?.dataset?.color || '#ffffff';
      if (th) th.style.background = color;
    });
  }

  // --- Units normalization & hints (–∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) ---
  function normalizeUnit(u) {
    if (!u) return "";
    let s = (u || "").toLowerCase().trim();
    s = s.replaceAll('\u00B2', '2').replaceAll('\u00B3', '3').replace(/\s+/g, ' ').trim();
    const compact = s.replace(/\s|\.|\,/g, '');
    if (/^(–º\^?2|–º2|–∫–≤–º|–º–∫–≤|–∫–≤–∞–¥—Ä–∞—Ç–Ω\w*–º–µ—Ç—Ä\w*)$/.test(compact)) return '–º2';
    if (/^(–º\^?3|–º3|–∫—É–±–º|–º–∫—É–±|–∫—É–±–∏—á–µ—Å–∫\w*–º–µ—Ç—Ä\w*)$/.test(compact)) return '–º3';
    if (/^(—à—Ç|—à—Ç—É–∫–∞|—à—Ç—É–∫–∏|—à—Ç—É–∫)$/.test(compact)) return '—à—Ç';
    if (/^(–ø–º|–ø–æ–≥–º|–ø–æ–≥–æ–Ω–Ω—ã–π–º–µ—Ç—Ä|–ø–æ–≥–æ–Ω–Ω—ã—Ö–º–µ—Ç—Ä–æ–≤)$/.test(compact)) return '–ø–º';
    if (/^(–∫–æ–º–ø–ª|–∫–æ–º–ø–ª–µ–∫—Ç|–∫–æ–º–ø–ª–µ–∫—Ç–∞|–∫–æ–º–ø–ª–µ–∫—Ç–æ–≤)$/.test(compact)) return '–∫–æ–º–ø–ª';
    return compact;
  }
  function getAllowedUnitSet() {
    const raw = (document.getElementById('unit-allow')?.value || "").split(',');
    const set = new Set();
    for (const x of raw) {
      const norm = normalizeUnit(x);
      if (norm) set.add(norm);
    }
    return set;
  }
  function firstNonEmptyCellText(tr, cols) {
    for (const c of cols) {
      const td = tr.querySelector(`td[data-col="${c}"]`);
      if (!td) continue;
      const t = (td.textContent || '').trim();
      if (t) return t;
    }
    return "";
  }
  function anyNonEmpty(tr, cols) {
    return cols.some(c => {
      const td = tr.querySelector(`td[data-col="${c}"]`);
      return td && (td.textContent || '').trim() !== '';
    });
  }
  function qtyValue(tr, cols) {
    for (const c of cols) {
      const td = tr.querySelector(`td[data-col="${c}"]`);
      if (!td) continue;
      const raw = (td.textContent || '').replace(/\s/g, '').replace(',', '.');
      const num = parseFloat(raw);
      if (!isNaN(num)) return num;
    }
    return NaN;
  }

  // dynamic row hints: NAME_OF_WORK + UNIT (+ QTY)
  function applyRowHints(){
    const nameCols = getColsByRole('NAME_OF_WORK');
    const unitCols = getColsByRole('UNIT');
    const qtyCols  = getColsByRole('QTY');
    const requireQty = !!document.getElementById('require-qty')?.checked;
    const allowedUnits = getAllowedUnitSet();

    const rows = document.querySelectorAll('#grid tbody tr');
    let tcCount = 0;
    let unitBadCount = 0;
    const badUnitsSet = new Set();

    rows.forEach(tr => {
      tr.classList.remove('tc-row');
      tr.querySelectorAll('td.unit-bad').forEach(td => td.classList.remove('unit-bad'));

      // –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
      const hasName = anyNonEmpty(tr, nameCols);
      const unitRaw = firstNonEmptyCellText(tr, unitCols);
      const unitNorm = normalizeUnit(unitRaw);
      const hasUnit = !!unitNorm && (allowedUnits.size === 0 || allowedUnits.has(unitNorm));

      let okQty = true;
      if (requireQty) {
        const q = qtyValue(tr, qtyCols);
        okQty = !isNaN(q) && q > 0;
      }
      if (hasName && hasUnit && okQty) {
        tr.classList.add('tc-row');
        tcCount++;
      }

      // –Ω–µ—É—á—Ç—ë–Ω–Ω—ã–µ UNIT
      unitCols.forEach(c => {
        const td = tr.querySelector(`td[data-col="${c}"]`);
        if (!td) return;
        const raw = (td.textContent || '').trim();
        if (!raw) return;
        const norm = normalizeUnit(raw);
        if (!norm) return;
        if (allowedUnits.size > 0 && !allowedUnits.has(norm)) {
          td.classList.add('unit-bad');
          unitBadCount++;
          badUnitsSet.add(raw);
        }
      });
    });

    document.getElementById('tc-counter').textContent = String(tcCount);
    document.getElementById('unit-bad-counter').textContent = String(unitBadCount);
    const listEl = document.getElementById('unit-bad-list');
    const items = Array.from(badUnitsSet).slice(0, 20).map(x => `<code>${x}</code>`).join(', ');
    listEl.innerHTML = items ? `| –ü—Ä–∏–º–µ—Ä—ã: ${items}${badUnitsSet.size > 20 ? '‚Ä¶' : ''}` : '';
  }

  // guard: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã?
  function requiredRolesPresent(){
    const need = new Set(['NAME_OF_WORK','UNIT','QTY']);
    document.querySelectorAll('.role-select').forEach(sel => {
      need.delete(sel.value);
    });
    return need.size === 0;
  }

  // init: —Ü–≤–µ—Ç —à–∞–ø–æ–∫ + –ø–æ–¥—Å–∫–∞–∑–∫–∏
  function refreshUI(){
    applyHeaderColors();
    applyRowHints();
  }

  // —Å–æ–±—ã—Ç–∏—è
  document.querySelectorAll('.role-select').forEach(sel=>{
    sel.addEventListener('change', refreshUI);
  });
  document.getElementById('unit-allow')?.addEventListener('input', applyRowHints);
  document.getElementById('require-qty')?.addEventListener('change', applyRowHints);

  function getUnitAllowRaw(){ return document.getElementById('unit-allow')?.value || ""; }
  function getRequireQty(){ return !!document.getElementById('require-qty')?.checked; }


  // save schema
  document.getElementById('btn-save').onclick = async ()=>{
    const col_roles = collectRoles();
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(SAVE_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
      body: JSON.stringify({
        col_roles,
        sheet_index: parseInt(sheet,10)||0,
        unit_allow_raw: getUnitAllowRaw(),      
        require_qty: getRequireQty(),           
      })
    });
    const data = await resp.json();
    if (!data.ok) alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+(data.error||'unknown')); else alert('–°—Ö–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
  };

  // extract
  document.getElementById('btn-extract').onclick = async ()=>{
    if (!requiredRolesPresent()){
      alert('–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏: ¬´–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –†–ê–ë–û–¢/–¢–ö¬ª, ¬´–ï–î. –ò–ó–ú.¬ª, ¬´–ö–û–õ-–í–û¬ª.');
      return;
    }
    const col_roles = collectRoles();
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(EXTRACT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
      body: JSON.stringify({
        col_roles,
        sheet_index: parseInt(sheet,10)||0,
        unit_allow_raw: getUnitAllowRaw(),      // üîπ
        require_qty: getRequireQty(),           // üîπ
      })
    });
    const data = await resp.json();
    if (!data.ok) alert('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è: '+(data.error||'unknown')); else alert('–†–∞–∑–º–µ—Ç–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞. –û—Ç–∫—Ä–æ–π ¬´–ì—Ä–∞—Ñ¬ª –∏–ª–∏ ¬´–†–∞–∑–º–µ—Ç–∏—Ç—å¬ª.');
  };

  // hide/show UI
  document.getElementById('btn-hide-rows').onclick = ()=> {
    document.querySelectorAll('.row-check:checked').forEach(cb=> cb.closest('tr')?.classList.add('hidden-row'));
  };
  document.getElementById('btn-hide-cols').onclick = ()=> {
    document.querySelectorAll('.col-check:checked').forEach(cb=>{
      const col = parseInt(cb.dataset.col, 10);
      document.querySelector(`#grid thead th[data-col="${col}"]`)?.classList.add('hidden-col');
      document.querySelectorAll(`#grid tbody td[data-col="${col}"]`).forEach(td=> td.classList.add('hidden-col'));
    });
  };
  document.getElementById('btn-show-all').onclick = ()=> {
    document.querySelectorAll('.hidden-row').forEach(el=> el.classList.remove('hidden-row'));
    document.querySelectorAll('.hidden-col').forEach(el=> el.classList.remove('hidden-col'));
    document.querySelectorAll('.row-check, .col-check').forEach(cb=> cb.checked = false);
    refreshUI();
  };

  // first paint
  refreshUI();
});
</script>
{% endblock %}
