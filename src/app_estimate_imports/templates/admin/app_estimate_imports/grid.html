{% extends "admin/base_site.html" %}
{% load static %}
{% load grid_extras %}

{% block extrastyle %}
<style>
  .grid-toolbar { margin: 0 0 12px; display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
  table.grid { width:100%; border-collapse: collapse; font-size:13px; }
  table.grid th, table.grid td { border:1px solid #e0e0e0; padding:4px 6px; vertical-align: top; }
  table.grid thead th { position: sticky; top: 0; background:#f8f8f8; z-index: 2; }
  .role-select { width: 220px; }
  .head-role { font-size: 11px; color:#666; }
  .head-caption { font-size: 11px; color:#333; margin-top:4px; max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* –í–∏–¥–∏–º–æ—Å—Ç—å */
  .hidden-col { display:none; }
  .hidden-row { display:none; }

  /* –õ–∏–ø–∫–∞—è –∫–æ–ª–æ–Ω–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—á–µ–∫–±–æ–∫—Å + –∏–µ—Ä–∞—Ä—Ö–∏—è + –±–µ–π–¥–∂–∏) */
  .control-col { width: 48px; position: sticky; left: 0; background: #f8f8f8; z-index: 4; }
  .control-cell { position: sticky; left: 0; background: #fff; z-index: 3; padding: 0 4px !important; overflow: visible; }
  .ctrl-wrap { position: relative; min-height: 22px; padding-top: 2px; }
  .ctrl-wrap .cb { position: relative; z-index: 2; }

  /* –†–∏—Å—É–µ–º ¬´—Ä—ë–±—Ä–∞¬ª –∏–µ—Ä–∞—Ä—Ö–∏–∏ –≤ —Ç–æ–π –∂–µ —è—á–µ–π–∫–µ */
  .hier { position: absolute; inset: 0 0 0 0; z-index: 1; pointer-events: none; }
  .hier .lvl {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--lvl-color, #9e9e9e);
    border-radius: 1px;
    opacity: .95;
  }
  .hier .elbow {
    position: absolute;
    height: 10px; width: 10px;
    border-left: 3px solid var(--elbow-color, #9e9e9e);
    border-bottom: 3px solid var(--elbow-color, #9e9e9e);
    border-bottom-left-radius: 2px;
  }

  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (NAME_OF_WORK + UNIT (+QTY)) */
  .tc-row td { background: rgba(121, 174, 200, 0.18) !important; }

  /* –ù–µ—É—á—Ç—ë–Ω–Ω—ã–µ UNIT */
  td.unit-bad { background: rgba(220, 20, 60, 0.14) !important; }

  /* –ì—Ä—É–ø–ø—ã: –±–µ–π–¥–∂ –≤ —è—á–µ–π–∫–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –º—è–≥–∫–∞—è –∑–∞–ª–∏–≤–∫–∞ —Å—Ç—Ä–æ–∫ */
  .group-badge { font-size:11px; padding:2px 6px; border-radius:10px; display:inline-block; margin: 2px 0 0 0; cursor: pointer; white-space:nowrap; position: relative; z-index: 3; max-width: 280px; }
  .group-badge:hover { filter: brightness(0.95); }
  tr[data-group~="1"] td { background-image: linear-gradient(0deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02)); }

  /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É" */
  .btn-create-estimate {
    background: #417690;
    color: white;
    font-weight: 500;
    border: none;
    padding: 8px 16px;
    cursor: pointer;
    border-radius: 4px;
    text-decoration: none;
    display: inline-block;
  }
  .btn-create-estimate:hover {
    background: #345a6d;
    color: white;
  }

  /* Floating Action Bar */
  .floating-action-bar {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.1);
    padding: 12px;
    min-width: 280px;
    z-index: 1000;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
  }
  .floating-action-bar.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
  .fab-header {
    font-size: 13px;
    font-weight: 600;
    color: #333;
    padding-bottom: 8px;
    margin-bottom: 8px;
    border-bottom: 1px solid #e0e0e0;
  }
  .fab-counter {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }
  .fab-actions {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .fab-btn {
    background: #f5f5f5;
    border: 1px solid #ddd;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    text-align: left;
    transition: background 0.15s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .fab-btn:hover {
    background: #e8e8e8;
  }
  .fab-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .fab-btn:disabled:hover {
    background: #f5f5f5;
  }
  .fab-btn-primary {
    background: #417690;
    color: white;
    border-color: #417690;
  }
  .fab-btn-primary:hover:not(:disabled) {
    background: #345a6d;
  }
  .fab-btn-danger {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
  }
  .fab-btn-danger:hover:not(:disabled) {
    background: #c82333;
  }
  .fab-icon {
    font-style: normal;
    font-size: 14px;
  }
</style>
{% endblock %}

{% block content %}
<div class="module">
  <h2>{{ title }}</h2>

  <div class="grid-toolbar">
    <a class="button" href="../change/">–ù–∞–∑–∞–¥</a>

    <label>–õ–∏—Å—Ç:&nbsp;
      <select id="sheet">
        {% for name in sheet_names %}
          <option value="{{ forloop.counter0 }}" {% if forloop.counter0 == sheet_index %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </label>

    <label style="display:flex;gap:6px;align-items:center">
      <input id="toggle-all" type="checkbox" {% if show_all %}checked{% endif %}>
      –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
    </label>

    <a class="button" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ö–µ–º—É</a>
    <a class="button" id="btn-extract">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã</a>

    <!-- –ì—Ä—É–ø–ø—ã -->
    <a class="button" id="btn-group-tree">–î–µ—Ä–µ–≤–æ –≥—Ä—É–ø–ø</a>

    <span style="margin-left:auto;display:flex;gap:12px;align-items:center;">
      <label style="display:flex;gap:6px;align-items:center">
        –Æ–Ω–∏—Ç—ã:&nbsp;
        <input id="unit-allow" type="text" value="{{ unit_allow_raw }}" style="width:180px"
               title="–°–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –µ–¥–∏–Ω–∏—Ü —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
      </label>
      <label style="display:flex;gap:6px;align-items:center">
        <input id="require-qty" type="checkbox" {% if require_qty %}checked{% endif %}>
        –¢—Ä–µ–±–æ–≤–∞—Ç—å –ö–û–õ-–í–û &gt; 0
      </label>
      
      <!-- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É" -->
      <a href="#" class="btn-create-estimate" id="btn-materialize" title="–°–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É –∏–∑ —Ä–∞–∑–º–µ—Ç–∫–∏">
        –°–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É
      </a>
    </span>
  </div>

  <div style="margin:-8px 0 10px 0;color:#666;">
    –ü–æ–∫–∞–∑–∞–Ω–æ —Å—Ç—Ä–æ–∫: <strong>{{ rows|length }}</strong> –∏–∑ <strong>{{ total_rows }}</strong>.
    &nbsp; –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: <strong id="tc-counter">0</strong>.
    &nbsp; –ù–µ—É—á—Ç—ë–Ω–Ω—ã—Ö UNIT: <strong id="unit-bad-counter">0</strong>
    <span id="unit-bad-list" style="margin-left:8px;"></span>
  </div>

  <div style="overflow:auto; max-height: calc(100vh - 260px); border:1px solid #e0e0e0;">
    <table class="grid" id="grid">
      <thead>
        <tr>
          <th class="control-col"></th>
          {% for col in cols %}
            <th data-col="{{ col }}">
              <div><input type="checkbox" class="col-check" data-col="{{ col }}" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è"></div>

              <select class="role-select" data-col="{{ col }}">
                {% for r in role_defs %}
                  <option value="{{ r.id }}"
                          data-color="{{ r.color }}"
                          data-required="{{ r.required|yesno:'1,0' }}"
                          {% if col_roles|index:col == r.id %}selected{% endif %}>
                    {{ r.title }}
                  </option>
                {% endfor %}
              </select>

              <div class="head-role">–ö–æ–ª–æ–Ω–∫–∞ {{ col|excel_col }}</div>
              {% if col_headers|index:col %}
                <div class="head-caption">{{ col_headers|index:col }}</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for r in rows %}
        <tr data-row="{{ r.row_index }}" class="row">
          <td class="control-cell">
            <div class="ctrl-wrap">
              <input type="checkbox" class="row-check cb" title="–í—ã–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É (Shift ‚Äî –¥–∏–∞–ø–∞–∑–æ–Ω)">
              <div class="hier"></div>
              <!-- —Å—é–¥–∞ –∂–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –±–µ–π–¥–∂–∏ –≥—Ä—É–ø–ø –¥–ª—è —Å—Ç—Ä–æ–∫–∏-—Å—Ç–∞—Ä—Ç–∞ -->
            </div>
          </td>
          {% for col in cols %}
            {% with val=r.cells|index:col %}
              <td data-col="{{ col }}">{{ val }}</td>
            {% endwith %}
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p style="margin-top:8px;color:#666;">
    –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏: <strong>–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –†–ê–ë–û–¢/–¢–ö</strong>, <strong>–ï–î. –ò–ó–ú.</strong>, <strong>–ö–û–õ-–í–û</strong>.<br>
    –î–ª—è –≥—Ä—É–ø–ø: –≤—ã–¥–µ–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ (–º–æ–∂–Ω–æ —Å Shift) ‚Üí ¬´–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö¬ª. –ë–µ–π–¥–∂ –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω ‚Äî —É–¥–∞–ª—è–µ—Ç –≥—Ä—É–ø–ø—É (—Å –µ—ë –ø–æ—Ç–æ–º–∫–∞–º–∏) –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
  </p>

  <!-- Floating Action Bar -->
  <div class="floating-action-bar" id="fab">
    <div class="fab-header">
      –î–µ–π—Å—Ç–≤–∏—è —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
      <div class="fab-counter" id="fab-counter">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
    </div>
    <div class="fab-actions">
      <button class="fab-btn fab-btn-danger" id="fab-hide-rows" disabled>
        <span class="fab-icon">üóëÔ∏è</span> –°–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫–∏
      </button>
      <button class="fab-btn fab-btn-primary" id="fab-create-group" disabled>
        <span class="fab-icon">üìÅ</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
      </button>
      <button class="fab-btn fab-btn-danger" id="fab-hide-cols" disabled>
        <span class="fab-icon">‚ùå</span> –°–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏
      </button>
      <button class="fab-btn" id="fab-show-all">
        <span class="fab-icon">üëÅÔ∏è</span> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë
      </button>
      <button class="fab-btn" id="fab-clear-selection">
        <span class="fab-icon">‚Ü©Ô∏è</span> –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // helpers
  function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():'';}
  const CSRF = getCookie('csrftoken');

  function navigateWith(params){
    const base = window.location.pathname;
    const p = new URLSearchParams(window.location.search);
    if (params.sheet != null) p.set('sheet', params.sheet);
    if (params.all != null)   p.set('all', params.all ? '1' : '0');
    const qs = p.toString();
    window.location.assign(qs ? (base + '?' + qs) : base);
  }

  // endpoints
  const SAVE_URL      = window.location.pathname.replace(/\/grid\/?$/, "/api/save-schema/");
  const EXTRACT_URL   = window.location.pathname.replace(/\/grid\/?$/, "/api/extract-from-grid/");
  const MATERIALIZE_URL = window.location.pathname.replace(/\/grid\/?$/, "/materialize/");
  const GROUPS_LIST   = window.location.pathname.replace(/\/grid\/?$/, "/api/groups/list/");
  const GROUPS_CREATE = window.location.pathname.replace(/\/grid\/?$/, "/api/groups/create/");
  const GROUPS_DELETE = window.location.pathname.replace(/\/grid\/?$/, "/api/groups/delete/");
  const AUTO_GROUPS_URL = window.location.pathname.replace(/\/grid\/?$/, "/api/auto-groups-from-colors/");

  // –§–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è —Ä–∞–∑–º–µ—Ç–∫–∏ (–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Django)
  const HAS_MARKUP = {{ has_markup|yesno:"true,false" }};

  // sheet + show_all controls
  document.getElementById('sheet')?.addEventListener('change', (e)=> navigateWith({sheet: e.target.value}));
  document.getElementById('toggle-all')?.addEventListener('change', (e)=> navigateWith({all: e.target.checked}));

  // roles helpers
  function collectRoles(){
    const roles = [];
    document.querySelectorAll('.role-select').forEach(sel=>{
      roles[parseInt(sel.dataset.col,10)] = sel.value;
    });
    return roles;
  }
  function getColsByRole(roleId){
    return Array.from(document.querySelectorAll('.role-select'))
      .filter(sel => sel.value === roleId)
      .map(sel => parseInt(sel.dataset.col, 10));
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø –ø–æ —Ü–≤–µ—Ç–∞–º
  async function autoCreateGroupsFromColors(nameColIndex, force = false) {
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    
    try {
      const resp = await fetch(AUTO_GROUPS_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
        body: JSON.stringify({
          sheet_index: parseInt(sheet, 10) || 0,
          name_of_work_col: nameColIndex,
          force: force
        })
      });
      
      const data = await resp.json();
      
      // –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      if (data.requires_confirmation) {
        const confirmed = confirm(
          data.message + '\n\n' +
          '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–Ω—ã –∑–∞–Ω–æ–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–≤–µ—Ç–æ–≤.'
        );
        
        if (confirmed) {
          // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ —Å force=true
          return await autoCreateGroupsFromColors(nameColIndex, true);
        } else {
          return { ok: false, cancelled: true };
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      if (data.ok) {
        let message = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –≥—Ä—É–ø–ø: ${data.groups_created}`;
        
        if (data.had_existing_groups) {
          message += '\n(–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –≥—Ä—É–ø–ø—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã)';
        }
        
        if (data.warnings && data.warnings.length > 0) {
          message += '\n\n–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:\n' + data.warnings.join('\n');
        }
        
        alert(message);
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã
        await repaintGroups();
        
        return data;
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        return data;
      }
      
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
      return { ok: false, error: error.message };
    }
  }

  // colorize headers by selected role color
  function applyHeaderColors(){
    document.querySelectorAll('.role-select').forEach(sel=>{
      const th = sel.closest('th');
      const opt = sel.selectedOptions[0];
      const color = opt?.dataset?.color || '#ffffff';
      if (th) th.style.background = color;
    });
  }

  // Units normalization
  function normalizeUnit(u) {
    if (!u) return "";
    let s = (u || "").toLowerCase().trim();
    s = s.replaceAll('\u00B2', '2').replaceAll('\u00B3', '3').replace(/\s+/g, ' ').trim();
    const compact = s.replace(/\s|\.|\,/g, '');
    if (/^(–º\^?2|–º2|–∫–≤–º|–º–∫–≤|–∫–≤–∞–¥—Ä–∞—Ç–Ω\w*–º–µ—Ç—Ä\w*)$/.test(compact)) return '–º2';
    if (/^(–º\^?3|–º3|–∫—É–±–º|–º–∫—É–±|–∫—É–±–∏—á–µ—Å–∫\w*–º–µ—Ç—Ä\w*)$/.test(compact)) return '–º3';
    if (/^(—à—Ç|—à—Ç—É–∫–∞|—à—Ç—É–∫–∏|—à—Ç—É–∫)$/.test(compact)) return '—à—Ç';
    if (/^(–ø–º|–ø–æ–≥–º|–ø–æ–≥–æ–Ω–Ω—ã–π–º–µ—Ç—Ä|–ø–æ–≥–æ–Ω–Ω—ã—Ö\s*–º–µ—Ç—Ä–æ–≤)$/.test(compact)) return '–ø–º';
    if (/^(–∫–æ–º–ø–ª|–∫–æ–º–ø–ª–µ–∫—Ç|–∫–æ–º–ø–ª–µ–∫—Ç–∞|–∫–æ–º–ø–ª–µ–∫—Ç–æ–≤)$/.test(compact)) return '–∫–æ–º–ø–ª';
    return compact;
  }
  function getAllowedUnitSet() {
    const raw = (document.getElementById('unit-allow')?.value || "").split(',');
    const set = new Set();
    for (const x of raw) {
      const norm = normalizeUnit(x);
      if (norm) set.add(norm);
    }
    return set;
  }
  function firstNonEmptyCellText(tr, cols) {
    for (const c of cols) {
      const td = tr.querySelector(`td[data-col="${c}"]`);
      if (!td) continue;
      const t = (td.textContent || '').trim();
      if (t) return t;
    }
    return "";
  }
  function anyNonEmpty(tr, cols) {
    return cols.some(c => {
      const td = tr.querySelector(`td[data-col="${c}"]`);
      return td && (td.textContent || '').trim() !== '';
    });
  }
  function qtyValue(tr, cols) {
    for (const c of cols) {
      const td = tr.querySelector(`td[data-col="${c}"]`);
      if (!td) continue;
      const raw = (td.textContent || '').replace(/\s/g, '').replace(',', '.');
      const num = parseFloat(raw);
      if (!isNaN(num)) return num;
    }
    return NaN;
  }

  // dynamic row hints: NAME_OF_WORK + UNIT (+ QTY)
  function applyRowHints(){
    const nameCols = getColsByRole('NAME_OF_WORK');
    const unitCols = getColsByRole('UNIT');
    const qtyCols  = getColsByRole('QTY');
    const requireQty = !!document.getElementById('require-qty')?.checked;
    const allowedUnits = getAllowedUnitSet();

    const rows = document.querySelectorAll('#grid tbody tr');
    let tcCount = 0;
    let unitBadCount = 0;
    const badUnitsSet = new Set();

    rows.forEach(tr => {
      tr.classList.remove('tc-row');
      tr.querySelectorAll('td.unit-bad').forEach(td => td.classList.remove('unit-bad'));

      // –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
      const hasName = anyNonEmpty(tr, nameCols);
      const unitRaw = firstNonEmptyCellText(tr, unitCols);
      const unitNorm = normalizeUnit(unitRaw);
      const hasUnit = !!unitNorm && (allowedUnits.size === 0 || allowedUnits.has(unitNorm));

      let okQty = true;
      if (requireQty) {
        const q = qtyValue(tr, qtyCols);
        okQty = !isNaN(q) && q > 0;
      }
      if (hasName && hasUnit && okQty) {
        tr.classList.add('tc-row');
        tcCount++;
      }

      // –Ω–µ—É—á—Ç—ë–Ω–Ω—ã–µ UNIT
      unitCols.forEach(c => {
        const td = tr.querySelector(`td[data-col="${c}"]`);
        if (!td) return;
        const raw = (td.textContent || '').trim();
        if (!raw) return;
        const norm = normalizeUnit(raw);
        if (!norm) return;
        if (allowedUnits.size > 0 && !allowedUnits.has(norm)) {
          td.classList.add('unit-bad');
          unitBadCount++;
          badUnitsSet.add(raw);
        }
      });
    });

    document.getElementById('tc-counter').textContent = String(tcCount);
    document.getElementById('unit-bad-counter').textContent = String(unitBadCount);
    const listEl = document.getElementById('unit-bad-list');
    const items = Array.from(badUnitsSet).slice(0, 20).map(x => `<code>${x}</code>`).join(', ');
    listEl.innerHTML = items ? `| –ü—Ä–∏–º–µ—Ä—ã: ${items}${badUnitsSet.size > 20 ? '‚Ä¶' : ''}` : '';
  }

  // guard: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã?
  function requiredRolesPresent(){
    const need = new Set(['NAME_OF_WORK','UNIT','QTY']);
    document.querySelectorAll('.role-select').forEach(sel => {
      need.delete(sel.value);
    });
    return need.size === 0;
  }

  // init: —Ü–≤–µ—Ç —à–∞–ø–æ–∫ + –ø–æ–¥—Å–∫–∞–∑–∫–∏
  function refreshUI(){
    applyHeaderColors();
    applyRowHints();
  }

  // –í–ê–ñ–ù–û: –°–æ–±—ã—Ç–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤/–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–∏ NAME_OF_WORK
  document.querySelectorAll('.role-select').forEach(sel => {
    sel.addEventListener('change', async (e) => {
      const newRole = e.target.value;
      const colIndex = parseInt(e.target.dataset.col, 10);
      
      // –ï—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å NAME_OF_WORK
      if (newRole === 'NAME_OF_WORK') {
        // –°–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const shouldAuto = confirm(
          '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ "–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –†–ê–ë–û–¢/–¢–ö".\n\n' +
          '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–≤–µ—Ç–æ–≤–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏?\n' +
          '(–¢—Ä–µ–±—É—é—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏ UNIT –∏ QTY –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)'
        );
        
        if (shouldAuto) {
          // –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ö–µ–º—É —Å —Ç–µ–∫—É—â–∏–º–∏ —Ä–æ–ª—è–º–∏
          const col_roles = collectRoles();
          const sheet = new URLSearchParams(location.search).get('sheet') || '0';
          
          const saveResp = await fetch(SAVE_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
            body: JSON.stringify({
              col_roles,
              sheet_index: parseInt(sheet,10)||0,
              unit_allow_raw: getUnitAllowRaw(),
              require_qty: getRequireQty(),
            })
          });
          
          const saveData = await saveResp.json();
          if (!saveData.ok) {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã: '+(saveData.error||'unknown'));
            return;
          }
          
          // –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø
          await autoCreateGroupsFromColors(colIndex);
        }
      }
      
      refreshUI();
    });
  });

  document.getElementById('unit-allow')?.addEventListener('input', applyRowHints);
  document.getElementById('require-qty')?.addEventListener('change', applyRowHints);

  function getUnitAllowRaw(){ return document.getElementById('unit-allow')?.value || ""; }
  function getRequireQty(){ return !!document.getElementById('require-qty')?.checked; }

  // save schema
  document.getElementById('btn-save').onclick = async ()=>{
    const col_roles = collectRoles();
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(SAVE_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
      body: JSON.stringify({
        col_roles,
        sheet_index: parseInt(sheet,10)||0,
        unit_allow_raw: getUnitAllowRaw(),
        require_qty: getRequireQty(),
      })
    });
    const data = await resp.json();
    if (!data.ok) alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+(data.error||'unknown')); else alert('–°—Ö–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
  };

  // extract
  document.getElementById('btn-extract').onclick = async ()=>{
    if (!requiredRolesPresent()){
      alert('–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏: ¬´–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –†–ê–ë–û–¢/–¢–ö¬ª, ¬´–ï–î. –ò–ó–ú.¬ª, ¬´–ö–û–õ-–í–û¬ª.');
      return;
    }
    const col_roles = collectRoles();
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(EXTRACT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
      body: JSON.stringify({
        col_roles,
        sheet_index: parseInt(sheet,10)||0,
        unit_allow_raw: getUnitAllowRaw(),
        require_qty: getRequireQty(),
      })
    });
    const data = await resp.json();
    if (!data.ok) alert('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è: '+(data.error||'unknown')); else alert('–†–∞–∑–º–µ—Ç–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞. –û—Ç–∫—Ä–æ–π ¬´–ì—Ä–∞—Ñ¬ª –∏–ª–∏ ¬´–†–∞–∑–º–µ—Ç–∏—Ç—å¬ª.');
  };

  // –°–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É
  document.getElementById('btn-materialize').onclick = (e) => {
    e.preventDefault();
    
    if (!HAS_MARKUP) {
      const proceed = confirm(
        '–†–∞–∑–º–µ—Ç–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞!\n\n' +
        '–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–º–µ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n' +
        '1. –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª–∏ –∫–æ–ª–æ–Ω–∫–∞–º (NAME_OF_WORK, UNIT, QTY)\n' +
        '2. –ù–∞–∂–∞—Ç—å "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"\n\n' +
        '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ—Ç—ã? (–ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—É—é —Å–º–µ—Ç—É)'
      );
      
      if (!proceed) {
        return;
      }
    }
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    window.location.href = MATERIALIZE_URL;
  };

  /* =========================
     FLOATING ACTION BAR
     ========================= */

  function updateFAB() {
    const selectedRows = document.querySelectorAll('.row-check:checked').length;
    const selectedCols = document.querySelectorAll('.col-check:checked').length;
    const hasSelection = selectedRows > 0 || selectedCols > 0;
    
    const fab = document.getElementById('fab');
    const counter = document.getElementById('fab-counter');
    const btnHideRows = document.getElementById('fab-hide-rows');
    const btnCreateGroup = document.getElementById('fab-create-group');
    const btnHideCols = document.getElementById('fab-hide-cols');
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å FAB
    if (hasSelection) {
      fab.classList.add('visible');
    } else {
      fab.classList.remove('visible');
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
    let counterText = [];
    if (selectedRows > 0) counterText.push(`${selectedRows} —Å—Ç—Ä–æ–∫`);
    if (selectedCols > 0) counterText.push(`${selectedCols} –∫–æ–ª–æ–Ω–æ–∫`);
    counter.textContent = counterText.length > 0 ? `–í—ã–¥–µ–ª–µ–Ω–æ: ${counterText.join(', ')}` : '–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ';
    
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏
    btnHideRows.disabled = selectedRows === 0;
    btnHideRows.innerHTML = selectedRows > 0 ? `<span class="fab-icon">üóëÔ∏è</span> –°–∫—Ä—ã—Ç—å ${selectedRows} —Å—Ç—Ä–æ–∫` : '<span class="fab-icon">üóëÔ∏è</span> –°–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫–∏';
    
    btnCreateGroup.disabled = selectedRows === 0;
    btnCreateGroup.innerHTML = selectedRows > 0 ? `<span class="fab-icon">üìÅ</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ ${selectedRows} —Å—Ç—Ä–æ–∫` : '<span class="fab-icon">üìÅ</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É';
    
    btnHideCols.disabled = selectedCols === 0;
    btnHideCols.innerHTML = selectedCols > 0 ? `<span class="fab-icon">‚ùå</span> –°–∫—Ä—ã—Ç—å ${selectedCols} –∫–æ–ª–æ–Ω–æ–∫` : '<span class="fab-icon">‚ùå</span> –°–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏';
  }

  // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫ —á–µ–∫–±–æ–∫—Å–∞–º
  document.querySelectorAll('.row-check, .col-check').forEach(cb => {
    cb.addEventListener('change', updateFAB);
  });

  // –ü—Ä–∏–≤—è–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π FAB
  document.getElementById('fab-hide-rows').onclick = () => {
    document.querySelectorAll('.row-check:checked').forEach(cb => {
      cb.closest('tr')?.classList.add('hidden-row');
      cb.checked = false;
    });
    updateFAB();
  };

  document.getElementById('fab-hide-cols').onclick = () => {
    document.querySelectorAll('.col-check:checked').forEach(cb => {
      const col = parseInt(cb.dataset.col, 10);
      document.querySelector(`#grid thead th[data-col="${col}"]`)?.classList.add('hidden-col');
      document.querySelectorAll(`#grid tbody td[data-col="${col}"]`).forEach(td => td.classList.add('hidden-col'));
      cb.checked = false;
    });
    updateFAB();
  };

  document.getElementById('fab-create-group').onclick = async () => {
    const ranges = selectedRanges();
    if (!ranges.length) { 
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–¥–µ–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ (—á–µ–∫–±–æ–∫—Å—ã, –º–æ–∂–Ω–æ —Å Shift).'); 
      return; 
    }
    
    const cfg = await promptCreateGroup(ranges);
    if (!cfg) return;
    
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(GROUPS_CREATE, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
      body: JSON.stringify({ 
        sheet_index: parseInt(sheet, 10) || 0, 
        name: cfg.name, 
        rows: ranges, 
        parent_uid: cfg.parent_uid, 
        color: cfg.color 
      })
    });
    
    const data = await resp.json();
    if (!data.ok) { 
      alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + (data.error || 'unknown')); 
      return; 
    }
    
    await repaintGroups();
    document.querySelectorAll('.row-check:checked').forEach(cb => cb.checked = false);
    updateFAB();
  };

  document.getElementById('fab-show-all').onclick = () => {
    document.querySelectorAll('.hidden-row').forEach(el => el.classList.remove('hidden-row'));
    document.querySelectorAll('.hidden-col').forEach(el => el.classList.remove('hidden-col'));
    document.querySelectorAll('.row-check, .col-check').forEach(cb => cb.checked = false);
    updateFAB();
    refreshUI();
  };

  document.getElementById('fab-clear-selection').onclick = () => {
    document.querySelectorAll('.row-check, .col-check').forEach(cb => cb.checked = false);
    updateFAB();
  };

  /* =========================
     –ì–†–£–ü–ü–´ / –ü–û–î-–ì–†–£–ü–ü–´
     ========================= */

  // Shift-range –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
  let lastRowClicked = null;
  document.querySelectorAll('.row-check').forEach(cb=>{
    cb.addEventListener('click', (e)=>{
      const tr = cb.closest('tr');
      const idx = parseInt(tr?.dataset.row, 10);
      if (e.shiftKey && lastRowClicked != null) {
        const [a,b] = [lastRowClicked, idx].sort((x,y)=>x-y);
        document.querySelectorAll('#grid tbody tr').forEach(r=>{
          const ri = parseInt(r.dataset.row, 10);
          if (ri>=a && ri<=b) r.querySelector('.row-check').checked = true;
        });
        updateFAB();
      }
      lastRowClicked = idx;
    });
  });

  // –°–æ–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ -> —Å–∫–ª–µ–∏—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
  function selectedRanges(){
    const rows = Array.from(document.querySelectorAll('.row-check'))
      .map(cb => cb.checked ? parseInt(cb.closest('tr').dataset.row, 10) : null)
      .filter(Boolean).sort((a,b)=>a-b);
    const out = [];
    let start = null, prev = null;
    for (const r of rows){
      if (start==null){ start = prev = r; continue; }
      if (r === prev+1){ prev = r; continue; }
      out.push([start, prev]); start = prev = r;
    }
    if (start!=null) out.push([start, prev]);
    return out;
  }

  async function fetchGroups(){
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(`${GROUPS_LIST}?sheet_index=${sheet}`);
    const data = await resp.json();
    return data.ok ? (data.groups || []) : [];
  }

  function rangesCoveredBy(parentRanges, childRanges){
    return childRanges.every(([s2,e2]) => parentRanges.some(([s1,e1]) => s1<=s2 && e2<=e1));
  }

  async function promptCreateGroup(ranges){
    const groups = await fetchGroups();
    const byId = Object.fromEntries(groups.map(g=>[g.uid,g]));
    function depthOf(uid){
      let d=0; let cur = byId[uid];
      while (cur && cur.parent_uid){ d++; cur = byId[cur.parent_uid]; }
      return d;
    }
    groups.forEach(g=> g._depth = depthOf(g.uid));

    const candidates = groups.filter(g => rangesCoveredBy(g.rows||[], ranges));
    const name = window.prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:','–ì—Ä—É–ø–ø–∞');
    if (!name) return null;
    let parent_uid = null;
    if (candidates.length){
      const s = ['(0) ‚Äî –±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è'].concat(candidates.map((g,i)=>`(${i+1}) ${'  '.repeat(g._depth)}${g.name}`)).join('\n');
      const pick = window.prompt(`–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è:\n${s}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:`, '0');
      const n = parseInt(pick||'0',10)||0;
      if (n>0) parent_uid = candidates[n-1].uid;
    }
    const palette = ['#F0F4C3','#D1C4E9','#B2EBF2','#FFECB3','#C8E6C9','#FFE0B2','#E1BEE7','#FFCDD2'];
    const color = palette[Math.floor(Math.random()*palette.length)];
    return {name, parent_uid, color};
  }

  // –ë—ã—Å—Ç—Ä–æ–µ –¥–µ—Ä–µ–≤–æ –≥—Ä—É–ø–ø (alert)
  document.getElementById('btn-group-tree').onclick = async ()=>{
    const groups = await fetchGroups();
    const children = {};
    groups.forEach(g=>{
      const p = g.parent_uid || '_root';
      (children[p] ||= []).push(g);
    });
    function walk(pid, depth, acc){
      (children[pid]||[]).forEach(g=>{
        acc.push(`${'  '.repeat(depth)}- ${g.name}  [${JSON.stringify(g.rows)}]`);
        walk(g.uid, depth+1, acc);
      });
    }
    const lines = []; walk('_root', 0, lines);
    alert(lines.join('\n') || '–ü–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø');
  };

  // –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
  async function deleteGroup(uid){
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const ok = confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É –∏ –≤—Å–µ –µ—ë –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥-–≥—Ä—É–ø–ø—ã?');
    if (!ok) return;
    const resp = await fetch(GROUPS_DELETE, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
      body: JSON.stringify({ sheet_index: parseInt(sheet,10)||0, uid })
    });
    const data = await resp.json();
    if (!data.ok){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+(data.error||'unknown')); return; }
    repaintGroups();
  }

  // –†–µ–Ω–¥–µ—Ä ¬´—Ä—ë–±–µ—Ä¬ª –∏ –±–µ–π–¥–∂–µ–π –ø—Ä—è–º–æ –≤ –∫–æ–ª–æ–Ω–∫–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  function renderHierarchyInControl(groups){
    const byId = Object.fromEntries(groups.map(g=>[g.uid,g]));
    function depthOf(uid){
      let d=0; let cur = byId[uid];
      while (cur && cur.parent_uid){ d++; cur = byId[cur.parent_uid]; }
      return d;
    }
    groups.forEach(g=> g._depth = depthOf(g.uid));

    const MAX_LEVELS = 4; // —Ä–∏—Å—É–µ–º –¥–æ 4 —É—Ä–æ–≤–Ω–µ–π –≤ —É–∑–∫–æ–π –∫–æ–ª–æ–Ω–∫–µ

    document.querySelectorAll('#grid tbody tr').forEach(tr=>{
      const rowNum = parseInt(tr.dataset.row,10);
      const ctrl = tr.querySelector('.ctrl-wrap');
      const hier = tr.querySelector('.hier');
      if (!ctrl || !hier) return;
      hier.innerHTML = '';

      // –≥—Ä—É–ø–ø—ã, –ø–æ–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É, –ø–æ –≥–ª—É–±–∏–Ω–µ
      const covering = groups
        .filter(g => (g.rows||[]).some(([s,e]) => rowNum>=s && rowNum<=e))
        .sort((a,b) => a._depth - b._depth);

      // —É—Ä–æ–≤–µ–Ω—å -> —Ü–≤–µ—Ç
      const levelColors = new Map();
      covering.forEach(g => {
        const lvl = Math.min(g._depth, MAX_LEVELS-1);
        if (!levelColors.has(lvl)) levelColors.set(lvl, g.color);
      });

      // –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
      levelColors.forEach((color, level) => {
        const l = document.createElement('div');
        l.className = 'lvl';
        l.style.left = (level*10 + 4) + 'px';     // —Ü–µ–Ω—Ç—Ä 3px –ø–æ–ª–æ—Å—ã –≤ 10px ¬´—Å–ª–æ—Ç–µ¬ª
        l.style.setProperty('--lvl-color', color);
        hier.appendChild(l);
      });

      // —Å—Ç–∞—Ä—Ç—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã
      const startsHere = groups
        .filter(g => (g.rows||[]).some(([s,e]) => rowNum === s))
        .sort((a,b)=>a._depth-b._depth);

      startsHere.forEach(g=>{
        const level = Math.min(g._depth, MAX_LEVELS-1);
        const elbow = document.createElement('div');
        elbow.className = 'elbow';
        elbow.style.left = (level*10 + 4) + 'px';
        elbow.style.top  = '2px';
        elbow.style.setProperty('--elbow-color', g.color);
        hier.appendChild(elbow);
      });

      // –±–µ–π–¥–∂–∏ (—Å –æ—Ç—Å—Ç—É–ø–æ–º)
      ctrl.querySelectorAll('.group-badge').forEach(b=> b.remove());
      startsHere.forEach(g=>{
        const level = Math.min(g._depth, MAX_LEVELS-1);
        const badge = document.createElement('span');
        badge.className = 'group-badge';
        badge.dataset.uid = g.uid;
        badge.style.background = g.color;
        badge.style.marginLeft = (level*10 + 14) + 'px';  // –æ—Ç—Å—Ç—É–ø –æ—Ç ¬´—Ä—ë–±–µ—Ä¬ª
        badge.title = '–ö–ª–∏–∫ ‚Äî —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É';
        badge.textContent = g.name;
        badge.addEventListener('click', ()=> deleteGroup(g.uid));
        ctrl.appendChild(badge);
      });
    });
  }

  // –ó–∞–ª–∏–≤–∫–∞ —Å—Ç—Ä–æ–∫ –≥—Ä—É–ø–ø (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  function fillGroupRows(groups){
    document.querySelectorAll('#grid tbody tr').forEach(tr=>{
      tr.style.backgroundImage = ''; tr.dataset.group = '';
    });
    groups.forEach(g=>{
      (g.rows||[]).forEach(([s,e])=>{
        for (let r=s; r<=e; r++){
          const tr = document.querySelector(`#grid tbody tr[data-row="${r}"]`);
          if (!tr) continue;
          const overlay = `${g.color}22`;
          tr.style.backgroundImage = `linear-gradient(0deg, ${overlay}, ${overlay})`;
          tr.dataset.group = (tr.dataset.group ? tr.dataset.group+' ' : '') + '1';
        }
      });
    });
  }

  // –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—â–∏–∫
  async function repaintGroups(){
    const groups = await fetchGroups();
    fillGroupRows(groups);
    renderHierarchyInControl(groups);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  refreshUI();
  repaintGroups();
  updateFAB(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º FAB
});
</script>
{% endblock %}