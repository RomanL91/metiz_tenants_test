{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
  .graph-toolbar { margin:0 0 12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #cy { width:100%; height: calc(100vh - 240px); border:1px solid #e0e0e0; border-radius:4px; background:#fafafa; }
  .legend { font-size:12px; color:#555; display:flex; gap:16px; align-items:center; }
  .chip { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; background:#fff; }
  .info { margin-top:8px; font-size:12px; color:#666; }
  .sidepanel { padding:8px 10px; border:1px solid #e0e0e0; border-radius:4px; background:#fff; }
  .muted { color:#888; }
</style>
{% endblock %}

{% block content %}
<div class="module">
  <h2>{{ title }}</h2>

  <div class="graph-toolbar">
    <a class="button" href="../change/">Назад</a>

    <label>Лист:&nbsp;
      <select id="sheet">
        {% for name in sheet_names %}
          <option value="{{ forloop.counter0 }}" {% if forloop.counter0 == sheet_index %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </label>

    <a class="button" id="btn-reload">Перестроить</a>

    <label>Макет:&nbsp;
      <select id="layout">
        <option value="dagre" selected>Иерархический (TB)</option>
        <option value="cose">Силовой (CoSE)</option>
      </select>
    </label>

    <label>Фильтр:&nbsp;<input type="text" id="filter" placeholder="поиск по метке" style="width:220px"></label>

    <span class="legend" style="margin-left:auto;">
      <span class="chip">Группа</span>
      <span class="chip">ТК</span>
    </span>
  </div>

  <div id="cy"></div>

  <div class="info">
    Клик по узлу — подсветка соседей; двойной клик — центрировать. Выделение по фильтру скрывает остальные узлы/рёбра.
  </div>
</div>
{% endblock %}

{% block footer %}
<!-- Cytoscape + dagre (CDN) -->
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function navigateWith(params){
    const base = window.location.pathname;
    const p = new URLSearchParams(window.location.search);
    if (params.sheet != null) p.set('sheet', params.sheet);
    const qs = p.toString();
    window.location.assign(qs ? (base + '?' + qs) : base);
  }
  const sheetSel = document.getElementById('sheet');
  sheetSel?.addEventListener('change', e => navigateWith({sheet: e.target.value}));

  const API_URL = window.location.pathname.replace(/\/graph\/?$/, "/api/graph-data/");

  let cy = cytoscape({
    container: document.getElementById('cy'),
    wheelSensitivity: 0.2,
    style: [
      {
        selector: 'node[type="root"]',
        style: {
          'shape': 'round-rectangle',
          'background-color': 'data(color)',
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'color': '#212121',
          'font-size': 12,
          'padding': '8px',
          'border-width': 1,
          'border-color': '#9e9e9e'
        }
      },
      {
        selector: 'node[type="group"]',
        style: {
          'shape': 'round-rectangle',
          'background-color': 'data(color)',
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'color': '#212121',
          'font-weight': 500,
          'font-size': 12,
          'padding': '6px',
          'border-width': 1,
          'border-color': '#90a4ae'
        }
      },
      {
        selector: 'node[type="tc"]',
        style: {
          'shape': 'ellipse',
          'background-color': 'data(color)',
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'color': '#1b5e20',
          'font-size': 11,
          'padding': '4px',
          'border-width': 1,
          'border-color': '#a5d6a7'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 2,
          'line-color': '#b0bec5',
          'target-arrow-color': '#b0bec5',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier'
        }
      },
      { selector: '.faded', style: { 'opacity': 0.12 } },
      { selector: '.highlight', style: { 'line-color': '#607d8b', 'target-arrow-color': '#607d8b', 'width': 3 } },
      { selector: 'node.selected', style: { 'border-color': '#37474f', 'border-width': 2 } }
    ]
  });

  function layoutOptions(name){
    const sheetDir = 'TB'; // можно сделать UI-переключатель TB/LR
    if (name === 'dagre') {
      return { name: 'dagre', rankDir: sheetDir, nodeSep: 25, rankSep: 60, edgeSep: 10, padding: 20, fit: true, animate: false };
    }
    if (name === 'cose') {
      return { name: 'cose', fit: true, animate: false, nodeOverlap: 10, nodeRepulsion: 800000, idealEdgeLength: 100 };
    }
    return { name: 'grid' };
  }

  async function loadGraph(){
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(`${API_URL}?sheet_index=${sheet}`);
    const data = await resp.json();
    if (!data.ok){ alert('Не удалось получить данные графа'); return; }

    cy.elements().remove();
    const elements = []
      .concat((data.nodes || []).map(n => ({ data: n.data })))
      .concat((data.edges || []).map(e => ({ data: e.data })));
    cy.add(elements);

    runLayout();
  }

  function runLayout(){
    const name = document.getElementById('layout').value;
    cy.layout(layoutOptions(name)).run();
  }

  // фильтр по подстроке
  function applyFilter(){
    const q = (document.getElementById('filter').value || '').trim().toLowerCase();
    cy.elements().removeClass('faded');
    if (!q) return;
    const matched = cy.nodes().filter(n => (n.data('label') || '').toLowerCase().includes(q));
    const neighborhood = matched.closedNeighborhood();
    cy.elements().not(neighborhood).addClass('faded');
  }

  // интерактив
  cy.on('tap', 'node', function(evt){
    const n = evt.target;
    cy.elements().removeClass('selected highlight');
    n.addClass('selected');
    n.connectedEdges().addClass('highlight');
    n.connectedEdges().connectedNodes().addClass('selected');
  });
  cy.on('tap', function(evt){
    if (evt.target === cy){
      cy.elements().removeClass('selected highlight');
    }
  });
  cy.on('dbltap', 'node', function(evt){
    const n = evt.target;
    cy.center(n);
    cy.zoom({level: 1.0, renderedPosition: n.renderedPosition()});
  });

  document.getElementById('btn-reload').addEventListener('click', loadGraph);
  document.getElementById('layout').addEventListener('change', runLayout);
  document.getElementById('filter').addEventListener('input', applyFilter);

  // первый запуск
  loadGraph();
});
</script>
{% endblock %}
