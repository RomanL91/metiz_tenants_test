{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /* 1) –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É —à–∞–ø–∫–∏ –∏ —É—Å–∏–ª–∏–≤–∞–µ–º –µ—ë –¥–ª—è –æ–±–µ–∏—Ö —Ç–µ–º */
    :root,
    html,
    html[data-theme="light"],
    html[data-theme="dark"] {
      --header-bg: #53565A;          /* —Ñ–æ–Ω —à–∞–ø–∫–∏ (–∫–∞–∫ –≤ base_site) */
      --header-color: #ffffff;
      --header-link-color: #E5E7EB;
      --header-link-hover-color: #ffffff;
    }
    #header { background: var(--header-bg) !important; color: var(--header-color) !important; }
    #branding a { color: var(--header-link-color) !important; }
    #branding a:hover { color: var(--header-link-hover-color) !important; }
    #user-tools, #user-tools a { color: var(--header-link-color) !important; }
    #user-tools a:hover { color: var(--header-link-hover-color) !important; }

    /* 2) –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ–º –ª–æ–≥–æ */
    #branding img.brand-logo { height: 48px !important; width: auto; }
  </style>

  <style>
    /* --- —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∏–∂–µ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π --- */
    .graph-container { display: flex; gap: 12px; height: calc(100vh - 200px); }
    .graph-main { flex: 1; display: flex; flex-direction: column; }
    .graph-toolbar { margin:0 0 12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; background:#f8f8f8; padding:10px; border-radius:4px; }
    .control-panel { display:flex; gap:6px; align-items:center; flex-wrap:wrap; padding:8px 0; }
    .control-group { display:flex; gap:4px; align-items:center; border-right:1px solid #ddd; padding-right:8px; margin-right:4px; }
    .control-group:last-child { border-right:none; }
    #cy { flex:1; border:1px solid #e0e0e0; border-radius:4px; background:#fafafa; }
    .sidepanel { width: 280px; border:1px solid #e0e0e0; border-radius:4px; background:#fff; padding:12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .sidepanel-hidden { display: none; }
    .panel-section { border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 12px; }
    .panel-section:last-child { border-bottom: none; margin-bottom: 0; }
    .panel-title { font-weight: 600; font-size: 13px; color: #333; margin-bottom: 8px; }
    .panel-item { font-size: 12px; color: #555; margin: 4px 0; }
    .panel-label { color: #888; display: inline-block; min-width: 70px; }
    .panel-value { color: #212121; font-weight: 500; }
    .breadcrumbs { font-size: 11px; color: #666; padding: 6px 8px; background: #f5f5f5; border-radius: 3px; word-break: break-word; }
    .legend { font-size:12px; color:#555; display:flex; gap:12px; align-items:center; }
    .chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px; border:1px solid #ddd; background:#fff; font-size:11px; }
    .chip-icon { font-style: normal; }
    .btn { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 3px; cursor: pointer; font-size: 12px; transition: all 0.15s; }
    .btn:hover { background: #f5f5f5; border-color: #999; }
    .btn:active { background: #e8e8e8; }
    .btn-icon { padding: 6px 8px; }
    .filter-group { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .filter-checkboxes { display: flex; gap: 12px; align-items: center; }
    .filter-checkbox { display: flex; align-items: center; gap: 4px; font-size: 12px; }
    .stats { background: #e3f2fd; padding: 8px 12px; border-radius: 4px; font-size: 12px; color: #1565c0; }
    .stats-item { margin: 2px 0; }
    .info { margin-top:8px; font-size:12px; color:#666; padding:8px; background:#f9f9f9; border-radius:4px; }
    input[type="range"] { width: 120px; height: 4px; -webkit-appearance: none; appearance: none; background: #ddd; outline: none; border-radius: 2px; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: #417690; cursor: pointer; border-radius: 50%; }
    input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; background: #417690; cursor: pointer; border-radius: 50%; border: none; }
    .slider-group { display: flex; flex-direction: column; gap: 4px; }
    .slider-label { font-size: 11px; color: #666; }
    .slider-value { font-size: 11px; color: #417690; font-weight: 500; }
  </style>
{% endblock %}

{% block content %}
<div class="module">
  <h2>{{ title }}</h2>

  <div class="graph-toolbar">
    <a class="button" href="../change/">–ù–∞–∑–∞–¥</a>

    <label>–õ–∏—Å—Ç:&nbsp;
      <select id="sheet">
        {% for name in sheet_names %}
          <option value="{{ forloop.counter0 }}" {% if forloop.counter0 == sheet_index %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </label>

    <button class="btn" id="btn-reload">üîÑ –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å</button>

    <label>–ú–∞–∫–µ—Ç:&nbsp;
      <select id="layout">
        <option value="dagre" selected>–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π (dagre)</option>
        <option value="cose">–°–∏–ª–æ–≤–æ–π (CoSE)</option>
      </select>
    </label>
    
    <label id="direction-group">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:&nbsp;
      <select id="direction">
        <option value="TB" selected>–°–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ (TB)</option>
        <option value="LR">–°–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ (LR)</option>
        <option value="BT">–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö (BT)</option>
        <option value="RL">–°–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ (RL)</option>
      </select>
    </label>

    <button class="btn" id="btn-toggle-panel">üìä –ü–∞–Ω–µ–ª—å</button>
  </div>

  <div class="control-panel">
    <div class="control-group">
      <button class="btn btn-icon" id="btn-zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">üîç+</button>
      <button class="btn btn-icon" id="btn-zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">üîç‚àí</button>
      <button class="btn btn-icon" id="btn-fit" title="–ü–æ —Ä–∞–∑–º–µ—Ä—É">‚õ∂</button>
      <button class="btn btn-icon" id="btn-reset" title="–°–±—Ä–æ—Å">üîÑ</button>
    </div>
    
    <div class="control-group filter-group">
      <div class="filter-checkboxes">
        <label class="filter-checkbox">
          <input type="checkbox" id="filter-groups" checked>
          <span>üìÅ –ì—Ä—É–ø–ø—ã</span>
        </label>
        <label class="filter-checkbox">
          <input type="checkbox" id="filter-tc" checked>
          <span>üìã –¢–ö</span>
        </label>
      </div>
      
      <label style="font-size:12px;">
        –ì–ª—É–±–∏–Ω–∞:
        <select id="depth-filter">
          <option value="all">–í—Å–µ</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </label>
      
      <input type="text" id="search-filter" placeholder="üîç –ü–æ–∏—Å–∫..." style="width:180px; padding:4px 8px; border:1px solid #ddd; border-radius:3px; font-size:12px;">
    </div>
    
    <div class="control-group" id="spacing-controls" style="display:none;">
      <div class="slider-group">
        <label class="slider-label">–£–∑–ª—ã: <span class="slider-value" id="node-sep-value">25</span></label>
        <input type="range" id="node-sep" min="10" max="100" value="25">
      </div>
      <div class="slider-group">
        <label class="slider-label">–†–∞–Ω–≥–∏: <span class="slider-value" id="rank-sep-value">60</span></label>
        <input type="range" id="rank-sep" min="30" max="150" value="60">
      </div>
    </div>
  </div>

  <div class="graph-container">
    <div class="graph-main">
      <div id="cy"></div>
    </div>

    <div class="sidepanel" id="sidepanel">
      <div class="panel-section">
        <div class="panel-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞—Ñ–∞</div>
        <div class="stats" id="stats">
          <div class="stats-item">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>

      <div class="panel-section" id="node-info" style="display:none;">
        <div class="panel-title">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–µ</div>
        <div class="panel-item">
          <span class="panel-label">–¢–∏–ø:</span>
          <span class="panel-value" id="node-type">‚Äî</span>
        </div>
        <div class="panel-item">
          <span class="panel-label">ID:</span>
          <span class="panel-value" id="node-id">‚Äî</span>
        </div>
        <div class="panel-item" style="margin-top:8px;">
          <span class="panel-label" style="display:block; margin-bottom:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
          <div class="panel-value" id="node-label" style="word-break:break-word;">‚Äî</div>
        </div>
        <div class="panel-item">
          <span class="panel-label">–î–µ—Ç–µ–π:</span>
          <span class="panel-value" id="node-children">‚Äî</span>
        </div>
        <div class="panel-item" style="margin-top:8px;">
          <span class="panel-label" style="display:block; margin-bottom:4px;">–ü—É—Ç—å:</span>
          <div class="breadcrumbs" id="node-breadcrumbs">‚Äî</div>
        </div>
      </div>

      <div class="panel-section">
        <button class="btn" style="width:100%;" id="btn-export">üì∏ –≠–∫—Å–ø–æ—Ä—Ç PNG</button>
      </div>
    </div>
  </div>

  <div class="info">
    üí° <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> –ö–ª–∏–∫ ‚Äî –≤—ã–±–æ—Ä —É–∑–ª–∞; –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ; –ö–æ–ª–µ—Å–æ –º—ã—à–∏ ‚Äî –º–∞—Å—à—Ç–∞–±; –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
  </div>
</div>
{% endblock %}

{% block footer %}
<!-- Cytoscape + dagre (CDN) -->
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  
  /* =========================
     PERSISTENCE
     ========================= */
  
  function getStorageKey(suffix) {
    const pk = window.location.pathname.match(/\/(\d+)\/graph/)?.[1];
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    return `graph_state_${pk}_${sheet}_${suffix}`;
  }
  
  function saveState(key, value) {
    try {
      localStorage.setItem(getStorageKey(key), JSON.stringify(value));
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', e);
    }
  }
  
  function loadState(key, defaultValue) {
    try {
      const stored = localStorage.getItem(getStorageKey(key));
      return stored ? JSON.parse(stored) : defaultValue;
    } catch (e) {
      return defaultValue;
    }
  }
  
  /* =========================
     NAVIGATION
     ========================= */
  
  function navigateWith(params){
    const base = window.location.pathname;
    const p = new URLSearchParams(window.location.search);
    if (params.sheet != null) p.set('sheet', params.sheet);
    const qs = p.toString();
    window.location.assign(qs ? (base + '?' + qs) : base);
  }
  
  const sheetSel = document.getElementById('sheet');
  sheetSel?.addEventListener('change', e => navigateWith({sheet: e.target.value}));

  const API_URL = window.location.pathname.replace(/\/graph\/?$/, "/api/graph-data/");

  /* =========================
     CYTOSCAPE SETUP
     ========================= */
  
  let cy = cytoscape({
    container: document.getElementById('cy'),
    wheelSensitivity: 0.2,
    style: [
      {
        selector: 'node[type="root"]',
        style: {
          'shape': 'round-rectangle',
          'background-color': 'data(color)',
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'color': '#212121',
          'font-size': 12,
          'padding': '8px',
          'border-width': 2,
          'border-color': '#5d4037'
        }
      },
      {
        selector: 'node[type="group"]',
        style: {
          'shape': 'round-rectangle',
          'background-color': 'data(color)',
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'color': '#212121',
          'font-weight': 500,
          'font-size': 12,
          'padding': '6px',
          'border-width': 1,
          'border-color': '#90a4ae'
        }
      },
      {
        selector: 'node[type="tc"]',
        style: {
          'shape': 'ellipse',
          'background-color': '#c8e6c9',
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'color': '#1b5e20',
          'font-size': 11,
          'padding': '4px',
          'border-width': 1,
          'border-color': '#81c784'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 2,
          'line-color': '#b0bec5',
          'target-arrow-color': '#b0bec5',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier'
        }
      },
      { selector: '.faded', style: { 'opacity': 0.15 } },
      { selector: '.hidden', style: { 'display': 'none' } },
      { selector: '.highlight', style: { 'line-color': '#607d8b', 'target-arrow-color': '#607d8b', 'width': 3 } },
      { selector: 'node.selected', style: { 'border-color': '#f57c00', 'border-width': 3, 'z-index': 999 } }
    ]
  });

  /* =========================
     LAYOUT
     ========================= */
  
  function layoutOptions(){
    const name = document.getElementById('layout').value;
    const direction = document.getElementById('direction').value;
    const nodeSep = parseInt(document.getElementById('node-sep').value, 10);
    const rankSep = parseInt(document.getElementById('rank-sep').value, 10);
    
    if (name === 'dagre') {
      return { 
        name: 'dagre', 
        rankDir: direction, 
        nodeSep: nodeSep, 
        rankSep: rankSep, 
        edgeSep: 10, 
        padding: 20, 
        fit: true, 
        animate: false 
      };
    }
    if (name === 'cose') {
      return { 
        name: 'cose', 
        fit: true, 
        animate: false, 
        nodeOverlap: 10, 
        nodeRepulsion: 800000, 
        idealEdgeLength: 100 
      };
    }
    return { name: 'grid' };
  }

  function runLayout(){
    const name = document.getElementById('layout').value;
    cy.layout(layoutOptions()).run();
    saveState('layout', name);
    saveState('direction', document.getElementById('direction').value);
    saveState('nodeSep', document.getElementById('node-sep').value);
    saveState('rankSep', document.getElementById('rank-sep').value);
  }

  /* =========================
     DATA LOADING
     ========================= */
  
  let graphData = { nodes: [], edges: [] };
  
  async function loadGraph(){
    const sheet = new URLSearchParams(location.search).get('sheet') || '0';
    const resp = await fetch(`${API_URL}?sheet_index=${sheet}`);
    const data = await resp.json();
    
    if (!data.ok){ 
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∞'); 
      console.error('Graph API error:', data);
      return;
    }

    graphData = data;
    
    cy.elements().remove();
    const elements = []
      .concat((data.nodes || []).map(n => ({ data: n.data })))
      .concat((data.edges || []).map(e => ({ data: e.data })));
    cy.add(elements);

    updateStats();
    applyFilters();
    runLayout();
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º zoom/pan
    const savedZoom = loadState('zoom', null);
    const savedPan = loadState('pan', null);
    if (savedZoom) cy.zoom(savedZoom);
    if (savedPan) cy.pan(savedPan);
  }

  /* =========================
     STATS
     ========================= */
  
  function updateStats() {
    const nodes = cy.nodes();
    const groups = nodes.filter('[type="group"]').length;
    const tcs = nodes.filter('[type="tc"]').length;
    const roots = nodes.filter('[type="root"]').length;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥–ª—É–±–∏–Ω—É
    let maxDepth = 0;
    nodes.forEach(n => {
      let depth = 0;
      let current = n;
      while (current.incomers('node').length > 0) {
        depth++;
        current = current.incomers('node')[0];
      }
      maxDepth = Math.max(maxDepth, depth);
    });
    
    const leaves = nodes.filter(n => n.outdegree() === 0).length;
    
    document.getElementById('stats').innerHTML = `
      <div class="stats-item"><strong>–£–∑–ª–æ–≤:</strong> ${nodes.length} (üìÅ ${groups}, üìã ${tcs})</div>
      <div class="stats-item"><strong>–ì–ª—É–±–∏–Ω–∞:</strong> ${maxDepth} ${maxDepth === 1 ? '—É—Ä–æ–≤–µ–Ω—å' : '—É—Ä–æ–≤–Ω–µ–π'}</div>
      <div class="stats-item"><strong>–õ–∏—Å—Ç—å–µ–≤:</strong> ${leaves}</div>
      <div class="stats-item"><strong>–†—ë–±–µ—Ä:</strong> ${cy.edges().length}</div>
    `;
  }

  /* =========================
     FILTERS
     ========================= */
  
  function applyFilters() {
    const showGroups = document.getElementById('filter-groups').checked;
    const showTCs = document.getElementById('filter-tc').checked;
    const depthFilter = document.getElementById('depth-filter').value;
    const searchQuery = document.getElementById('search-filter').value.trim().toLowerCase();
    
    cy.elements().removeClass('faded hidden');
    
    // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
    if (!showGroups) {
      cy.nodes('[type="group"]').addClass('hidden');
    }
    if (!showTCs) {
      cy.nodes('[type="tc"]').addClass('hidden');
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –≥–ª—É–±–∏–Ω–µ
    if (depthFilter !== 'all') {
      const maxDepth = depthFilter === '5' ? 999 : parseInt(depthFilter, 10);
      cy.nodes().forEach(n => {
        let depth = 0;
        let current = n;
        while (current.incomers('node').length > 0) {
          depth++;
          current = current.incomers('node')[0];
        }
        if (depth > maxDepth) {
          n.addClass('hidden');
        }
      });
    }
    
    // –ü–æ–∏—Å–∫–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
    if (searchQuery) {
      const matched = cy.nodes().filter(n => {
        const label = (n.data('label') || '').toLowerCase();
        const id = (n.data('id') || '').toLowerCase();
        return label.includes(searchQuery) || id.includes(searchQuery);
      });
      
      if (matched.length > 0) {
        const neighborhood = matched.closedNeighborhood();
        cy.elements().not(neighborhood).addClass('faded');
      }
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Ä—ë–±—Ä–∞ –∫ —Å–∫—Ä—ã—Ç—ã–º —É–∑–ª–∞–º
    cy.edges().forEach(edge => {
      const source = edge.source();
      const target = edge.target();
      if (source.hasClass('hidden') || target.hasClass('hidden')) {
        edge.addClass('hidden');
      }
    });
  }

  /* =========================
     NODE SELECTION
     ========================= */
  
  function showNodeInfo(node) {
    const nodeInfo = document.getElementById('node-info');
    nodeInfo.style.display = 'block';
    
    const type = node.data('type');
    const typeLabels = { 'root': 'üè† –ö–æ—Ä–µ–Ω—å', 'group': 'üìÅ –ì—Ä—É–ø–ø–∞', 'tc': 'üìã –¢–ö' };
    
    document.getElementById('node-type').textContent = typeLabels[type] || type;
    document.getElementById('node-id').textContent = node.data('id') || '‚Äî';
    document.getElementById('node-label').textContent = node.data('label') || '‚Äî';
    
    const children = node.outdegree();
    document.getElementById('node-children').textContent = children;
    
    // –°—Ç—Ä–æ–∏–º breadcrumbs
    const path = [];
    let current = node;
    while (current) {
      path.unshift(current.data('label') || current.data('id'));
      const parents = current.incomers('node');
      current = parents.length > 0 ? parents[0] : null;
    }
    document.getElementById('node-breadcrumbs').textContent = path.join(' ‚Üí ');
  }
  
  function hideNodeInfo() {
    document.getElementById('node-info').style.display = 'none';
  }

  /* =========================
     INTERACTIVITY
     ========================= */
  
  cy.on('tap', 'node', function(evt){
    const n = evt.target;
    cy.elements().removeClass('selected highlight');
    n.addClass('selected');
    n.connectedEdges().addClass('highlight');
    n.connectedEdges().connectedNodes().addClass('selected');
    showNodeInfo(n);
  });
  
  cy.on('tap', function(evt){
    if (evt.target === cy){
      cy.elements().removeClass('selected highlight');
      hideNodeInfo();
    }
  });
  
  cy.on('dbltap', 'node', function(evt){
    const n = evt.target;
    cy.animate({
      center: { eles: n },
      zoom: 1.5,
      duration: 300
    });
  });
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ zoom/pan –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
  cy.on('zoom pan', function() {
    saveState('zoom', cy.zoom());
    saveState('pan', cy.pan());
  });

  /* =========================
     CONTROLS
     ========================= */
  
  document.getElementById('btn-reload').addEventListener('click', loadGraph);
  document.getElementById('layout').addEventListener('change', function() {
    const isdagre = this.value === 'dagre';
    document.getElementById('direction-group').style.display = isdagre ? 'inline' : 'none';
    document.getElementById('spacing-controls').style.display = isdagre ? 'flex' : 'none';
    runLayout();
  });
  document.getElementById('direction').addEventListener('change', runLayout);
  
  document.getElementById('btn-zoom-in').addEventListener('click', () => {
    cy.zoom(cy.zoom() * 1.2);
    cy.center();
  });
  
  document.getElementById('btn-zoom-out').addEventListener('click', () => {
    cy.zoom(cy.zoom() * 0.8);
    cy.center();
  });
  
  document.getElementById('btn-fit').addEventListener('click', () => {
    cy.fit(null, 30);
  });
  
  document.getElementById('btn-reset').addEventListener('click', () => {
    cy.elements().removeClass('selected highlight faded hidden');
    hideNodeInfo();
    cy.fit(null, 30);
  });
  
  document.getElementById('btn-toggle-panel').addEventListener('click', () => {
    const panel = document.getElementById('sidepanel');
    panel.classList.toggle('sidepanel-hidden');
  });
  
  document.getElementById('btn-export').addEventListener('click', () => {
    const png = cy.png({ full: true, scale: 2 });
    const link = document.createElement('a');
    link.href = png;
    link.download = `graph_${new Date().getTime()}.png`;
    link.click();
  });
  
  // –§–∏–ª—å—Ç—Ä—ã
  document.getElementById('filter-groups').addEventListener('change', applyFilters);
  document.getElementById('filter-tc').addEventListener('change', applyFilters);
  document.getElementById('depth-filter').addEventListener('change', applyFilters);
  
  let searchTimeout;
  document.getElementById('search-filter').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 300);
  });
  
  // –°–ª–∞–π–¥–µ—Ä—ã spacing
  document.getElementById('node-sep').addEventListener('input', (e) => {
    document.getElementById('node-sep-value').textContent = e.target.value;
  });
  document.getElementById('node-sep').addEventListener('change', runLayout);
  
  document.getElementById('rank-sep').addEventListener('input', (e) => {
    document.getElementById('rank-sep-value').textContent = e.target.value;
  });
  document.getElementById('rank-sep').addEventListener('change', runLayout);

  /* =========================
     INITIALIZATION
     ========================= */
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const savedLayout = loadState('layout', 'dagre');
  const savedDirection = loadState('direction', 'TB');
  const savedNodeSep = loadState('nodeSep', 25);
  const savedRankSep = loadState('rankSep', 60);
  
  document.getElementById('layout').value = savedLayout;
  document.getElementById('direction').value = savedDirection;
  document.getElementById('node-sep').value = savedNodeSep;
  document.getElementById('rank-sep').value = savedRankSep;
  document.getElementById('node-sep-value').textContent = savedNodeSep;
  document.getElementById('rank-sep-value').textContent = savedRankSep;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç layout
  const isInitialDagre = savedLayout === 'dagre';
  document.getElementById('direction-group').style.display = isInitialDagre ? 'inline' : 'none';
  document.getElementById('spacing-controls').style.display = isInitialDagre ? 'flex' : 'none';
  
  // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
  loadGraph();
});
</script>
{% endblock %}