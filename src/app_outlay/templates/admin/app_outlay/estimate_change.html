{# templates/admin/app_outlay/estimate_change.html #}
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .tc-map { width:100%; border-collapse:collapse; margin:16px 0; font-size:13px; }
    .tc-map th, .tc-map td { border:1px solid #e0e0e0; padding:6px 8px; vertical-align:top; }
    .tc-map thead th { background:#f8f8f8; position:sticky; top:0; }
    .tc-map .muted { color:#888; font-size:11px; }
    .tc-map .sys { font-weight:600; }
    .tc-map .cell-2lines > div + div { margin-top:2px; }
    .tc-map .qty-input { width:100px; }
    .tc-map .tc-input { width:260px; }
    .tc-map .col-slim { white-space:nowrap; }
    .tc-map .col-wide { min-width:220px; }
    .tc-map .sec-hdr td { background:#fafafa; padding-top:10px; }
    .badge { display:inline-block; padding:4px 10px; border-radius:10px; font-weight:600; }

    /* –û–±—ë—Ä—Ç–∫–∞ –ø–æ–ª—è –¢–ö + —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .tc-input-wrapper { position: relative; display: inline-block; width: 100%; }
    .tc-clear-btn {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      padding: 0;
      display: none;
      z-index: 5;
    }
    .tc-clear-btn:hover { background: #c82333; }

    /* –ö–Ω–æ–ø–∫–∞-—Å—Å—ã–ª–∫–∞ "–æ—Ç–∫—Ä—ã—Ç—å –¢–ö" (‚Üó) ‚Äî —Å–ª–µ–≤–∞ –æ—Ç –∫—Ä–µ—Å—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ */
    .tc-open-link{
      position:absolute;
      right: 28px; /* —Å–ª–µ–≤–∞ –æ—Ç –∫—Ä–µ—Å—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ */
      top:50%;
      transform:translateY(-50%);
      background:#17a2b8;
      color:#fff;
      text-decoration:none;
      border-radius:3px;
      height:20px;
      line-height:20px;
      padding:0 6px;
      font-size:12px;
      display:none;
      z-index:5;
    }
    .tc-open-link:hover{ background:#138496; }

    /* –ï–¥–∏–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ–±–µ–∏—Ö —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–æ */
    .metrics{display:flex;gap:16px;flex-wrap:wrap}
    .metric-card{
      background:#fff;border:1px solid #dee2e6;border-radius:6px;
      padding:10px 12px;min-width:220px;box-shadow:0 1px 2px rgba(0,0,0,.03)
    }
    .metric-title{font-weight:600;color:#495057;font-size:12px;margin-bottom:2px}
    .metric-value{font-weight:700;font-size:18px;color:#212529}
    .metric-stack{margin-top:6px}
    .metric-step{
      display:flex;justify-content:space-between;
      font-size:12px;margin:3px 0;color:#495057
    }
    .metric-step .label{color:#6c757d}
    .summary-note{font-size:10px;color:#6c757d;margin:6px 0}
    
  </style>
{% endblock %}
{% block submit_buttons_top %}{% endblock %}
{% block submit_buttons_bottom %}{% endblock %}
{% block content %}
  {{ block.super }}

  <h2 style="margin-top:24px">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¢–ö (—Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥)</h2>

  {% if not table_sections %}
    <p class="help">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–≤—å—é: –ª–∏–±–æ —Ñ–∞–π–ª –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –ª–∏–±–æ —Ä–∞–∑–º–µ—Ç–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –¢–ö.</p>
  {% else %}
    <!-- –ö–ù–û–ü–ö–ò -->
    <div style="margin-bottom: 16px;">
      <button type="button" id="btn-auto-match" class="button" style="background: #417690; color: white;">
        ü§ñ –ê–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ö
      </button>
      <button type="button" id="btn-save-mappings" class="button default" style="margin-left: 8px;">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã
      </button>
      <button type="button" id="btn-export-excel" class="button" style="margin-left: 8px; background: #28a745; color: white;">
        üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏
      </button>
      <span id="auto-match-status" style="margin-left: 12px; color: #666;"></span>
    </div>

    <!-- –ò–¢–û–ì–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (—Å —É—á–µ—Ç–æ–º –ù–†) -->
    <div id="summary-panel" style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;padding:12px 16px;margin-bottom:16px;font-size:13px">

      <!-- –°–µ–∫—Ü–∏—è 1: –¢–µ–∫—É—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã (–£–ñ–ï –≤–∫–ª—é—á–∞—é—Ç –ù–†) -->
      <div style="margin-bottom:16px">
        <div style="font-weight:600;color:#495057;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #dee2e6">
          üìã –¢–µ–∫—É—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã
        </div>
        <div id="summary-note-base" class="summary-note"></div>
        <div id="metrics-base" class="metrics"></div>
        
        {% if overhead_calculation and overhead_calculation.overhead_total > 0 %}
        <div class="summary-note" style="margin-top:8px;color:#856404;font-size:11px">
          ‚ÑπÔ∏è –¶–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ —É–∂–µ –≤–∫–ª—é—á–∞—é—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã ({{ overhead_calculation.overhead_total|floatformat:2 }} ‚ÇΩ), 
          —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¢–ö.
          {% if overhead_calculation.overhead_details %}
          –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ú–ê–¢ {{ overhead_calculation.overhead_details.0.materials_pct|default:0|floatformat:0 }}% / 
          –†–ê–ë {{ overhead_calculation.overhead_details.0.works_pct|default:0|floatformat:0 }}%
          {% endif %}
        </div>
        {% endif %}
      </div>

      <!-- –°–µ–∫—Ü–∏—è 2: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ù–† (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è) -->
      {% if overhead_calculation and overhead_calculation.overhead_total > 0 %}
      <div style="padding-top:16px;border-top:2px solid #dee2e6">
        <div style="font-weight:600;color:#856404;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #ffc107">
          üí∞ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
        </div>
        <div style="font-size:12px;color:#6c757d">
          <div style="margin-bottom:4px">
            <strong>–û–±—â–∞—è —Å—É–º–º–∞ –ù–†:</strong> {{ overhead_calculation.overhead_total|floatformat:2 }} ‚ÇΩ
          </div>
          {% for detail in overhead_calculation.overhead_details %}
          <div style="margin-left:12px;margin-bottom:2px">
            ‚Ä¢ {{ detail.name }}: {{ detail.total|floatformat:2 }} ‚ÇΩ 
            (–ú–ê–¢: {{ detail.materials_pct|floatformat:0 }}%, –†–ê–ë: {{ detail.works_pct|floatformat:0 }}%)
          </div>
          {% endfor %}
          <div style="margin-top:8px;font-size:11px;font-style:italic">
            –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –±–∞–∑–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π –¢–ö.
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø –¢–ö -->
    <table class="tc-map" id="tc-map">
      <thead>
        <tr>
          <th class="col-wide">{{ role_titles.NAME_OF_WORK }}</th>
          <th class="col-slim">{{ role_titles.UNIT }}</th>
          <th class="col-slim">{{ role_titles.QTY }}</th>
          <th class="col-wide">–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –¢–ö</th>
          {% for col in optional_cols %}
            <th>{{ col.title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for sec in table_sections %}
          <tr class="sec-hdr">
            <td colspan="{{ table_colspan }}">
              <span class="badge" style="background: {{ sec.color|default:'#eef' }}">{{ sec.path }}</span>
            </td>
          </tr>

          {% for it in sec.items %}
            <tr data-row="{{ it.row_index }}">
              <td>{{ it.name }}</td>
              <td>{{ it.unit }}</td>
              <td>
                <input type="number" step="0.0001" class="qty-input"
                       value="{{ it.qty|default_if_none:'' }}" placeholder="0">
              </td>
              <td>
                <input type="text" class="tc-input js-tc-autocomplete" placeholder="–ù–∞–π—Ç–∏ –¢–ö‚Ä¶"
                       data-id="" data-text="">
                <div class="muted">—Å—Ç—Ä–æ–∫–∞ Excel: {{ it.row_index }}</div>
              </td>

              {% for v in it.opt_values %}
                <td class="cell-2lines opt-cell">
                  <div class="sys">‚Äî</div>
                  <div class="muted">xls: {{ v|default:"‚Äî" }}</div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    (function(){
      const CALC_ORDER = JSON.parse('{{ calc_order_json|escapejs }}');
      const AUTOCOMPLETE_URL = "{% url 'admin:outlay_tc_autocomplete' %}";
      const CALC_URL = window.location.pathname.replace(/\/change\/?$/, '/api/calc/');
      const AUTO_MATCH_URL = window.location.pathname.replace(/\/change\/?$/, '/api/auto-match/');
      const SAVE_MAPPINGS_URL = window.location.pathname.replace(/\/change\/?$/, '/api/save-mappings/');
      const EXISTING_MAPPINGS = JSON.parse('{{ existing_mappings_json|escapejs }}' || '{}');

      // CSRF: –±–µ—Ä—ë–º —Ç–æ–∫–µ–Ω –∏–∑ hidden-–ø–æ–ª—è –∏–ª–∏ –∏–∑ cookie
      function getCsrfToken(){
        const input = document.querySelector('[name=csrfmiddlewaretoken]');
        if (input && input.value) return input.value;
        const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : '';
      }

      /* –®–∞–±–ª–æ–Ω URL –∏–∑–º–µ–Ω–µ–Ω–∏—è –¢–ö –≤ –∞–¥–º–∏–Ω–∫–µ */
      const TC_CHANGE_URL_TMPL = "{{ tc_change_url_zero|default:'' }}";
      function tcChangeUrl(id){
        if (!TC_CHANGE_URL_TMPL) return '#';
        return TC_CHANGE_URL_TMPL.replace(/0\/change\/?$/, String(id) + "/change/");
      }

      const btnAutoMatch = document.getElementById('btn-auto-match');
      const btnSaveMappings = document.getElementById('btn-save-mappings');
      const statusSpan = document.getElementById('auto-match-status');

      async function searchTC(q){
        const r = await fetch(AUTOCOMPLETE_URL + '?q=' + encodeURIComponent(q));
        const d = await r.json(); return d.results || [];
      }

      function attachAutocomplete(input){
        let box;
        input.addEventListener('input', async ()=>{
          const q = input.value.trim();
          if (box) box.remove();
          if (q.length < 2) return;
          const items = await searchTC(q);
          const rect = input.getBoundingClientRect();
          box = document.createElement('div');
          Object.assign(box.style, {
            position:'absolute', background:'#fff', border:'1px solid #ddd',
            zIndex:10, maxHeight:'220px', overflow:'auto',
            left:(rect.left+window.scrollX)+'px', top:(rect.bottom+window.scrollY)+'px',
            minWidth:rect.width+'px'
          });
          items.forEach(it=>{
            const a = document.createElement('div');
            a.textContent = it.text;
            a.style.cssText='padding:4px 8px; cursor:pointer;';
            a.addEventListener('mousedown', ()=>{
              input.value = it.text;
              input.dataset.id = it.id;
              input.dataset.text = it.text;
              box.remove(); box=null;

              // –ø–æ–∫–∞–∑–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¢–ö
              const linkEl = input.parentElement?.querySelector('.tc-open-link');
              if (linkEl) {
                const id = parseInt(it.id || '0', 10) || 0;
                if (id > 0) {
                  linkEl.href = tcChangeUrl(id);
                  linkEl.style.display = 'block';
                } else {
                  linkEl.removeAttribute('href');
                  linkEl.style.display = 'none';
                }
              }

              const clearBtn = input.parentElement?.querySelector('.tc-clear-btn');
              if (clearBtn) clearBtn.style.display = 'block';

              const tr = input.closest('tr');
              if (tr) triggerRowCalc(tr);
            });
            box.appendChild(a);
          });
          document.body.appendChild(box);
          const clickAway = (ev)=>{ if (box && !box.contains(ev.target) && ev.target!==input){ box.remove(); box=null; document.removeEventListener('mousedown', clickAway);} };
          setTimeout(()=> document.addEventListener('mousedown', clickAway), 0);
        });
      }

      document.querySelectorAll('.js-tc-autocomplete, .tc-lookup').forEach(attachAutocomplete);

      // –û–±—ë—Ä—Ç–∫–∞, –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏ —Å—Å—ã–ª–∫–∞ "‚Üó –æ—Ç–∫—Ä—ã—Ç—å –¢–ö"
      document.querySelectorAll('.js-tc-autocomplete').forEach(input => {
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º input –≤ wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'tc-input-wrapper';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        // –°—Å—ã–ª–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –¢–ö"
        const openLink = document.createElement('a');
        openLink.className = 'tc-open-link';
        openLink.textContent = '‚Üó';
        openLink.target = '_blank';
        openLink.rel = 'noopener noreferrer';
        wrapper.appendChild(openLink);

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        const clearBtn = document.createElement('button');
        clearBtn.innerHTML = '‚úï';
        clearBtn.type = 'button';
        clearBtn.className = 'tc-clear-btn';
        clearBtn.title = '–û—á–∏—Å—Ç–∏—Ç—å';
        wrapper.appendChild(clearBtn);

        // –•–µ–ª–ø–µ—Ä—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏
        const toggleClearBtn = () => {
          clearBtn.style.display = input.value.trim() ? 'block' : 'none';
        };
        const updateOpenLink = () => {
          const id = parseInt(input.dataset.id || '0', 10) || 0;
          if (id > 0) {
            openLink.href = tcChangeUrl(id);
            openLink.style.display = 'block';
          } else {
            openLink.removeAttribute('href');
            openLink.style.display = 'none';
          }
        };

        // –û—á–∏—Å—Ç–∫–∞
        clearBtn.addEventListener('click', () => {
          input.value = '';
          input.dataset.id = '';
          input.dataset.text = '';
          input.style.background = '';
          clearBtn.style.display = 'none';
          updateOpenLink();

          const tr = input.closest('tr');
          if (tr) tr.querySelectorAll('.opt-cell .sys').forEach(el => el.textContent = '‚Äî');
          setTimeout(updateSummary, 100);
        });

        // –†–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–∞–±–æ—Ä —Ç–µ–∫—Å—Ç–∞: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º id, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
        input.addEventListener('input', () => {
          const currentValue = input.value.trim();
          const datasetText = input.dataset.text || '';
          if (currentValue !== datasetText) {
            input.dataset.id = '';
            input.dataset.text = '';
            const tr = input.closest('tr');
            if (tr) tr.querySelectorAll('.opt-cell .sys').forEach(el => el.textContent = '‚Äî');
            setTimeout(updateSummary, 100);
          }
          toggleClearBtn();
          updateOpenLink();
        });

        // –ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞
        input.addEventListener('blur', () => {
          if (!input.value.trim()) {
            input.dataset.id = '';
            input.dataset.text = '';
            input.style.background = '';
            const tr = input.closest('tr');
            if (tr) tr.querySelectorAll('.opt-cell .sys').forEach(el => el.textContent = '‚Äî');
            setTimeout(updateSummary, 100);
          }
          updateOpenLink();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        toggleClearBtn();
        updateOpenLink();
      });

      async function triggerRowCalc(tr){
        if (!tr) return;
        const inpTC = tr.querySelector('.js-tc-autocomplete');
        const inpQty = tr.querySelector('.qty-input');
        const tcId = parseInt(inpTC?.dataset.id || '0', 10) || 0;
        const qty  = parseFloat((inpQty?.value || '').replace(',', '.')) || 0;

        tr.querySelectorAll('.opt-cell .sys').forEach(el=> el.textContent = '‚Äî');
        if (!tcId || !isFinite(qty) || qty === 0) return;

        try{
          const resp = await fetch(CALC_URL + '?tc=' + tcId + '&qty=' + encodeURIComponent(qty));
          const data = await resp.json();
          if (!data.ok) return;
          const calc = data.calc || {};
          const cells = tr.querySelectorAll('.opt-cell');

          CALC_ORDER.forEach((rid, idx)=>{
            const td = cells[idx];
            if (!td) return;
            const val = (calc[rid] != null)
              ? Number(calc[rid]).toLocaleString(undefined, {maximumFractionDigits: 4})
              : '‚Äî';
            td.querySelector('.sys').textContent = val;
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º summary –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç—Ä–æ–∫–∏
          setTimeout(updateSummary, 100);
        }catch(e){
          console.error('Calc error:', e);
        }
      }

      document.querySelectorAll('#tc-map .qty-input').forEach(inp=>{
        inp.addEventListener('change', ()=> triggerRowCalc(inp.closest('tr')));
        inp.addEventListener('blur',   ()=> triggerRowCalc(inp.closest('tr')));
      });

      // –ê–í–¢–û–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï
      if (btnAutoMatch) {
        btnAutoMatch.addEventListener('click', async () => {
          btnAutoMatch.disabled = true;
          statusSpan.textContent = '–ò—â—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è...';

          const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
          const items = [];

          rows.forEach(tr => {
            const rowIndex = tr.dataset.row;
            const nameCell = tr.querySelector('td:nth-child(1)');
            const unitCell = tr.querySelector('td:nth-child(2)');

            if (nameCell && unitCell) {
              items.push({
                row_index: parseInt(rowIndex),
                name: nameCell.textContent.trim(),
                unit: unitCell.textContent.trim()
              });
            }
          });

          try {
            const resp = await fetch(AUTO_MATCH_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
              },
              body: JSON.stringify({ items })
            });

            const data = await resp.json();

            if (!data.ok) {
              statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || 'unknown');
              btnAutoMatch.disabled = false;
              return;
            }

            let matched = 0;
            data.results.forEach(result => {
              const tr = document.querySelector(`tr[data-row="${result.row_index}"]`);
              if (!tr) return;

              const tcInput = tr.querySelector('.js-tc-autocomplete');
              const qtyInput = tr.querySelector('.qty-input');
              if (!tcInput) return;

              if (result.matched_tc_id && result.matched_tc_text) {
                tcInput.value = result.matched_tc_text;
                tcInput.dataset.id = result.matched_tc_id;
                tcInput.dataset.text = result.matched_tc_text;

                if (result.similarity >= 0.9) {
                  tcInput.style.background = '#d4edda';
                } else if (result.similarity >= 0.5) {
                  tcInput.style.background = '#fff3cd';
                } else {
                  tcInput.style.background = '#f8d7da';
                }

                // –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É
                const openLink = tcInput.parentElement?.querySelector('.tc-open-link');
                if (openLink) {
                  const id = parseInt(result.matched_tc_id || '0', 10) || 0;
                  if (id > 0) {
                    openLink.href = tcChangeUrl(id);
                    openLink.style.display = 'block';
                  } else {
                    openLink.removeAttribute('href');
                    openLink.style.display = 'none';
                  }
                }

                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
                const clearBtn = tcInput.parentElement?.querySelector('.tc-clear-btn');
                if (clearBtn) clearBtn.style.display = 'block';

                if (qtyInput && qtyInput.value && parseFloat(qtyInput.value) > 0) {
                  triggerRowCalc(tr);
                }

                matched++;
              }
            });

            statusSpan.textContent = `‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${matched} –∏–∑ ${items.length}`;
            setTimeout(updateSummary, 500);

          } catch (e) {
            statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
            console.error(e);
          } finally {
            btnAutoMatch.disabled = false;
          }
        });
      }

      // ---------- SUMMARY: —Ä–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤ ----------

      // –°–æ–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Å—É–º–º—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (–£–ñ–ï –≤–∫–ª—é—á–∞—é—Ç –ù–†)
      function computeBaseTotals(){
        const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
        const totals = {};
        CALC_ORDER.forEach(rid => totals[rid] = 0);

        let calculatedRows = 0;

        rows.forEach(tr => {
          const cells = tr.querySelectorAll('.opt-cell');
          let hasValues = false;
          CALC_ORDER.forEach((rid, idx) => {
            const cell = cells[idx]; if (!cell) return;
            const text = (cell.querySelector('.sys')?.textContent || '').trim();
            if (!text || text === '‚Äî') return;
            const val = parseFloat(text.replace(/\s/g,'').replace(',', '.'));
            if (!isNaN(val)){ totals[rid] += val; hasValues = true; }
          });
          if (hasValues) calculatedRows++;
        });

        return {
          rows: rows.length,
          calculatedRows,
          baseMat: Number(totals['PRICE_FOR_ALL_MATERIAL'] || 0),
          baseWorks: Number(totals['PRICE_FOR_ALL_WORK'] || 0),
          baseTotal: Number(totals['TOTAL_PRICE'] || 0),
        };
      }

      // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫ (–µ–¥–∏–Ω—ã–π –º–∞–∫–µ—Ç)
      function renderMetricCards(container, {titleMat, titleWorks, titleTotal, mainMat, mainWorks, mainTotal}){
        const fmt = n => n.toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2});
        const card = (title, main) => `
          <div class="metric-card">
            <div class="metric-title">${title}</div>
            <div class="metric-value">${fmt(main)}</div>
          </div>
        `;

        container.innerHTML = [
          card(titleMat,   mainMat),
          card(titleWorks, mainWorks),
          card(titleTotal, mainTotal),
        ].join('');
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ summary (–ù–† –£–ñ–ï —É—á—Ç–µ–Ω—ã –≤ —Ü–µ–Ω–∞—Ö —Ç–∞–±–ª–∏—Ü—ã!)
      function updateSummary(){
        const base = computeBaseTotals();

        // –¢–µ–∫—É—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ –±–µ–∑ ¬´—Å—Ç—É–ø–µ–Ω–µ–∫¬ª
        const noteBase = document.getElementById('summary-note-base');
        const boxBase  = document.getElementById('metrics-base');
        if (noteBase) noteBase.textContent = `–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${base.calculatedRows} –∏–∑ ${base.rows}`;
        if (boxBase){
          renderMetricCards(boxBase, {
            titleMat: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',  titleWorks: '–†–∞–±–æ—Ç—ã', titleTotal: '–ò—Ç–æ–≥–æ',
            mainMat: base.baseMat,  mainWorks:  base.baseWorks, mainTotal: base.baseTotal,
          });
        }
      }

      // –ü–†–ï–î–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –î–ê–ù–ù–´–•
      async function prefillExistingMappings() {
        const mappingEntries = Object.entries(EXISTING_MAPPINGS);

        if (mappingEntries.length === 0) {
          updateSummary();
          return;
        }

        const calcPromises = [];

        mappingEntries.forEach(([rowIndex, mapping]) => {
          const tr = document.querySelector(`tr[data-row="${rowIndex}"]`);
          if (!tr) return;

          const tcInput = tr.querySelector('.js-tc-autocomplete');
          const qtyInput = tr.querySelector('.qty-input');

          if (tcInput && mapping.tc_id && mapping.tc_name) {
            tcInput.value = mapping.tc_name;
            tcInput.dataset.id = mapping.tc_id;
            tcInput.dataset.text = mapping.tc_name;
            tcInput.style.background = '#e7f3ff';

            // –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É
            const openLink = tcInput.parentElement?.querySelector('.tc-open-link');
            if (openLink) {
              const id = parseInt(mapping.tc_id || '0', 10) || 0;
              if (id > 0) {
                openLink.href = tcChangeUrl(id);
                openLink.style.display = 'block';
              } else {
                openLink.removeAttribute('href');
                openLink.style.display = 'none';
              }
            }

            // –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
            const clearBtn = tcInput.parentElement?.querySelector('.tc-clear-btn');
            if (clearBtn) clearBtn.style.display = 'block';
          }

          if (qtyInput && mapping.quantity) {
            qtyInput.value = mapping.quantity;
          }

          if (mapping.tc_id && mapping.quantity > 0) {
            calcPromises.push(triggerRowCalc(tr));
          }
        });

        if (calcPromises.length > 0) {
          await Promise.all(calcPromises);
        }
        updateSummary();
      }

      prefillExistingMappings();

      // –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ê–°–ß–ï–¢–û–í (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Save and continue editing)
      if (btnSaveMappings) {
        btnSaveMappings.addEventListener('click', async () => {
          btnSaveMappings.disabled = true;
          statusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
          statusSpan.style.color = '#666';

          // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¢–ö
          const mappings = [];
          const deletions = [];
          let currentSection = '–ë–µ–∑ –≥—Ä—É–ø–ø—ã';

          document.querySelectorAll('#tc-map tbody tr').forEach(tr => {
            if (tr.classList.contains('sec-hdr')) {
              const badge = tr.querySelector('.badge');
              if (badge) currentSection = badge.textContent.trim();
              return;
            }

            const tcInput = tr.querySelector('.js-tc-autocomplete');
            const qtyInput = tr.querySelector('.qty-input');
            const rowIndex = parseInt(tr.dataset.row || '0', 10);

            if (!tcInput || !qtyInput || !rowIndex) return;

            const tcId = parseInt(tcInput.dataset.id || '0', 10) || 0;
            const quantity = parseFloat((qtyInput.value || '0').replace(',', '.')) || 0;

            const hadMapping = (EXISTING_MAPPINGS[String(rowIndex)] != null);

            if (tcId > 0 && quantity > 0) {
              mappings.push({
                section: currentSection,
                tc_id: tcId,
                quantity,
                row_index: rowIndex,
                tc_name: tcInput.value
              });
            } else if (hadMapping) {
              deletions.push(rowIndex);
            }
          });

          // 2. –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¢–ö —á–µ—Ä–µ–∑ AJAX
          if (mappings.length > 0 || deletions.length > 0) {
            try {
              const resp = await fetch(SAVE_MAPPINGS_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({ mappings, deletions })
              });

              const data = await resp.json();

              if (!data.ok) {
                statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π: ' + (data.error || 'unknown');
                statusSpan.style.color = '#721c24';
                btnSaveMappings.disabled = false;
                return;
              }

              const deletedMsg = data.deleted > 0 ? `, —É–¥–∞–ª–µ–Ω–æ: ${data.deleted}` : '';
              console.log(`–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${data.total} –ø–æ–∑–∏—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–æ: ${data.created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.updated}${deletedMsg})`);

            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π:', e);
              statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è)';
              statusSpan.style.color = '#721c24';
              btnSaveMappings.disabled = false;
              return;
            }
          }

          // 3. –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É Django Admin (–∫–∞–∫ Save and continue editing)
          statusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã...';
          
          const adminForm = document.querySelector('form#estimate_form');
          if (!adminForm) {
            // Fallback: –∏—â–µ–º –ª—é–±—É—é —Ñ–æ—Ä–º—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            const forms = document.querySelectorAll('form');
            const mainForm = Array.from(forms).find(f => f.querySelector('[name=csrfmiddlewaretoken]'));
            
            if (mainForm) {
              // –î–æ–±–∞–≤–ª—è–µ–º hidden input –¥–ª—è "_continue" (Save and continue editing)
              let continueInput = mainForm.querySelector('input[name="_continue"]');
              if (!continueInput) {
                continueInput = document.createElement('input');
                continueInput.type = 'hidden';
                continueInput.name = '_continue';
                continueInput.value = 'Save and continue editing';
                mainForm.appendChild(continueInput);
              }
              
              // Submit —Ñ–æ—Ä–º—ã
              mainForm.submit();
            } else {
              // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
              statusSpan.textContent = '‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
              statusSpan.style.color = '#155724';
              setTimeout(() => { window.location.reload(); }, 800);
            }
          } else {
            // –ù–∞—à–ª–∏ —Ñ–æ—Ä–º—É —Å ID - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë
            let continueInput = adminForm.querySelector('input[name="_continue"]');
            if (!continueInput) {
              continueInput = document.createElement('input');
              continueInput.type = 'hidden';
              continueInput.name = '_continue';
              continueInput.value = 'Save and continue editing';
              adminForm.appendChild(continueInput);
            }
            
            adminForm.submit();
          }
        });
      }
      // ========== –≠–ö–°–ü–û–†–¢ –í EXCEL ==========
      const btnExportExcel = document.getElementById('btn-export-excel');
      if (btnExportExcel) {
        btnExportExcel.addEventListener('click', () => {
          // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
          const exportUrl = window.location.pathname.replace(/\/change\/?$/, '/api/export-excel/');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          statusSpan.textContent = '‚è≥ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...';
          statusSpan.style.color = '#666';
          btnExportExcel.disabled = true;
          
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ URL —ç–∫—Å–ø–æ—Ä—Ç–∞ (—Ñ–∞–π–ª —Å–∫–∞—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          window.location.href = exportUrl;
          
          // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã —É–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
          setTimeout(() => {
            statusSpan.textContent = '';
            btnExportExcel.disabled = false;
          }, 2000);
        });
      }
    })();
  </script>
{% endblock %}