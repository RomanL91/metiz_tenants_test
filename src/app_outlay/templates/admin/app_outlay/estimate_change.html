{# path: src/app_outlay/templates/admin/app_outlay/estimate_change.html #}
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'app_outlay/css/estimate_change.css' %}">
{% endblock %}

{% block submit_buttons_top %}{% endblock %}
{% block submit_buttons_bottom %}{% endblock %}

{% block content %}
  {{ block.super }}

  <h2 style="margin-top:24px">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¢–ö (—Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥)</h2>

  <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–º–µ—Ç—ã -->
  <div id="estimate-settings-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–º–µ—Ç—ã</div>
        <button type="button" id="modal-close" class="modal-close">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="estimate-object-name">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
          <input type="text" id="estimate-object-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å '–°–µ–≤–µ—Ä–Ω—ã–π'">
          <div class="help-text">–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</div>
        </div>

        <div class="form-group">
          <label for="estimate-vat-rate">–ù–î–° (%)</label>
          <input type="number" id="estimate-vat-rate" min="0" max="100" step="0.01" placeholder="20">
          <div class="help-text">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–∞–≤–∫—É –Ω–∞–ª–æ–≥–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (–æ–±—ã—á–Ω–æ 0, 10 –∏–ª–∏ 20%)</div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" id="modal-cancel" class="action-btn default">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="modal-apply" class="action-btn primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  {% if not table_sections %}
    <p class="help">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–≤—å—é: –ª–∏–±–æ —Ñ–∞–π–ª –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –ª–∏–±–æ —Ä–∞–∑–º–µ—Ç–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –¢–ö.</p>
  {% else %}

    <!-- –ö–ù–û–ü–ö–ò -->
    <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
      <button type="button" id="btn-auto-match" class="action-btn primary">
        ü§ñ –ê–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ö
      </button>
      <button type="button" id="btn-save-mappings" class="action-btn default">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã
      </button>
      <button type="button" id="btn-export-excel" class="action-btn success">
        üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏
      </button>
      <a href="{% url 'admin:estimate_analysis' original.pk %}"
         class="action-btn info"
         target="_blank">üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</a>
      <div style="flex: 1;"></div>
      <button type="button" id="btn-estimate-settings" class="action-btn default">
        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–º–µ—Ç—ã
      </button>
      <span id="auto-match-status" style="margin-left: 4px; color: #666;"></span>
    </div>

    <!-- –ö–ê–°–¢–û–ú–ù–´–ô –ò–ù–õ–ê–ô–ù –ù–† (–º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Ç–∞–±–ª–æ) -->
    <div id="overhead-panel">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <div style="font-weight:600;color:#495057">üßæ –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
        <select id="oh-select" style="min-width:260px; height: 36px; padding: 0 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;"></select>
        <button type="button" id="oh-add" class="action-btn success" style="height: 36px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <div style="border-left: 2px solid #dee2e6; height: 28px; margin: 0 4px;"></div>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-overhead-active" checked>
          <span class="toggle-slider"></span>
          <span class="toggle-label" id="toggle-overhead-label">–ù–† –∞–∫—Ç–∏–≤–Ω—ã</span>
        </label>
        <span id="oh-meta" class="muted" style="margin-left:auto"></span>
      </div>

      <table id="oh-table" class="tc-map" style="margin:0">
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</th>
            <th class="col-slim">–°—É–º–º–∞ (—Å–Ω–∞–ø.)</th>
            <th class="col-slim">–°—É–º–º–∞ (—Ç–µ–∫.)</th>
            <th class="col-slim">% –ú–ê–¢</th>
            <th class="col-slim">% –†–ê–ë</th>
            <th class="col-slim">–ö–æ–ª-–≤–æ</th>
            <th class="col-slim">–ê–∫—Ç–∏–≤–µ–Ω</th>
            <th class="col-slim">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="oh-rows"></tbody>
      </table>
    </div>

    <!-- –ò–¢–û–ì–û–í–û–ï –¢–ê–ë–õ–û -->
    <div id="summary-panel" style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;padding:12px 16px;margin-bottom:16px;font-size:13px">
      <div style="margin-bottom:16px">
        <div style="font-weight:600;color:#495057;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #dee2e6">üìã –¢–µ–∫—É—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã</div>
        <div id="summary-note-base" class="summary-note"></div>
        <div id="metrics-base" class="metrics"></div>
      </div>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ –ò –°–û–†–¢–ò–†–û–í–ö–ò –î–õ–Ø –¢–ê–ë–õ–ò–ß–ù–û–ì–û –í–ò–î–ê -->
    <div id="tc-filters" class="filters">
      <div class="field">
        <label>–ü–æ–∏—Å–∫</label>
        <input id="flt-text" type="text" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –¢–ö">
      </div>
      <div class="field">
        <label>–ï–¥. –∏–∑–º.</label>
        <select id="flt-unit"><option value="">–í—Å–µ</option></select>
      </div>
      <div class="field">
        <label>–ö–æ–ª-–≤–æ (–º–∏–Ω/–º–∞–∫—Å)</label>
        <div style="display:flex;gap:6px">
          <input id="flt-qty-min" type="number" step="0.0001" placeholder="–æ—Ç" style="min-width:100px">
          <input id="flt-qty-max" type="number" step="0.0001" placeholder="–¥–æ" style="min-width:100px">
        </div>
      </div>
      <div class="field">
        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
        <div class="segmented-control">
          <input type="radio" id="flt-state-all" name="flt-state" value="all" checked>
          <label for="flt-state-all">–í—Å–µ</label>
          
          <input type="radio" id="flt-state-mapped" name="flt-state" value="mapped">
          <label for="flt-state-mapped">‚úì –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</label>
          
          <input type="radio" id="flt-state-unmapped" name="flt-state" value="unmapped">
          <label for="flt-state-unmapped">‚úó –ù–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</label>
        </div>
      </div>
      <div class="actions">
        <button type="button" id="flt-reset" class="action-btn default" style="height: 32px; font-size: 13px; padding: 0 12px;">–°–±—Ä–æ—Å</button>
        <div style="border-left: 2px solid #dee2e6; height: 24px; margin: 0 4px;"></div>
        <button type="button" id="btn-collapse-all" class="action-btn default" style="height: 32px; font-size: 13px; padding: 0 12px;">
          ‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
        </button>
        <button type="button" id="btn-expand-all" class="action-btn default" style="height: 32px; font-size: 13px; padding: 0 12px;">
          ‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë
        </button>
      </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø –¢–ö -->
    <table class="tc-map" id="tc-map">
      <thead>
        <tr>
          <th class="col-wide"><span class="sortable" data-key="name">{{ role_titles.NAME_OF_WORK }} <span class="arrow">‚¨á</span></span></th>
          <th class="col-slim"><span class="sortable" data-key="unit">{{ role_titles.UNIT }} <span class="arrow">‚¨á</span></span></th>
          <th class="col-slim"><span class="sortable" data-key="qty">{{ role_titles.QTY }} <span class="arrow">‚¨á</span></span></th>
          <th class="col-wide"><span class="sortable" data-key="tc">–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –¢–ö <span class="arrow">‚¨á</span></span></th>
          {% for col in optional_cols %}
            <th>{{ col.title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for sec in table_sections %}
          <tr class="sec-hdr" data-section-id="{{ forloop.counter }}">
            <td colspan="{{ table_colspan }}">
              <span class="collapse-icon">‚ñº</span>
              <span class="badge" style="background: {{ sec.color|default:'#eef' }}">{{ sec.path }}</span>
              <span class="sec-totals" style="margin-left:16px; font-weight:600; color:#856404;"></span>
            </td>
          </tr>
          {% for it in sec.items %}
            <tr data-row="{{ it.row_index }}" data-section-id="{{ forloop.parentloop.counter }}">
              <td>{{ it.name }}</td>
              <td>{{ it.unit }}</td>
              <td><input type="number" step="0.0001" class="qty-input" value="{{ it.qty|default_if_none:'' }}" placeholder="0"></td>
              <td>
                <input type="text" class="tc-input js-tc-autocomplete" placeholder="–ù–∞–π—Ç–∏ –¢–ö‚Ä¶" data-id="" data-text="">
                <div class="muted">—Å—Ç—Ä–æ–∫–∞ Excel: {{ it.row_index }}</div>
              </td>
              {% for v in it.opt_values %}
                <td class="cell-2lines opt-cell"><div class="sys">‚Äî</div><div class="muted">xls: {{ v|default:"‚Äî" }}</div></td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    // –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Django –≤ JavaScript
    window.ESTIMATE_CALC_ORDER = JSON.parse('{{ calc_order_json|escapejs }}');
    window.ESTIMATE_EXISTING_MAPPINGS = JSON.parse('{{ existing_mappings_json|escapejs }}' || '{}');
    window.ESTIMATE_ID = {{ original.pk|default:'null' }};
    window.TC_CHANGE_URL_ZERO = '{{ tc_change_url_zero|escapejs }}';
  </script>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
  <script src="{% static 'app_outlay/js/estimate_calc.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_sections.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_mappings_save.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_overheads.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_filters.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_export.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_main.js' %}"></script>

  <!-- –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <script src="{% static 'app_outlay/js/estimate_autocomplete.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_settings.js' %}"></script>
  <script>
    (function() {
      if (typeof EstimateSettings === 'undefined') {
        console.error('‚ùå EstimateSettings –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        return;
      }
      
      const estimateId = {{ original.pk|default:'null' }};
      
      if (!estimateId) {
        console.error('‚ùå ID —Å–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      
      try {
        EstimateSettings.init(estimateId);
        console.log('‚úÖ –ú–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–º–µ—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
      }
    })();
  </script>
{% endblock %}