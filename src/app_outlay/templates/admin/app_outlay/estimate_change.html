{# templates/admin/app_outlay/estimate_change.html #}
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'app_outlay/css/estimate_change.css' %}">
{% endblock %}

{% block submit_buttons_top %}{% endblock %}
{% block submit_buttons_bottom %}{% endblock %}

{% block content %}
  {{ block.super }}

  <h2 style="margin-top:24px">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¢–ö (—Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥)</h2>

  <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–º–µ—Ç—ã -->
  <div id="estimate-settings-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–º–µ—Ç—ã</div>
        <button type="button" id="modal-close" class="modal-close">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="estimate-object-name">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
          <input type="text" id="estimate-object-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å '–°–µ–≤–µ—Ä–Ω—ã–π'">
          <div class="help-text">–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</div>
        </div>

        <div class="form-group">
          <label for="estimate-vat-rate">–ù–î–° (%)</label>
          <input type="number" id="estimate-vat-rate" min="0" max="100" step="0.01" placeholder="20">
          <div class="help-text">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–∞–≤–∫—É –Ω–∞–ª–æ–≥–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (–æ–±—ã—á–Ω–æ 0, 10 –∏–ª–∏ 20%)</div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" id="modal-cancel" class="action-btn default">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="modal-apply" class="action-btn primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  {% if not table_sections %}
    <p class="help">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–≤—å—é: –ª–∏–±–æ —Ñ–∞–π–ª –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –ª–∏–±–æ —Ä–∞–∑–º–µ—Ç–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –¢–ö.</p>
  {% else %}

    <!-- –ö–ù–û–ü–ö–ò -->
    <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
      <button type="button" id="btn-auto-match" class="action-btn primary">
        ü§ñ –ê–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ö
      </button>
      <button type="button" id="btn-save-mappings" class="action-btn default">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã
      </button>
      <button type="button" id="btn-export-excel" class="action-btn success">
        üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏
      </button>
      <a href="{% url 'admin:estimate_analysis' original.pk %}"
         class="action-btn info"
         target="_blank">üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</a>
      <div style="flex: 1;"></div>
      <button type="button" id="btn-estimate-settings" class="action-btn default">
        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–º–µ—Ç—ã
      </button>
      <span id="auto-match-status" style="margin-left: 4px; color: #666;"></span>
    </div>

    <!-- –ö–ê–°–¢–û–ú–ù–´–ô –ò–ù–õ–ê–ô–ù –ù–† (–º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Ç–∞–±–ª–æ) -->
    <div id="overhead-panel">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <div style="font-weight:600;color:#495057">üßæ –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
        <select id="oh-select" style="min-width:260px; height: 36px; padding: 0 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;"></select>
        <button type="button" id="oh-add" class="action-btn success" style="height: 36px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <div style="border-left: 2px solid #dee2e6; height: 28px; margin: 0 4px;"></div>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-overhead-active" checked>
          <span class="toggle-slider"></span>
          <span class="toggle-label" id="toggle-overhead-label">–ù–† –∞–∫—Ç–∏–≤–Ω—ã</span>
        </label>
        <span id="oh-meta" class="muted" style="margin-left:auto"></span>
      </div>

      <table id="oh-table" class="tc-map" style="margin:0">
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</th>
            <th class="col-slim">–°—É–º–º–∞ (—Å–Ω–∞–ø.)</th>
            <th class="col-slim">–°—É–º–º–∞ (—Ç–µ–∫.)</th>
            <th class="col-slim">% –ú–ê–¢</th>
            <th class="col-slim">% –†–ê–ë</th>
            <th class="col-slim">–ö–æ–ª-–≤–æ</th>
            <th class="col-slim">–ê–∫—Ç–∏–≤–µ–Ω</th>
            <th class="col-slim">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="oh-rows"></tbody>
      </table>
    </div>

    <!-- –ò–¢–û–ì–û–í–û–ï –¢–ê–ë–õ–û -->
    <div id="summary-panel" style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;padding:12px 16px;margin-bottom:16px;font-size:13px">
      <div style="margin-bottom:16px">
        <div style="font-weight:600;color:#495057;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #dee2e6">üìã –¢–µ–∫—É—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã</div>
        <div id="summary-note-base" class="summary-note"></div>
        <div id="metrics-base" class="metrics"></div>
      </div>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ –ò –°–û–†–¢–ò–†–û–í–ö–ò –î–õ–Ø –¢–ê–ë–õ–ò–ß–ù–û–ì–û –í–ò–î–ê -->
    <div id="tc-filters" class="filters">
      <div class="field">
        <label>–ü–æ–∏—Å–∫</label>
        <input id="flt-text" type="text" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –¢–ö">
      </div>
      <div class="field">
        <label>–ï–¥. –∏–∑–º.</label>
        <select id="flt-unit"><option value="">–í—Å–µ</option></select>
      </div>
      <div class="field">
        <label>–ö–æ–ª-–≤–æ (–º–∏–Ω/–º–∞–∫—Å)</label>
        <div style="display:flex;gap:6px">
          <input id="flt-qty-min" type="number" step="0.0001" placeholder="–æ—Ç" style="min-width:100px">
          <input id="flt-qty-max" type="number" step="0.0001" placeholder="–¥–æ" style="min-width:100px">
        </div>
      </div>
      <div class="field">
        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
        <div class="segmented-control">
          <input type="radio" id="flt-state-all" name="flt-state" value="all" checked>
          <label for="flt-state-all">–í—Å–µ</label>
          
          <input type="radio" id="flt-state-mapped" name="flt-state" value="mapped">
          <label for="flt-state-mapped">‚úì –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</label>
          
          <input type="radio" id="flt-state-unmapped" name="flt-state" value="unmapped">
          <label for="flt-state-unmapped">‚úó –ù–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</label>
        </div>
      </div>
      <div class="actions">
        <button type="button" id="flt-reset" class="action-btn default" style="height: 32px; font-size: 13px; padding: 0 12px;">–°–±—Ä–æ—Å</button>
        <div style="border-left: 2px solid #dee2e6; height: 24px; margin: 0 4px;"></div>
        <button type="button" id="btn-collapse-all" class="action-btn default" style="height: 32px; font-size: 13px; padding: 0 12px;">
          ‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
        </button>
        <button type="button" id="btn-expand-all" class="action-btn default" style="height: 32px; font-size: 13px; padding: 0 12px;">
          ‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë
        </button>
      </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø –¢–ö -->
    <table class="tc-map" id="tc-map">
      <thead>
        <tr>
          <th class="col-wide"><span class="sortable" data-key="name">{{ role_titles.NAME_OF_WORK }} <span class="arrow">‚¨á</span></span></th>
          <th class="col-slim"><span class="sortable" data-key="unit">{{ role_titles.UNIT }} <span class="arrow">‚¨á</span></span></th>
          <th class="col-slim"><span class="sortable" data-key="qty">{{ role_titles.QTY }} <span class="arrow">‚¨á</span></span></th>
          <th class="col-wide"><span class="sortable" data-key="tc">–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –¢–ö <span class="arrow">‚¨á</span></span></th>
          {% for col in optional_cols %}
            <th>{{ col.title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for sec in table_sections %}
          <tr class="sec-hdr" data-section-id="{{ forloop.counter }}">
            <td colspan="{{ table_colspan }}">
              <span class="collapse-icon">‚ñº</span>
              <span class="badge" style="background: {{ sec.color|default:'#eef' }}">{{ sec.path }}</span>
              <span class="sec-totals" style="margin-left:16px; font-weight:600; color:#856404;"></span>
            </td>
          </tr>
          {% for it in sec.items %}
            <tr data-row="{{ it.row_index }}" data-section-id="{{ forloop.parentloop.counter }}">
              <td>{{ it.name }}</td>
              <td>{{ it.unit }}</td>
              <td><input type="number" step="0.0001" class="qty-input" value="{{ it.qty|default_if_none:'' }}" placeholder="0"></td>
              <td>
                <input type="text" class="tc-input js-tc-autocomplete" placeholder="–ù–∞–π—Ç–∏ –¢–ö‚Ä¶" data-id="" data-text="">
                <div class="muted">—Å—Ç—Ä–æ–∫–∞ Excel: {{ it.row_index }}</div>
              </td>
              {% for v in it.opt_values %}
                <td class="cell-2lines opt-cell"><div class="sys">‚Äî</div><div class="muted">xls: {{ v|default:"‚Äî" }}</div></td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    (function(){
      const CALC_ORDER = JSON.parse('{{ calc_order_json|escapejs }}');
      const CALC_URL = window.location.pathname.replace(/\/change\/?$/, '/api/calc/');
      const SAVE_MAPPINGS_URL = window.location.pathname.replace(/\/change\/?$/, '/api/save-mappings/');
      const EXISTING_MAPPINGS = JSON.parse('{{ existing_mappings_json|escapejs }}' || '{}');

      // –ù–† —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
      const OH_BASE_URL = window.location.pathname.replace(/\/change\/?$/, '/api/overheads/');
      const OH_LIST_URL = OH_BASE_URL;
      const OH_APPLY_URL = OH_BASE_URL + 'apply/';
      const OH_TOGGLE_URL = OH_BASE_URL + 'toggle/';
      const OH_DEL_URL = OH_BASE_URL + 'delete/';
      const OH_QTY_URL = OH_BASE_URL + 'quantity/';

      function getCsrfToken(){
        const input = document.querySelector('[name=csrfmiddlewaretoken]');
        if (input && input.value) return input.value;
        const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : '';
      }

      async function triggerRowCalc(tr){
        if (!tr) return;
        const inpTC = tr.querySelector('.js-tc-autocomplete');
        const inpQty = tr.querySelector('.qty-input');
        const tcId = parseInt(inpTC?.dataset.id || '0', 10) || 0;
        const qty  = parseFloat((inpQty?.value || '').replace(',', '.')) || 0;
        tr.querySelectorAll('.opt-cell .sys').forEach(el=> el.textContent = '‚Äî');
        if (!tcId || !isFinite(qty) || qty === 0) return;
        try{
          const resp = await fetch(CALC_URL + '?tc=' + tcId + '&qty=' + encodeURIComponent(qty));
          const data = await resp.json(); if (!data.ok) return;
          const calc = data.calc || {}; const cells = tr.querySelectorAll('.opt-cell');
          CALC_ORDER.forEach((rid, idx)=>{ const td = cells[idx]; if (!td) return; const val = (calc[rid] != null) ? Number(calc[rid]).toLocaleString(undefined,{maximumFractionDigits:4}) : '‚Äî'; td.querySelector('.sys').textContent = val; });
          setTimeout(updateSummary, 100);
        }catch(e){ console.error('Calc error:', e); }
      }window.triggerRowCalc = triggerRowCalc; // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –º–æ–¥—É–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞

      document.querySelectorAll('#tc-map .qty-input').forEach(inp=>{
        inp.addEventListener('change', ()=> triggerRowCalc(inp.closest('tr')));
        inp.addEventListener('blur',   ()=> triggerRowCalc(inp.closest('tr')));
      });

      // –ò—Ç–æ–≥–∏
      function computeBaseTotals(){
        const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)'); const totals = {}; CALC_ORDER.forEach(rid => totals[rid] = 0);
        let calculatedRows = 0;
        rows.forEach(tr => { const cells = tr.querySelectorAll('.opt-cell'); let hasValues = false; CALC_ORDER.forEach((rid, idx) => { const cell = cells[idx]; if (!cell) return; const text = (cell.querySelector('.sys')?.textContent || '').trim(); if (!text || text === '‚Äî') return; const val = parseFloat(text.replace(/\s/g,'').replace(',', '.')); if (!isNaN(val)){ totals[rid] += val; hasValues = true; } }); if (hasValues) calculatedRows++; });
        return { rows: rows.length, calculatedRows, baseMat: Number(totals['PRICE_FOR_ALL_MATERIAL'] || 0), baseWorks: Number(totals['PRICE_FOR_ALL_WORK'] || 0), baseTotal: Number(totals['TOTAL_PRICE'] || 0) };
      }
      function renderMetricCards(container, {titleMat, titleWorks, titleTotal, mainMat, mainWorks, mainTotal}){
        const fmt = n => n.toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2});
        const card = (title, main) => `<div class="metric-card"><div class="metric-title">${title}</div><div class="metric-value">${fmt(main)}</div></div>`;
        container.innerHTML = [ card(titleMat, mainMat), card(titleWorks, mainWorks), card(titleTotal, mainTotal) ].join('');
      }
      function updateSummary(){
        const base = computeBaseTotals();
        const noteBase = document.getElementById('summary-note-base'); const boxBase  = document.getElementById('metrics-base');
        if (noteBase) noteBase.textContent = `–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${base.calculatedRows} –∏–∑ ${base.rows}`;
        if (boxBase){ renderMetricCards(boxBase, { titleMat:'–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', titleWorks:'–†–∞–±–æ—Ç—ã', titleTotal:'–ò—Ç–æ–≥–æ', mainMat: base.baseMat, mainWorks: base.baseWorks, mainTotal: base.baseTotal }); }
      }window.updateSummary = updateSummary; // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –º–æ–¥—É–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞

      async function prefillExistingMappings(){
        const mappingEntries = Object.entries(EXISTING_MAPPINGS); if (mappingEntries.length === 0){ updateSummary(); return; }
        const calcPromises = [];
        mappingEntries.forEach(([rowIndex, mapping]) => { const tr = document.querySelector(`tr[data-row="${rowIndex}"]`); if (!tr) return; const tcInput = tr.querySelector('.js-tc-autocomplete'); const qtyInput = tr.querySelector('.qty-input'); if (tcInput && mapping.tc_id && mapping.tc_name){ tcInput.value = mapping.tc_name; tcInput.dataset.id = mapping.tc_id; tcInput.dataset.text = mapping.tc_name; tcInput.style.background = '#e7f3ff'; const openLink = tcInput.parentElement?.querySelector('.tc-open-link'); if (openLink){ const id = parseInt(mapping.tc_id||'0',10)||0; if (id>0){ openLink.href = tcChangeUrl(id); openLink.style.display='block'; } else { openLink.removeAttribute('href'); openLink.style.display='none'; } } const clearBtn = tcInput.parentElement?.querySelector('.tc-clear-btn'); if (clearBtn) clearBtn.style.display='block'; }
          if (qtyInput && mapping.quantity){ qtyInput.value = mapping.quantity; }
          if (mapping.tc_id && mapping.quantity > 0){ calcPromises.push(triggerRowCalc(tr)); }
        });
        if (calcPromises.length > 0) await Promise.all(calcPromises); updateSummary();
      }
      prefillExistingMappings();

      // ====== –ö–û–õ–õ–ê–ü–°–ò–†–û–í–ê–ù–ò–ï –ì–†–£–ü–ü –ò –ü–û–î–°–ß–ï–¢ –ò–¢–û–ì–û–í ======
      function initSectionCollapse() {
        document.querySelectorAll('.sec-hdr').forEach(hdr => {
          hdr.addEventListener('click', function() {
            const sectionId = this.dataset.sectionId;
            const isCollapsed = this.classList.toggle('collapsed');
            
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll(`tr[data-section-id="${sectionId}"]:not(.sec-hdr)`).forEach(row => {
              row.style.display = isCollapsed ? 'none' : '';
            });
          });
        });
      }

      function updateSectionTotals() {
        const sections = {};
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–∫—Ü–∏—è–º
        document.querySelectorAll('#tc-map tbody tr[data-row]').forEach(tr => {
          const sectionId = tr.dataset.sectionId;
          if (!sectionId) return;
          
          if (!sections[sectionId]) {
            sections[sectionId] = {};
            CALC_ORDER.forEach(rid => sections[sectionId][rid] = 0);
            sections[sectionId].count = 0;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∏–º–∞
          if (tr.style.display === 'none') return;
          
          const cells = tr.querySelectorAll('.opt-cell');
          let hasValues = false;
          
          CALC_ORDER.forEach((rid, idx) => {
            const cell = cells[idx];
            if (!cell) return;
            const text = (cell.querySelector('.sys')?.textContent || '').trim();
            if (!text || text === '‚Äî') return;
            const val = parseFloat(text.replace(/\s/g,'').replace(',', '.'));
            if (!isNaN(val)) {
              sections[sectionId][rid] += val;
              hasValues = true;
            }
          });
          
          if (hasValues) sections[sectionId].count++;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Å–µ–∫—Ü–∏–π
        Object.keys(sections).forEach(sectionId => {
          const data = sections[sectionId];
          const hdr = document.querySelector(`.sec-hdr[data-section-id="${sectionId}"]`);
          if (!hdr) return;
          
          const totalsSpan = hdr.querySelector('.sec-totals');
          if (!totalsSpan) return;
          
          if (data.count > 0) {
            const mat = Number(data['PRICE_FOR_ALL_MATERIAL'] || 0);
            const works = Number(data['PRICE_FOR_ALL_WORK'] || 0);
            const total = Number(data['TOTAL_PRICE'] || 0);
            
            const fmt = n => n.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
            totalsSpan.textContent = `(–ú–ê–¢: ${fmt(mat)} | –†–ê–ë: ${fmt(works)} | –ò—Ç–æ–≥–æ: ${fmt(total)})`;
          } else {
            totalsSpan.textContent = '';
          }
        });
      }

      // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º updateSummary –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ —Å–µ–∫—Ü–∏–π
      const originalUpdateSummary = updateSummary;
      updateSummary = function() {
        originalUpdateSummary();
        updateSectionTotals();
      };

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      initSectionCollapse();
      updateSectionTotals();

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤ (–∏ —Ñ–æ—Ä–º—ã –∞–¥–º–∏–Ω–∫–∏)
      if (btnSaveMappings) {
        btnSaveMappings.addEventListener('click', async () => {
          btnSaveMappings.disabled = true; statusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'; statusSpan.style.color = '#666';
          const mappings = []; const deletions = []; let currentSection = '–ë–µ–∑ –≥—Ä—É–ø–ø—ã';
          document.querySelectorAll('#tc-map tbody tr').forEach(tr => { if (tr.classList.contains('sec-hdr')){ const badge = tr.querySelector('.badge'); if (badge) currentSection = badge.textContent.trim(); return; } const tcInput = tr.querySelector('.js-tc-autocomplete'); const qtyInput = tr.querySelector('.qty-input'); const rowIndex = parseInt(tr.dataset.row || '0', 10); if (!tcInput || !qtyInput || !rowIndex) return; const tcId = parseInt(tcInput.dataset.id || '0', 10) || 0; const quantity = parseFloat((qtyInput.value || '0').replace(',', '.')) || 0; const hadMapping = (EXISTING_MAPPINGS[String(rowIndex)] != null); if (tcId > 0 && quantity > 0){ mappings.push({ section: currentSection, tc_id: tcId, quantity, row_index: rowIndex, tc_name: tcInput.value }); } else if (hadMapping){ deletions.push(rowIndex); } });
          if (mappings.length > 0 || deletions.length > 0) {
            try{ const resp = await fetch(SAVE_MAPPINGS_URL, { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRFToken': getCsrfToken() }, body: JSON.stringify({ mappings, deletions }) }); const data = await resp.json(); if (!data.ok){ statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π: ' + (data.error || 'unknown'); statusSpan.style.color = '#721c24'; btnSaveMappings.disabled = false; return; } } catch (e){ console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π:', e); statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è)'; statusSpan.style.color = '#721c24'; btnSaveMappings.disabled = false; return; }
          }
          statusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã...';
          const adminForm = document.querySelector('form#estimate_form') || Array.from(document.querySelectorAll('form')).find(f => f.querySelector('[name=csrfmiddlewaretoken]'));
          if (adminForm){ let cont = adminForm.querySelector('input[name="_continue"]'); if (!cont){ cont = document.createElement('input'); cont.type='hidden'; cont.name = '_continue'; cont.value = 'Save and continue editing'; adminForm.appendChild(cont); } adminForm.submit(); } else { statusSpan.textContent = '‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'; statusSpan.style.color = '#155724'; setTimeout(()=>{ window.location.reload(); }, 800); }
        });
      }

      // –≠–∫—Å–ø–æ—Ä—Ç Excel
      const btnExportExcel = document.getElementById('btn-export-excel');
      if (btnExportExcel){ btnExportExcel.addEventListener('click', ()=>{ const exportUrl = window.location.pathname.replace(/\/change\/?$/, '/api/export-excel/'); statusSpan.textContent = '‚è≥ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...'; statusSpan.style.color = '#666'; btnExportExcel.disabled = true; window.location.href = exportUrl; setTimeout(()=>{ statusSpan.textContent=''; btnExportExcel.disabled = false; }, 2000); }); }

      // ======= –ù–†: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ =======
      const ohSelect = document.getElementById('oh-select');
      const ohAddBtn = document.getElementById('oh-add');
      const ohRows   = document.getElementById('oh-rows');
      const ohMeta   = document.getElementById('oh-meta');

      async function postJSON(url, payload){
        try{
          const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCsrfToken() }, body: JSON.stringify(payload || {}) });
          const ct = res.headers.get('content-type')||'';
          if (ct.includes('application/json')) return await res.json();
          const txt = await res.text(); console.warn('postJSON: non-JSON response', res.status, txt.slice(0,300));
          return { ok:false, status: res.status, error: 'non_json', html: txt };
        }catch(e){ console.warn('postJSON error', e); return { ok:false, error: String(e) }; }
      }

      function renderOH(data){
        if (ohSelect){ ohSelect.innerHTML = ''; const list = Array.isArray(data?.containers) ? data.containers : []; if (list.length){ list.forEach(c=>{ const opt = document.createElement('option'); opt.value = String(c.id); opt.textContent = `${c.name} ¬∑ ${c.total.toLocaleString()} ‚Äî –ú–ê–¢ ${c.materials_pct}% / –†–ê–ë ${c.works_pct}%`; ohSelect.appendChild(opt); }); ohAddBtn?.removeAttribute('disabled'); } else { const opt = document.createElement('option'); opt.disabled = true; opt.selected = true; opt.textContent = '‚Äî –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ‚Äî'; ohSelect.appendChild(opt); ohAddBtn?.setAttribute('disabled','disabled'); } }
        if (ohMeta){ const t = Number(data?.overhead_total || 0); const mp = Number(data?.avg_materials_pct || 0).toFixed(1); const wp = Number(data?.avg_works_pct || 0).toFixed(1); const hasList = Array.isArray(data?.containers) && data.containers.length>0; ohMeta.textContent = hasList ? `–í—Å–µ–≥–æ –ù–†: ${t.toLocaleString()} ¬∑ —Å—Ä–µ–¥–Ω. —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ú–ê–¢ ${mp}% / –†–ê–ë ${wp}%` : '–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ù–† –∏ –≤–∫–ª—é—á–∏—Ç–µ –µ–≥–æ (‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞ ‚Üí –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ù–†).'; }
        if (ohRows){ ohRows.innerHTML = ''; (data?.links || []).forEach((l, idx)=>{ const tr = document.createElement('tr'); tr.dataset.id = String(l.id); tr.innerHTML = `
              <td class="col-slim">${idx+1}</td>
              <td class="col-wide">${l.name}${l.has_changes ? ' <span class="muted">(–∏–∑–º–µ–Ω—ë–Ω)</span>' : ''}</td>
              <td class="col-slim">${(l.snapshot_total||0).toLocaleString()}</td>
              <td class="col-slim">${(l.current_total||0).toLocaleString()}</td>
              <td class="col-slim">${(l.materials_pct||0).toFixed(1)}%</td>
              <td class="col-slim">${(l.works_pct||0).toFixed(1)}%</td>
              <td class="col-slim">
                <div class="oh-qty">
                  <button type="button" class="button oh-qty-dec" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                  <input type="number" class="oh-qty-input" min="1" step="1" value="${l.quantity||1}" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                  <button type="button" class="button oh-qty-inc" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                </div>
              </td>
              <td class="col-slim">
                <label style="display:inline-flex;gap:6px;align-items:center">
                  <input type="checkbox" class="oh-toggle" ${l.is_active ? 'checked' : ''}>
                  <span class="muted">${l.is_active ? '–≤ —Ä–∞—Å—á—ë—Ç–µ' : '–∏–≥–Ω–æ—Ä'}</span>
                </label>
              </td>
              <td class="col-slim">
                <button type="button" class="button oh-del" title="–£–¥–∞–ª–∏—Ç—å" style="background:#dc3545;color:#fff">‚úï</button>
              </td>`; ohRows.appendChild(tr); }); bindOHEvents(); }
      }

      async function loadOH(){
        try{
          const res = await fetch(OH_LIST_URL, {headers:{'Accept':'application/json'}});
          const ct = res.headers.get('content-type')||'';
          if (!res.ok){ console.warn('OH load status', res.status); if (ohMeta) ohMeta.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ù–† ('+res.status+').'; return; }
          if (!ct.includes('application/json')){ console.warn('OH: not JSON'); if (ohMeta) ohMeta.textContent = '–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ JSON.'; return; }
          const data = await res.json(); if (data?.ok === false){ console.warn('OH: ok=false', data); }
          renderOH(data);
        }catch(e){ console.warn('OH load error', e); if (ohMeta) ohMeta.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ù–†.'; }
      }

      function bindOHEvents(){
        // toggle
        ohRows.querySelectorAll('.oh-toggle').forEach(input=>{
          input.addEventListener('change', async ()=>{
            const tr = input.closest('tr'); if(!tr) return; const id = parseInt(tr.dataset.id||'0',10)||0;
            const res = await postJSON(OH_TOGGLE_URL, {link_id:id, is_active: input.checked}); if (res.ok){ renderOH(res); recalcAllRowsAndSummary(); }
          });
        });
        // qty: input change/blur
        ohRows.querySelectorAll('.oh-qty-input').forEach(inp=>{
          const apply = async ()=>{ const tr = inp.closest('tr'); if(!tr) return; const id = parseInt(tr.dataset.id||'0',10)||0; let q = parseInt(inp.value || '1', 10) || 1; if (q<1) q=1; if (q>1000) q=1000; const res = await postJSON(OH_QTY_URL, {link_id:id, quantity:q}); if (res.ok){ renderOH(res); recalcAllRowsAndSummary(); } };
          inp.addEventListener('change', apply); inp.addEventListener('blur', apply);
        });
        // qty: +/- buttons
        ohRows.querySelectorAll('.oh-qty-inc, .oh-qty-dec').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const tr = btn.closest('tr'); if(!tr) return; const id = parseInt(tr.dataset.id||'0',10)||0; const field = tr.querySelector('.oh-qty-input'); let q = parseInt(field.value || '1', 10) || 1; q += btn.classList.contains('oh-qty-inc') ? 1 : -1; if (q<1) q=1; if (q>1000) q=1000; field.value = String(q); const res = await postJSON(OH_QTY_URL, {link_id:id, quantity:q}); if (res.ok){ renderOH(res); recalcAllRowsAndSummary(); }
          });
        });
        // delete
        ohRows.querySelectorAll('.oh-del').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const tr = btn.closest('tr'); if(!tr) return; const id = parseInt(tr.dataset.id||'0',10)||0; const res = await postJSON(OH_DEL_URL, {link_id:id}); if (res.ok){ renderOH(res); recalcAllRowsAndSummary(); }
          });
        });
      }

      if (ohAddBtn){
        ohAddBtn.addEventListener('click', async ()=>{
          const id = parseInt(ohSelect.value||'0',10)||0; if (!id) return;
          const res = await postJSON(OH_APPLY_URL, {container_id:id});
          if (res && res.ok){ renderOH(res); recalcAllRowsAndSummary(); }
          else { if (ohMeta){ ohMeta.textContent = '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ù–†' + (res?.status ? ' ('+res.status+')' : '') + (res?.error ? ': '+res.error : ''); } }
        });
      }

      // Toggle –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤—Å–µ—Ö –ù–†
      const toggleOverheadActive = document.getElementById('toggle-overhead-active');
      const toggleOverheadLabel = document.getElementById('toggle-overhead-label');
      
      if (toggleOverheadActive){
        toggleOverheadActive.addEventListener('change', async ()=>{
          const checkboxes = document.querySelectorAll('#oh-rows .oh-toggle');
          if (checkboxes.length === 0) return;
          
          const newState = toggleOverheadActive.checked;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ª–µ–π–±–ª–∞
          if (toggleOverheadLabel) {
            toggleOverheadLabel.textContent = newState ? '–ù–† –∞–∫—Ç–∏–≤–Ω—ã' : '–ù–† –≤—ã–∫–ª—é—á–µ–Ω—ã';
          }
          
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã
          const promises = [];
          checkboxes.forEach(cb => {
            const tr = cb.closest('tr');
            if (!tr) return;
            const id = parseInt(tr.dataset.id||'0',10)||0;
            if (!id) return;
            
            cb.checked = newState;
            promises.push(postJSON(OH_TOGGLE_URL, {link_id:id, is_active:newState}));
          });
          
          // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
          await Promise.all(promises);
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ù–† –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
          const res = await postJSON(OH_LIST_URL, {});
          if (res && res.ok){ renderOH(res); recalcAllRowsAndSummary(); }
        });
      }

      // –ö–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
      const btnCollapseAll = document.getElementById('btn-collapse-all');
      const btnExpandAll = document.getElementById('btn-expand-all');
      
      if (btnCollapseAll){
        btnCollapseAll.addEventListener('click', ()=>{
          document.querySelectorAll('.sec-hdr').forEach(hdr => {
            const sectionId = hdr.dataset.sectionId;
            if (!hdr.classList.contains('collapsed')) {
              hdr.classList.add('collapsed');
              document.querySelectorAll(`tr[data-section-id="${sectionId}"]:not(.sec-hdr)`).forEach(row => {
                row.style.display = 'none';
              });
            }
          });
        });
      }
      
      if (btnExpandAll){
        btnExpandAll.addEventListener('click', ()=>{
          document.querySelectorAll('.sec-hdr').forEach(hdr => {
            const sectionId = hdr.dataset.sectionId;
            if (hdr.classList.contains('collapsed')) {
              hdr.classList.remove('collapsed');
              document.querySelectorAll(`tr[data-section-id="${sectionId}"]:not(.sec-hdr)`).forEach(row => {
                row.style.display = '';
              });
            }
          });
        });
      }


      async function recalcAllRowsAndSummary(){
        const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)'); const promises = [];
        rows.forEach(tr=>{ const qtyInput = tr.querySelector('.qty-input'); const tcInput  = tr.querySelector('.js-tc-autocomplete'); const tcId = parseInt(tcInput?.dataset.id||'0',10)||0; const qty  = parseFloat((qtyInput?.value||'').replace(',', '.'))||0; if (tcId>0 && qty>0) promises.push(triggerRowCalc(tr)); });
        await Promise.all(promises); updateSummary();
      }

      // ====== –°–û–†–¢/–§–ò–õ–¨–¢–† –¢–ê–ë–õ–ò–¶–´ ======
      const flt = {
        text: document.getElementById('flt-text'),
        unit: document.getElementById('flt-unit'),
        qmin: document.getElementById('flt-qty-min'),
        qmax: document.getElementById('flt-qty-max'),
        stateAll: document.getElementById('flt-state-all'),
        stateMapped: document.getElementById('flt-state-mapped'),
        stateUnmapped: document.getElementById('flt-state-unmapped'),
        applyBtn: document.getElementById('flt-apply'),
        resetBtn: document.getElementById('flt-reset'),
      };

      const sortState = { key: null, dir: 'asc' }; // asc|desc|null

      function normalizeStr(s){ return (s||'').toString().toLowerCase().trim(); }
      function parseQty(v){ const n = parseFloat((v||'').toString().replace(',', '.')); return isNaN(n) ? null : n; }

      function getRowData(tr){
        const tds = tr.querySelectorAll('td');
        const name = (tds[0]?.textContent || '').trim();
        const unit = (tds[1]?.textContent || '').trim();
        const qtyInput = tr.querySelector('.qty-input');
        const qty = parseQty(qtyInput?.value);
        const tcInput = tr.querySelector('.js-tc-autocomplete');
        const tcText = (tcInput?.dataset.text || tcInput?.value || '').trim();
        const mapped = !!(tcInput && (tcInput.dataset.id || '').length > 0);
        return { name, unit, qty, tcText, mapped };
      }

      function buildUnitOptions(){
        const set = new Set();
        document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)').forEach(tr=>{
          const unit = (tr.querySelector('td:nth-child(2)')?.textContent||'').trim();
          if (unit) set.add(unit);
        });
        const cur = flt.unit.value;
        flt.unit.innerHTML = '<option value="">–í—Å–µ</option>' + Array.from(set).sort().map(u=>`<option value="${u}">${u}</option>`).join('');
        if (Array.from(set).includes(cur)) flt.unit.value = cur;
      }

      function rowPassesFilters(tr){
        const d = getRowData(tr);
        const text = normalizeStr(flt.text.value);
        if (text){ const hay = normalizeStr(d.name + ' ' + d.tcText); if (!hay.includes(text)) return false; }
        if (flt.unit.value && d.unit !== flt.unit.value) return false;
        const qmin = parseQty(flt.qmin.value), qmax = parseQty(flt.qmax.value);
        if (qmin != null && (d.qty == null || d.qty < qmin)) return false;
        if (qmax != null && (d.qty == null || d.qty > qmax)) return false;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏
        if (flt.stateMapped.checked && !d.mapped) return false;
        if (flt.stateUnmapped.checked && d.mapped) return false;
        
        return true;
      }

      function applyFilters(){
        const sections = [];
        let curSec = null;
        document.querySelectorAll('#tc-map tbody tr').forEach(tr=>{
          if (tr.classList.contains('sec-hdr')){
            curSec = { hdr: tr, rows: [] }; sections.push(curSec); return;
          }
          if (!curSec){ curSec = { hdr: null, rows: [] }; sections.push(curSec); }
          const pass = rowPassesFilters(tr);
          tr.style.display = pass ? '' : 'none';
          curSec.rows.push(tr);
        });
        // hide empty sections
        sections.forEach(sec=>{
          if (!sec.hdr) return;
          const anyVisible = sec.rows.some(r => r.style.display !== 'none');
          sec.hdr.style.display = anyVisible ? '' : 'none';
        });
      }

      function applySort(){
        if (!sortState.key) return; // nothing to do
        const key = sortState.key, dir = sortState.dir === 'asc' ? 1 : -1;
        let curSec = null;
        const tbody = document.querySelector('#tc-map tbody');
        const sections = [];
        Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
          if (tr.classList.contains('sec-hdr')){ curSec = { hdr: tr, rows: [] }; sections.push(curSec); return; }
          if (!curSec){ curSec = { hdr: null, rows: [] }; sections.push(curSec); }
          if (tr.style.display === 'none') return; // –Ω–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ
          curSec.rows.push(tr);
        });
        sections.forEach(sec=>{
          const rows = sec.rows;
          rows.sort((a,b)=>{
            const A = getRowData(a), B = getRowData(b);
            let va, vb;
            if (key==='name'){ va = normalizeStr(A.name); vb = normalizeStr(B.name); }
            else if (key==='unit'){ va = normalizeStr(A.unit); vb = normalizeStr(B.unit); }
            else if (key==='qty'){ va = A.qty ?? -Infinity; vb = B.qty ?? -Infinity; }
            else if (key==='tc'){ va = normalizeStr(A.tcText); vb = normalizeStr(B.tcText); }
            else { va = 0; vb = 0; }
            if (va < vb) return -1*dir; if (va > vb) return 1*dir; return 0;
          });
          // re-append in new order right after header (or at start if no header)
          let anchor = sec.hdr ? sec.hdr.nextSibling : tbody.firstChild;
          rows.forEach(r=> tbody.insertBefore(r, anchor));
        });
      }

      function refreshSortIndicators(){
        document.querySelectorAll('#tc-map thead .sortable').forEach(el=>{
          el.classList.toggle('active', el.dataset.key === sortState.key);
          el.setAttribute('data-dir', sortState.dir);
        });
      }

      function setSort(key){
        if (sortState.key !== key){ sortState.key = key; sortState.dir = 'asc'; }
        else { sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc'; }
        refreshSortIndicators();
        // –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫ —Ç–µ–∫—É—â–µ–π –≤—ã–±–æ—Ä–∫–µ
        applyFilters();
        applySort();
      }

      function hookSortHeaders(){
        document.querySelectorAll('#tc-map thead .sortable').forEach(el=>{
          el.addEventListener('click', ()=> setSort(el.dataset.key));
        });
      }

      function hookFilters(){
        ['input','change'].forEach(evt=>{
          flt.text.addEventListener(evt, applyFilters);
          flt.unit.addEventListener(evt, applyFilters);
          flt.qmin.addEventListener(evt, applyFilters);
          flt.qmax.addEventListener(evt, applyFilters);
          flt.stateAll.addEventListener(evt, applyFilters);
          flt.stateMapped.addEventListener(evt, applyFilters);
          flt.stateUnmapped.addEventListener(evt, applyFilters);
        });
        flt.applyBtn?.addEventListener('click', ()=>{ applyFilters(); applySort(); });
        flt.resetBtn.addEventListener('click', ()=>{
          flt.text.value=''; 
          flt.unit.value=''; 
          flt.qmin.value=''; 
          flt.qmax.value=''; 
          flt.stateAll.checked = true;
          applyFilters(); applySort();
        });
      }

      // init
      loadOH();
      buildUnitOptions();
      hookFilters();
      hookSortHeaders();
      applyFilters();
      refreshSortIndicators();
    })();
  </script>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–º–µ—Ç—ã -->
  <script src="{% static 'app_outlay/js/estimate_settings.js' %}"></script>
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–º–µ—Ç—ã
    (function() {
      console.log('üîß –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–º–µ—Ç—ã');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ EstimateSettings
      if (typeof EstimateSettings === 'undefined') {
        console.error('‚ùå EstimateSettings –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        return;
      }
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Å–º–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º original.pk –∏–∑ Django admin)
      const estimateId = {{ original.pk|default:'null' }};
      console.log('üìã Estimate ID:', estimateId);
      
      if (!estimateId) {
        console.error('‚ùå ID —Å–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å
      try {
        EstimateSettings.init(estimateId);
        console.log('‚úÖ –ú–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–º–µ—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
      }
    })();
  </script>
  <!-- –ú–æ–¥—É–ª—å –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –¢–ö -->
  <script src="{% static 'app_outlay/js/estimate_autocomplete.js' %}"></script>
  <script src="{% static 'app_outlay/js/estimate_settings.js' %}"></script>
{% endblock %}