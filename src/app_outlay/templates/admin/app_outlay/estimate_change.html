{# templates/admin/app_outlay/estimate_change.html #}
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .tc-map { width:100%; border-collapse:collapse; margin:16px 0; font-size:13px; }
    .tc-map th, .tc-map td { border:1px solid #e0e0e0; padding:6px 8px; vertical-align:top; }
    .tc-map thead th { background:#f8f8f8; position:sticky; top:0; }
    .tc-map .muted { color:#888; font-size:11px; }
    .tc-map .sys { font-weight:600; }
    .tc-map .cell-2lines > div + div { margin-top:2px; }
    .tc-map .qty-input { width:100px; }
    .tc-map .tc-input { width:260px; }
    .tc-map .col-slim { white-space:nowrap; }
    .tc-map .col-wide { min-width:220px; }
    .tc-map .sec-hdr td { background:#fafafa; padding-top:10px; }
    .badge { display:inline-block; padding:4px 10px; border-radius:10px; font-weight:600; }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}

  <h2 style="margin-top:24px">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¢–ö (—Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥)</h2>

  {% if not table_sections %}
    <p class="help">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–≤—å—é: –ª–∏–±–æ —Ñ–∞–π–ª –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –ª–∏–±–æ —Ä–∞–∑–º–µ—Ç–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –¢–ö.</p>
  {% else %}
    <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê -->
    <div style="margin-bottom: 16px;">
      <button type="button" id="btn-auto-match" class="button" style="background: #417690; color: white;">
        ü§ñ –ê–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ö
      </button>
      <span id="auto-match-status" style="margin-left: 12px; color: #666;"></span>
    </div>

    <!-- –ò–¢–û–ì–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div id="summary-panel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px 16px; margin-bottom: 16px; display: flex; gap: 24px; align-items: center; font-size: 13px;">
      <div style="font-weight: 600; color: #495057;">
        –°—Ç—Ä–æ–∫: <span id="summary-rows">0</span>
      </div>
      <div style="border-left: 1px solid #dee2e6; padding-left: 24px;" id="summary-totals">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∏—Ç–æ–≥–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º -->
      </div>
    </div>

    <table class="tc-map" id="tc-map">
      <thead>
        <tr>
          <th class="col-wide">{{ role_titles.NAME_OF_WORK }}</th>
          <th class="col-slim">{{ role_titles.UNIT }}</th>
          <th class="col-slim">{{ role_titles.QTY }}</th>
          <th class="col-wide">–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –¢–ö</th>
          {% for col in optional_cols %}
            <th>{{ col.title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for sec in table_sections %}
          <tr class="sec-hdr">
            <td colspan="{{ table_colspan }}">
              <span class="badge" style="background: {{ sec.color|default:'#eef' }}">{{ sec.path }}</span>
            </td>
          </tr>

          {% for it in sec.items %}
            <tr data-row="{{ it.row_index }}">
              <td>{{ it.name }}</td>
              <td>{{ it.unit }}</td>
              <td>
                <input type="number" step="0.0001" class="qty-input"
                       value="{{ it.qty|default_if_none:'' }}" placeholder="0">
              </td>
              <td>
                <input type="text" class="tc-input js-tc-autocomplete" placeholder="–ù–∞–π—Ç–∏ –¢–ö‚Ä¶"
                       data-id="" data-text="">
                <div class="muted">—Å—Ç—Ä–æ–∫–∞ Excel: {{ it.row_index }}</div>
              </td>

              {% for v in it.opt_values %}
                <td class="cell-2lines opt-cell">
                  <div class="sys">‚Äî</div>
                  <div class="muted">xls: {{ v|default:"‚Äî" }}</div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
      (function(){
        const CALC_ORDER = JSON.parse('{{ calc_order_json|escapejs }}');
        const AUTOCOMPLETE_URL = "{% url 'admin:outlay_tc_autocomplete' %}";
        const CALC_URL = window.location.pathname.replace(/\/change\/?$/, '/api/calc/');
        const AUTO_MATCH_URL = window.location.pathname.replace(/\/change\/?$/, '/api/auto-match/');
    
        async function searchTC(q){
          const r = await fetch(AUTOCOMPLETE_URL + '?q=' + encodeURIComponent(q));
          const d = await r.json(); return d.results || [];
        }
    
        function attachAutocomplete(input){
          let box;
          input.addEventListener('input', async ()=>{
            const q = input.value.trim();
            if (box) box.remove();
            if (q.length < 2) return;
            const items = await searchTC(q);
            const rect = input.getBoundingClientRect();
            box = document.createElement('div');
            Object.assign(box.style, {
              position:'absolute', background:'#fff', border:'1px solid #ddd',
              zIndex:10, maxHeight:'220px', overflow:'auto',
              left:(rect.left+window.scrollX)+'px', top:(rect.bottom+window.scrollY)+'px',
              minWidth:rect.width+'px'
            });
            items.forEach(it=>{
              const a = document.createElement('div');
              a.textContent = it.text;
              a.style.cssText='padding:4px 8px; cursor:pointer;';
              a.addEventListener('mousedown', ()=>{
                input.value = it.text;
                input.dataset.id = it.id;
                input.dataset.text = it.text;
                box.remove(); box=null;
                const tr = input.closest('tr');
                if (tr) triggerRowCalc(tr);
              });
              box.appendChild(a);
            });
            document.body.appendChild(box);
            const clickAway = (ev)=>{ if (box && !box.contains(ev.target) && ev.target!==input){ box.remove(); box=null; document.removeEventListener('mousedown', clickAway);} };
            setTimeout(()=> document.addEventListener('mousedown', clickAway), 0);
          });
        }
    
        document.querySelectorAll('.js-tc-autocomplete, .tc-lookup').forEach(attachAutocomplete);
    
        async function triggerRowCalc(tr){
          if (!tr) return;
          const inpTC = tr.querySelector('.js-tc-autocomplete');
          const inpQty = tr.querySelector('.qty-input');
          const tcId = parseInt(inpTC?.dataset.id || '0', 10) || 0;
          const qty  = parseFloat((inpQty?.value || '').replace(',', '.')) || 0;
    
          console.log('triggerRowCalc:', { tcId, qty, hasQty: !!qty }); // –î–ï–ë–ê–ì
    
          tr.querySelectorAll('.opt-cell .sys').forEach(el=> el.textContent = '‚Äî');
          if (!tcId || !isFinite(qty) || qty === 0) {
            console.log('Skipping calc: tcId=' + tcId + ', qty=' + qty);
            return;
          }
    
          try{
            const resp = await fetch(CALC_URL + '?tc=' + tcId + '&qty=' + encodeURIComponent(qty));
            const data = await resp.json();
            if (!data.ok) return;
            const calc = data.calc || {};
            const cells = tr.querySelectorAll('.opt-cell');
    
            CALC_ORDER.forEach((rid, idx)=>{
              const td = cells[idx];
              if (!td) return;
              const val = (calc[rid] != null)
                ? Number(calc[rid]).toLocaleString(undefined, {maximumFractionDigits: 4})
                : '‚Äî';
              td.querySelector('.sys').textContent = val;
            });
          }catch(e){
            console.error('Calc error:', e);
          }
        }
    
        document.querySelectorAll('#tc-map .qty-input').forEach(inp=>{
          inp.addEventListener('change', ()=> triggerRowCalc(inp.closest('tr')));
          inp.addEventListener('blur',   ()=> triggerRowCalc(inp.closest('tr')));
        });
    
        // ========== –ê–í–¢–û–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï ==========
        const btnAutoMatch = document.getElementById('btn-auto-match');
        const statusSpan = document.getElementById('auto-match-status');
        
        if (!btnAutoMatch) return;
        
        btnAutoMatch.addEventListener('click', async () => {
          btnAutoMatch.disabled = true;
          statusSpan.textContent = '–ò—â—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è...';
          
          const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
          const items = [];
          
          rows.forEach(tr => {
            const rowIndex = tr.dataset.row;
            const nameCell = tr.querySelector('td:nth-child(1)');
            const unitCell = tr.querySelector('td:nth-child(2)');
            
            if (nameCell && unitCell) {
              items.push({
                row_index: parseInt(rowIndex),
                name: nameCell.textContent.trim(),
                unit: unitCell.textContent.trim()
              });
            }
          });
          
          try {
            const resp = await fetch(AUTO_MATCH_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
              },
              body: JSON.stringify({ items })
            });
            
            const data = await resp.json();
            
            if (!data.ok) {
              statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || 'unknown');
              btnAutoMatch.disabled = false;
              return;
            }
            
            let matched = 0;
            data.results.forEach(result => {
              const tr = document.querySelector(`tr[data-row="${result.row_index}"]`);
              if (!tr) return;
              
              const tcInput = tr.querySelector('.js-tc-autocomplete');
              const qtyInput = tr.querySelector('.qty-input');
              if (!tcInput) return;
              
              if (result.matched_tc_id && result.matched_tc_text) {
                tcInput.value = result.matched_tc_text;
                tcInput.dataset.id = result.matched_tc_id;
                tcInput.dataset.text = result.matched_tc_text;
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                if (result.similarity >= 0.9) {
                  tcInput.style.background = '#d4edda';
                } else if (result.similarity >= 0.5) {
                  tcInput.style.background = '#fff3cd';
                } else {
                  tcInput.style.background = '#f8d7da';
                }
                
                // –í–ê–ñ–ù–û: –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                if (qtyInput && qtyInput.value && parseFloat(qtyInput.value) > 0) {
                  triggerRowCalc(tr);
                } else {
                  console.log('–ü—Ä–æ–ø—É—â–µ–Ω —Ä–∞—Å—á—ë—Ç –¥–ª—è —Å—Ç—Ä–æ–∫–∏', result.row_index, '- –Ω–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞');
                }
                
                matched++;
              }
            });
            
            statusSpan.textContent = `‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${matched} –∏–∑ ${items.length}`;
            setTimeout(updateSummary, 500);
            
          } catch (e) {
            statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
            console.error(e);
          } finally {
            btnAutoMatch.disabled = false;
          }
        });

        // ========== –ò–¢–û–ì–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ==========
    function updateSummary() {
      const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
      const summaryTotals = document.getElementById('summary-totals');
      const summaryRows = document.getElementById('summary-rows');
      
      if (!summaryTotals || !summaryRows) return;
      
      // –ü–æ–¥—Å—á—ë—Ç —Å—Ç—Ä–æ–∫
      summaryRows.textContent = rows.length;
      
      // –ü–æ–¥—Å—á—ë—Ç —Å—É–º–º –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º
      const totals = {};
      CALC_ORDER.forEach(roleId => {
        totals[roleId] = 0;
      });
      
      let calculatedRows = 0;
      
      rows.forEach(tr => {
        const optCells = tr.querySelectorAll('.opt-cell');
        let hasValues = false;
        
        CALC_ORDER.forEach((roleId, idx) => {
          const cell = optCells[idx];
          if (!cell) return;
          
          const sysDiv = cell.querySelector('.sys');
          if (!sysDiv) return;
          
          const text = sysDiv.textContent.trim();
          if (text === '‚Äî' || text === '') return;
          
          // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–æ (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ç—ã—Å—è—á)
          const value = parseFloat(text.replace(/\s/g, '').replace(',', '.'));
          if (!isNaN(value)) {
            totals[roleId] += value;
            hasValues = true;
          }
        });
        
        if (hasValues) calculatedRows++;
      });
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å –∏—Ç–æ–≥–∞–º–∏
      let html = '';
      
      CALC_ORDER.forEach(roleId => {
        const total = totals[roleId];
        if (total > 0) {
          // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
          const colTitle = {{ role_titles|safe }}[roleId] || roleId;
          const shortTitle = colTitle.replace('–¶–ï–ù–ê ', '').replace('–ò–¢–û–ì–û ', '');
          
          html += `
            <div style="margin-right: 20px;">
              <div style="color: #6c757d; font-size: 11px; margin-bottom: 2px;">${shortTitle}</div>
              <div style="font-weight: 600; color: #212529;">${total.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            </div>
          `;
        }
      });
      
      if (html) {
        html = `<div style="color: #6c757d; font-size: 11px; margin-bottom: 4px;">–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${calculatedRows}</div>` + html;
      } else {
        html = '<div style="color: #6c757d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</div>';
      }
      
      summaryTotals.innerHTML = html;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateSummary();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    document.querySelectorAll('#tc-map .qty-input').forEach(inp => {
      inp.addEventListener('change', () => {
        setTimeout(updateSummary, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –¥–æ–∂–¥–∞—Ç—å—Å—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞
      });
    });
      })();
  </script>
{% endblock %}
