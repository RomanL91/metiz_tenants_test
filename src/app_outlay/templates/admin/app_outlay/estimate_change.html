{# templates/admin/app_outlay/estimate_change.html #}
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .tc-map { width:100%; border-collapse:collapse; margin:16px 0; font-size:13px; }
    .tc-map th, .tc-map td { border:1px solid #e0e0e0; padding:6px 8px; vertical-align:top; }
    .tc-map thead th { background:#f8f8f8; position:sticky; top:0; }
    .tc-map .muted { color:#888; font-size:11px; }
    .tc-map .sys { font-weight:600; }
    .tc-map .cell-2lines > div + div { margin-top:2px; }
    .tc-map .qty-input { width:100px; }
    .tc-map .tc-input { width:260px; }
    .tc-map .col-slim { white-space:nowrap; }
    .tc-map .col-wide { min-width:220px; }
    .tc-map .sec-hdr td { background:#fafafa; padding-top:10px; }
    .badge { display:inline-block; padding:4px 10px; border-radius:10px; font-weight:600; }
    .tc-input-wrapper { position: relative; display: inline-block; width: 100%; }
    .tc-clear-btn { 
      position: absolute; 
      right: 4px; 
      top: 50%; 
      transform: translateY(-50%);
      background: #dc3545; 
      color: white; 
      border: none; 
      border-radius: 3px;
      width: 20px; 
      height: 20px; 
      cursor: pointer; 
      font-size: 12px; 
      line-height: 1;
      padding: 0;
      display: none;
      z-index: 5;
    }
    .tc-clear-btn:hover {
      background: #c82333;
    }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}

  <h2 style="margin-top:24px">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¢–ö (—Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥)</h2>

  {% if not table_sections %}
    <p class="help">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–≤—å—é: –ª–∏–±–æ —Ñ–∞–π–ª –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –ª–∏–±–æ —Ä–∞–∑–º–µ—Ç–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –¢–ö.</p>
  {% else %}
    <!-- –ö–ù–û–ü–ö–ò -->
    <div style="margin-bottom: 16px;">
      <button type="button" id="btn-auto-match" class="button" style="background: #417690; color: white;">
        ü§ñ –ê–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ö
      </button>
      <button type="button" id="btn-save-mappings" class="button default" style="margin-left: 8px;">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã
      </button>
      <span id="auto-match-status" style="margin-left: 12px; color: #666;"></span>
    </div>

    <!-- –ò–¢–û–ì–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div id="summary-panel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px;">
      
      <!-- –°–¢–†–û–ö–ê 1: –ë–∞–∑–æ–≤—ã–µ –∏—Ç–æ–≥–∏ -->
      <div style="margin-bottom: 16px;">
        <div style="font-weight: 600; color: #495057; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #dee2e6;">
          üìã –ë–∞–∑–æ–≤—ã–µ –∏—Ç–æ–≥–∏
        </div>
        
        <div style="display: flex; gap: 24px; align-items: center;">
          <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ -->
          <div>
            <div style="font-size: 11px; color: #6c757d;">–°—Ç—Ä–æ–∫</div>
            <div style="font-weight: 600; color: #212529;" id="summary-rows">0</div>
          </div>
          
          <!-- –ò—Ç–æ–≥–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º (JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç) -->
          <div id="summary-totals" style="display: flex; gap: 20px; flex: 1;">
            <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç –∏—Ç–æ–≥–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º -->
          </div>
        </div>
      </div>
      
      <!-- –°–¢–†–û–ö–ê 2: –° —É—á—ë—Ç–æ–º –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
      {% if overhead_calculation and overhead_calculation.overhead_total > 0 %}
      <div style="padding-top: 16px; border-top: 2px solid #dee2e6;">
        <div style="font-weight: 600; color: #856404; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #ffc107;">
          üí∞ –° —É—á—ë—Ç–æ–º –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
          
          <!-- –î–µ—Ç–∞–ª–∏ –ù–† (—Å–ø—Ä–∞–≤–∞ –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞) -->
          {% if overhead_calculation.overhead_details %}
          <details style="display: inline-block; margin-left: 16px; font-size: 11px; color: #666; font-weight: normal;">
            <summary style="cursor: pointer; user-select: none; padding: 4px 8px; background: #fff3cd; border-radius: 4px; display: inline-block;">
              üìä –î–µ—Ç–∞–ª–∏ –ù–† ({{ overhead_calculation.overhead_details|length }})
            </summary>
            <div style="position: absolute; z-index: 1000; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; margin-top: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 300px;">
              {% for detail in overhead_calculation.overhead_details %}
              <div style="margin-bottom: 8px; padding-bottom: 8px; {% if not forloop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
                <div style="font-weight: 600; color: #495057; margin-bottom: 2px;">
                  {{ detail.name }}
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666;">
                  <span>–°—É–º–º–∞: {{ detail.total|floatformat:2 }}</span>
                </div>
                <div style="font-size: 10px; color: #999; margin-top: 2px;">
                  –ú–ê–¢: {{ detail.materials_part|floatformat:2 }} ({{ detail.materials_pct }}%) / 
                  –†–ê–ë: {{ detail.works_part|floatformat:2 }} ({{ detail.works_pct }}%)
                </div>
              </div>
              {% endfor %}
            </div>
          </details>
          {% endif %}
        </div>
        
        <div style="display: flex; gap: 24px; align-items: flex-start;">
          <!-- –ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
          <div style="width: 60px;"></div>
          
          <!-- –ò—Ç–æ–≥–∏ —Å –ù–† (JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç) -->
          <div id="overhead-totals" style="display: flex; gap: 20px; flex-wrap: wrap; flex: 1;">
            <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç -->
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø –¢–ö -->
    <table class="tc-map" id="tc-map">
      <thead>
        <tr>
          <th class="col-wide">{{ role_titles.NAME_OF_WORK }}</th>
          <th class="col-slim">{{ role_titles.UNIT }}</th>
          <th class="col-slim">{{ role_titles.QTY }}</th>
          <th class="col-wide">–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –¢–ö</th>
          {% for col in optional_cols %}
            <th>{{ col.title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for sec in table_sections %}
          <tr class="sec-hdr">
            <td colspan="{{ table_colspan }}">
              <span class="badge" style="background: {{ sec.color|default:'#eef' }}">{{ sec.path }}</span>
            </td>
          </tr>

          {% for it in sec.items %}
            <tr data-row="{{ it.row_index }}">
              <td>{{ it.name }}</td>
              <td>{{ it.unit }}</td>
              <td>
                <input type="number" step="0.0001" class="qty-input"
                       value="{{ it.qty|default_if_none:'' }}" placeholder="0">
              </td>
              <td>
                <input type="text" class="tc-input js-tc-autocomplete" placeholder="–ù–∞–π—Ç–∏ –¢–ö‚Ä¶"
                       data-id="" data-text="">
                <div class="muted">—Å—Ç—Ä–æ–∫–∞ Excel: {{ it.row_index }}</div>
              </td>

              {% for v in it.opt_values %}
                <td class="cell-2lines opt-cell">
                  <div class="sys">‚Äî</div>
                  <div class="muted">xls: {{ v|default:"‚Äî" }}</div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    (function(){
      const CALC_ORDER = JSON.parse('{{ calc_order_json|escapejs }}');
      const AUTOCOMPLETE_URL = "{% url 'admin:outlay_tc_autocomplete' %}";
      const CALC_URL = window.location.pathname.replace(/\/change\/?$/, '/api/calc/');
      const AUTO_MATCH_URL = window.location.pathname.replace(/\/change\/?$/, '/api/auto-match/');
      const SAVE_MAPPINGS_URL = window.location.pathname.replace(/\/change\/?$/, '/api/save-mappings/');
      const EXISTING_MAPPINGS = JSON.parse('{{ existing_mappings_json|escapejs }}' || '{}');
  
      const btnAutoMatch = document.getElementById('btn-auto-match');
      const btnSaveMappings = document.getElementById('btn-save-mappings');
      const statusSpan = document.getElementById('auto-match-status');
  
      async function searchTC(q){
        const r = await fetch(AUTOCOMPLETE_URL + '?q=' + encodeURIComponent(q));
        const d = await r.json(); return d.results || [];
      }
  
      function attachAutocomplete(input){
        let box;
        input.addEventListener('input', async ()=>{
          const q = input.value.trim();
          if (box) box.remove();
          if (q.length < 2) return;
          const items = await searchTC(q);
          const rect = input.getBoundingClientRect();
          box = document.createElement('div');
          Object.assign(box.style, {
            position:'absolute', background:'#fff', border:'1px solid #ddd',
            zIndex:10, maxHeight:'220px', overflow:'auto',
            left:(rect.left+window.scrollX)+'px', top:(rect.bottom+window.scrollY)+'px',
            minWidth:rect.width+'px'
          });
          items.forEach(it=>{
            const a = document.createElement('div');
            a.textContent = it.text;
            a.style.cssText='padding:4px 8px; cursor:pointer;';
            a.addEventListener('mousedown', ()=>{
              input.value = it.text;
              input.dataset.id = it.id;
              input.dataset.text = it.text;
              box.remove(); box=null;
              const tr = input.closest('tr');
              if (tr) triggerRowCalc(tr);
            });
            box.appendChild(a);
          });
          document.body.appendChild(box);
          const clickAway = (ev)=>{ if (box && !box.contains(ev.target) && ev.target!==input){ box.remove(); box=null; document.removeEventListener('mousedown', clickAway);} };
          setTimeout(()=> document.addEventListener('mousedown', clickAway), 0);
        });
      }
  
      document.querySelectorAll('.js-tc-autocomplete, .tc-lookup').forEach(attachAutocomplete);

      // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –∫ –ø–æ–ª—è–º –¢–ö
      document.querySelectorAll('.js-tc-autocomplete').forEach(input => {
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º input –≤ wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'tc-input-wrapper';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
        
        // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
        const clearBtn = document.createElement('button');
        clearBtn.innerHTML = '‚úï';
        clearBtn.type = 'button';
        clearBtn.className = 'tc-clear-btn';
        clearBtn.title = '–û—á–∏—Å—Ç–∏—Ç—å';
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—á–∏—Å—Ç–∫–∏
        clearBtn.addEventListener('click', () => {
          input.value = '';
          input.dataset.id = '';
          input.dataset.text = '';
          input.style.background = '';
          clearBtn.style.display = 'none';
          
          // –û—á–∏—â–∞–µ–º —Ä–∞—Å—á—ë—Ç—ã –≤ —Å—Ç—Ä–æ–∫–µ
          const tr = input.closest('tr');
          if (tr) {
            tr.querySelectorAll('.opt-cell .sys').forEach(el => el.textContent = '‚Äî');
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
          setTimeout(updateSummary, 100);
        });
        
        wrapper.appendChild(clearBtn);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è
        const toggleClearBtn = () => {
          clearBtn.style.display = input.value.trim() ? 'block' : 'none';
        };
        
        input.addEventListener('input', toggleClearBtn);
        input.addEventListener('change', toggleClearBtn);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏
        toggleClearBtn();
      });

      // –ù–û–í–û–ï: –û—á–∏—Å—Ç–∫–∞ dataset.id –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –≤—Ä—É—á–Ω—É—é
      document.querySelectorAll('.js-tc-autocomplete').forEach(input => {
        input.addEventListener('input', () => {
          const currentValue = input.value.trim();
          const datasetText = input.dataset.text || '';
          
          // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º ID
          if (currentValue !== datasetText) {
            input.dataset.id = '';
            input.dataset.text = '';
            
            // –û—á–∏—â–∞–µ–º —Ä–∞—Å—á—ë—Ç—ã
            const tr = input.closest('tr');
            if (tr) {
              tr.querySelectorAll('.opt-cell .sys').forEach(el => el.textContent = '‚Äî');
            }
            
            setTimeout(updateSummary, 100);
          }
        });
        
        // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ - —Ç–æ—á–Ω–æ –æ—á–∏—â–∞–µ–º
        input.addEventListener('blur', () => {
          if (!input.value.trim()) {
            input.dataset.id = '';
            input.dataset.text = '';
            input.style.background = '';
            
            const tr = input.closest('tr');
            if (tr) {
              tr.querySelectorAll('.opt-cell .sys').forEach(el => el.textContent = '‚Äî');
            }
            
            setTimeout(updateSummary, 100);
          }
        });
      });
  
      async function triggerRowCalc(tr){
        if (!tr) return;
        const inpTC = tr.querySelector('.js-tc-autocomplete');
        const inpQty = tr.querySelector('.qty-input');
        const tcId = parseInt(inpTC?.dataset.id || '0', 10) || 0;
        const qty  = parseFloat((inpQty?.value || '').replace(',', '.')) || 0;
  
        tr.querySelectorAll('.opt-cell .sys').forEach(el=> el.textContent = '‚Äî');
        if (!tcId || !isFinite(qty) || qty === 0) return;
  
        try{
          const resp = await fetch(CALC_URL + '?tc=' + tcId + '&qty=' + encodeURIComponent(qty));
          const data = await resp.json();
          if (!data.ok) return;
          const calc = data.calc || {};
          const cells = tr.querySelectorAll('.opt-cell');
  
          CALC_ORDER.forEach((rid, idx)=>{
            const td = cells[idx];
            if (!td) return;
            const val = (calc[rid] != null)
              ? Number(calc[rid]).toLocaleString(undefined, {maximumFractionDigits: 4})
              : '‚Äî';
            td.querySelector('.sys').textContent = val;
          });
        }catch(e){
          console.error('Calc error:', e);
        }
      }
  
      document.querySelectorAll('#tc-map .qty-input').forEach(inp=>{
        inp.addEventListener('change', ()=> triggerRowCalc(inp.closest('tr')));
        inp.addEventListener('blur',   ()=> triggerRowCalc(inp.closest('tr')));
      });
  
      // –ê–í–¢–û–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï
      if (btnAutoMatch) {
        btnAutoMatch.addEventListener('click', async () => {
          btnAutoMatch.disabled = true;
          statusSpan.textContent = '–ò—â—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è...';
          
          const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
          const items = [];
          
          rows.forEach(tr => {
            const rowIndex = tr.dataset.row;
            const nameCell = tr.querySelector('td:nth-child(1)');
            const unitCell = tr.querySelector('td:nth-child(2)');
            
            if (nameCell && unitCell) {
              items.push({
                row_index: parseInt(rowIndex),
                name: nameCell.textContent.trim(),
                unit: unitCell.textContent.trim()
              });
            }
          });
          
          try {
            const resp = await fetch(AUTO_MATCH_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
              },
              body: JSON.stringify({ items })
            });
            
            const data = await resp.json();
            
            if (!data.ok) {
              statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || 'unknown');
              btnAutoMatch.disabled = false;
              return;
            }
            
            let matched = 0;
            data.results.forEach(result => {
              const tr = document.querySelector(`tr[data-row="${result.row_index}"]`);
              if (!tr) return;
              
              const tcInput = tr.querySelector('.js-tc-autocomplete');
              const qtyInput = tr.querySelector('.qty-input');
              if (!tcInput) return;
              
              if (result.matched_tc_id && result.matched_tc_text) {
                tcInput.value = result.matched_tc_text;
                tcInput.dataset.id = result.matched_tc_id;
                tcInput.dataset.text = result.matched_tc_text;
                
                if (result.similarity >= 0.9) {
                  tcInput.style.background = '#d4edda';
                } else if (result.similarity >= 0.5) {
                  tcInput.style.background = '#fff3cd';
                } else {
                  tcInput.style.background = '#f8d7da';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
                const clearBtn = tcInput.parentElement.querySelector('.tc-clear-btn');
                if (clearBtn) clearBtn.style.display = 'block';
                
                if (qtyInput && qtyInput.value && parseFloat(qtyInput.value) > 0) {
                  triggerRowCalc(tr);
                }
                
                matched++;
              }
            });
            
            statusSpan.textContent = `‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${matched} –∏–∑ ${items.length}`;
            setTimeout(updateSummary, 500);
            
          } catch (e) {
            statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
            console.error(e);
          } finally {
            btnAutoMatch.disabled = false;
          }
        });
      }
  
      // –ò–¢–û–ì–û–í–ê–Ø –ü–ê–ù–ï–õ–¨
      function updateSummary() {
        const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
        const summaryTotals = document.getElementById('summary-totals');
        const summaryRows = document.getElementById('summary-rows');
        
        if (!summaryTotals || !summaryRows) return;
        
        summaryRows.textContent = rows.length;
        
        const totals = {};
        CALC_ORDER.forEach(roleId => {
          totals[roleId] = 0;
        });
        
        let calculatedRows = 0;
        
        rows.forEach(tr => {
          const optCells = tr.querySelectorAll('.opt-cell');
          let hasValues = false;
          
          CALC_ORDER.forEach((roleId, idx) => {
            const cell = optCells[idx];
            if (!cell) return;
            
            const sysDiv = cell.querySelector('.sys');
            if (!sysDiv) return;
            
            const text = sysDiv.textContent.trim();
            if (text === '‚Äî' || text === '') return;
            
            const value = parseFloat(text.replace(/\s/g, '').replace(',', '.'));
            if (!isNaN(value)) {
              totals[roleId] += value;
              hasValues = true;
            }
          });
          
          if (hasValues) calculatedRows++;
        });
        
        let html = '';
        
        CALC_ORDER.forEach(roleId => {
          const total = totals[roleId];
          if (total > 0) {
            const colTitle = {{ role_titles|safe }}[roleId] || roleId;
            const shortTitle = colTitle.replace('–¶–ï–ù–ê ', '').replace('–ò–¢–û–ì–û ', '');
            
            html += `
              <div style="margin-right: 20px;">
                <div style="color: #6c757d; font-size: 11px; margin-bottom: 2px;">${shortTitle}</div>
                <div style="font-weight: 600; color: #212529;">${total.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              </div>
            `;
          }
        });
        
        if (html) {
          html = `<div style="color: #6c757d; font-size: 11px; margin-bottom: 4px;">–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${calculatedRows}</div>` + html;
        } else {
          html = '<div style="color: #6c757d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</div>';
        }
        
        summaryTotals.innerHTML = html;
        
        // –û–ë–ù–û–í–õ–Ø–ï–ú –¢–ê–ö–ñ–ï –ò–¢–û–ì–ò –° –ù–†
        updateSummaryWithOverhead();
      }
      
      // –ü–†–ï–î–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –î–ê–ù–ù–´–•
      async function prefillExistingMappings() {
        console.log('–ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π:', EXISTING_MAPPINGS);
        
        const mappingEntries = Object.entries(EXISTING_MAPPINGS);
        
        if (mappingEntries.length === 0) {
          updateSummary();
          return;
        }
        
        const calcPromises = [];
        
        mappingEntries.forEach(([rowIndex, mapping]) => {
          const tr = document.querySelector(`tr[data-row="${rowIndex}"]`);
          if (!tr) return;
          
          const tcInput = tr.querySelector('.js-tc-autocomplete');
          const qtyInput = tr.querySelector('.qty-input');
          
          if (tcInput && mapping.tc_id && mapping.tc_name) {
            tcInput.value = mapping.tc_name;
            tcInput.dataset.id = mapping.tc_id;
            tcInput.dataset.text = mapping.tc_name;
            tcInput.style.background = '#e7f3ff';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
            const clearBtn = tcInput.parentElement.querySelector('.tc-clear-btn');
            if (clearBtn) clearBtn.style.display = 'block';
          }
          
          if (qtyInput && mapping.quantity) {
            qtyInput.value = mapping.quantity;
          }
          
          if (mapping.tc_id && mapping.quantity > 0) {
            calcPromises.push(triggerRowCalc(tr));
          }
        });
        
        // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–∞—Å—á—ë—Ç–æ–≤
        if (calcPromises.length > 0) {
          await Promise.all(calcPromises);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –ø–æ—Å–ª–µ —Ä–∞—Å—á—ë—Ç–æ–≤
        updateSummary();
      }

      // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
      prefillExistingMappings();

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      document.querySelectorAll('#tc-map .qty-input').forEach(inp => {
        inp.addEventListener('change', () => {
          setTimeout(updateSummary, 100);
        });
      });
  
      // –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ê–°–ß–ï–¢–û–í
      if (btnSaveMappings) {
        btnSaveMappings.addEventListener('click', async () => {
          const mappings = [];
          const deletions = [];
          let currentSection = '–ë–µ–∑ –≥—Ä—É–ø–ø—ã';
          
          console.log('–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...');
          
          document.querySelectorAll('#tc-map tbody tr').forEach(tr => {
            if (tr.classList.contains('sec-hdr')) {
              const badge = tr.querySelector('.badge');
              if (badge) {
                currentSection = badge.textContent.trim();
                console.log('–°–µ–∫—Ü–∏—è:', currentSection);
              }
            } else {
              const tcInput = tr.querySelector('.js-tc-autocomplete');
              const qtyInput = tr.querySelector('.qty-input');
              const rowIndex = tr.dataset.row;
              
              if (tcInput && qtyInput && rowIndex) {
                const tcId = parseInt(tcInput.dataset.id || '0', 10);
                const quantity = parseFloat(qtyInput.value || '0');
                
                const hadMapping = EXISTING_MAPPINGS[rowIndex];
                
                if (tcId > 0 && quantity > 0) {
                  mappings.push({
                    section: currentSection,
                    tc_id: tcId,
                    quantity: quantity,
                    row_index: parseInt(rowIndex),
                    tc_name: tcInput.value
                  });
                  console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞:', {section: currentSection, tc_id: tcId, quantity});
                } else if (hadMapping) {
                  deletions.push(parseInt(rowIndex));
                  console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏:', rowIndex);
                }
              }
            }
          });
          
          console.log('–°–æ–±—Ä–∞–Ω–æ mappings:', mappings.length);
          console.log('–£–¥–∞–ª–µ–Ω–∏–π:', deletions.length);
          
          if (mappings.length === 0 && deletions.length === 0) {
            statusSpan.textContent = '‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            statusSpan.style.color = '#856404';
            return;
          }
          
          const confirmMsg = deletions.length > 0 
            ? `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ${mappings.length} –ø–æ–∑–∏—Ü–∏–π –∏ —É–¥–∞–ª–∏—Ç—å ${deletions.length}?\n\n–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≥—Ä—É–ø–ø—ã –∏ —Å–≤—è–∑–∏ —Å –≤–µ—Ä—Å–∏—è–º–∏ –¢–ö.`
            : `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ${mappings.length} –ø–æ–∑–∏—Ü–∏–π –≤ —Å–º–µ—Ç—É?\n\n–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≥—Ä—É–ø–ø—ã –∏ —Å–≤—è–∑–∏ —Å –≤–µ—Ä—Å–∏—è–º–∏ –¢–ö.`;
          
          if (!confirm(confirmMsg)) {
            return;
          }
          
          btnSaveMappings.disabled = true;
          statusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
          statusSpan.style.color = '#666';
          
          try {
            const resp = await fetch(SAVE_MAPPINGS_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
              },
              body: JSON.stringify({ 
                mappings,
                deletions
              })
            });
            
            const data = await resp.json();
            console.log('Response:', data);
            
            if (!data.ok) {
              statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || 'unknown');
              statusSpan.style.color = '#721c24';
              btnSaveMappings.disabled = false;
              return;
            }
            
            const deletedMsg = data.deleted > 0 ? `, —É–¥–∞–ª–µ–Ω–æ: ${data.deleted}` : '';
            statusSpan.textContent = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${data.total} –ø–æ–∑–∏—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–æ: ${data.created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.updated}${deletedMsg})`;
            statusSpan.style.color = '#155724';
            
            setTimeout(() => {
              window.location.reload();
            }, 2000);
            
          } catch (e) {
            statusSpan.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
            statusSpan.style.color = '#721c24';
            console.error(e);
            btnSaveMappings.disabled = false;
          }
        });
      }

      // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–¢–û–ì–û–í –° –ù–† ==========
      function updateSummaryWithOverhead() {
        const overheadTotalsContainer = document.getElementById('overhead-totals');
        if (!overheadTotalsContainer) return;
        
        const overheadData = JSON.parse('{{ overhead_calculation_json|escapejs }}');
        
        if (!overheadData || !overheadData.overhead_total || overheadData.overhead_total === 0) {
          return;
        }
        
        const rows = document.querySelectorAll('#tc-map tbody tr:not(.sec-hdr)');
        const totals = {};
        CALC_ORDER.forEach(roleId => {
          totals[roleId] = 0;
        });
        
        let calculatedRows = 0;
        
        rows.forEach(tr => {
          const optCells = tr.querySelectorAll('.opt-cell');
          let hasValues = false;
          
          CALC_ORDER.forEach((roleId, idx) => {
            const cell = optCells[idx];
            if (!cell) return;
            
            const sysDiv = cell.querySelector('.sys');
            if (!sysDiv) return;
            const text = sysDiv.textContent.trim();
            if (text === '‚Äî' || text === '') return;
            
            const value = parseFloat(text.replace(/\s/g, '').replace(',', '.'));
            if (!isNaN(value)) {
              totals[roleId] += value;
              hasValues = true;
            }
          });
          
          if (hasValues) calculatedRows++;
        });
        
        const overheadMaterials = parseFloat(overheadData.overhead_materials || 0);
        const overheadWorks = parseFloat(overheadData.overhead_works || 0);
        const overheadTotal = parseFloat(overheadData.overhead_total || 0);
        
        let html = `<div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${calculatedRows}</div>`;
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º
        CALC_ORDER.forEach(roleId => {
          const baseValue = totals[roleId] || 0;
          let overheadValue = 0;
          let finalValue = baseValue;
          
          // –í–ê–ñ–ù–û: –ù–† –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫ –ò–¢–û–ì–û–í–´–ú –∫–æ–ª–æ–Ω–∫–∞–º, –Ω–µ –∫ "–Ω–∞ –µ–¥–∏–Ω–∏—Ü—É"!
          const isUnitColumn = roleId.includes('UNIT_PRICE');
          const isMaterialTotalColumn = roleId === 'PRICE_FOR_ALL_MATERIAL';
          const isWorkTotalColumn = roleId === 'PRICE_FOR_ALL_WORK';
          const isTotalColumn = roleId === 'TOTAL_PRICE';
          
          // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ù–† —Ç–æ–ª—å–∫–æ –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
          if (isMaterialTotalColumn) {
            overheadValue = overheadMaterials;
            finalValue = baseValue + overheadMaterials;
          } else if (isWorkTotalColumn) {
            overheadValue = overheadWorks;
            finalValue = baseValue + overheadWorks;
          } else if (isTotalColumn) {
            overheadValue = overheadTotal;
            finalValue = baseValue + overheadTotal;
          } else {
            // –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ "–Ω–∞ –µ–¥–∏–Ω–∏—Ü—É" –ù–† –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º!
            finalValue = baseValue;
            overheadValue = 0;
          }
          
          // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
          if (baseValue === 0 && overheadValue === 0) return;
          
          const colTitle = {{ role_titles|safe }}[roleId] || roleId;
          const shortTitle = colTitle.replace('–¶–ï–ù–ê ', '').replace('–ò–¢–û–ì–û ', '');
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç
          let color = '#212529';
          if (isTotalColumn) color = '#dc3545';
          else if (isMaterialTotalColumn) color = '#28a745';
          else if (isWorkTotalColumn) color = '#17a2b8';
          
          html += `
            <div style="margin-right: 20px;">
              <div style="color: #6c757d; font-size: 11px; margin-bottom: 2px;">${shortTitle}</div>
              <div style="display: flex; align-items: baseline; gap: 6px;">
                <div style="font-weight: 600; color: ${color}; font-size: 14px;">
                  ${finalValue.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
                ${overheadValue > 0 ? `
                  <div style="font-size: 9px; color: #999;">
                    (${baseValue.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})} + ${overheadValue.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})})
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
        
        overheadTotalsContainer.innerHTML = html;
      }
    })();
  </script>
{% endblock %}