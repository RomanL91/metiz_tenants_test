{% extends "admin/change_form.html" %}
{% load i18n static l10n %}

{% block form_top %}
  {{ block.super }}
  <input type="hidden" name="_tc_version_created_by_js" id="tc-version-created-flag" value="">
  <input type="hidden" name="_tc_initial_composition"  id="tc-initial-composition-input" value="">
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .tc-hide-percents { display: none !important; }

    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    @keyframes pulse { 0%, 100%{opacity:1} 50%{opacity:0.6} }
    @keyframes slideIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
    
    #tc-composition-block .spinner{width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}

    .tc-composition-table{width:100%;border-collapse:collapse;font-size:13px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    .tc-composition-table thead{position:sticky;top:0;z-index:10;background:#fff}
    .tc-composition-table th{background:linear-gradient(to bottom, #f8f9fa 0%, #f1f3f5 100%);padding:10px 8px;border-bottom:2px solid #dee2e6;font-weight:600;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:0.3px;color:#495057}
    .tc-composition-table td{padding:10px 8px;border-bottom:1px solid #e9ecef;transition:background 0.15s}
    .tc-composition-table tbody tr:hover{background:#f8f9fa}
    .tc-total-row td{background:linear-gradient(to bottom, #e7f5ff 0%, #d0ebff 100%)!important;border-top:3px solid #339af0;border-bottom:3px solid #339af0;padding:12px 8px!important;font-weight:700;font-size:14px}
    .tc-price-changed{color:#fa5252;font-weight:600;animation:pulse 2s ease-in-out infinite}
    .tc-price-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;background:#fff3bf;color:#e8590c;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
    .tc-price-badge::before{content:"‚ö†";font-size:11px}
    .tc-qty-input{width:110px;text-align:right;padding:6px 8px;border:1.5px solid #ced4da;border-radius:6px;transition:all 0.2s}
    .tc-qty-input:focus{border-color:#339af0;box-shadow:0 0 0 3px rgba(51,154,240,0.1);outline:none}
    .tc-inline-add-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 8px;background:#f8f9fa;border-radius:6px}
    .tc-inline-label{color:#495057;font-weight:600;font-size:13px}
    .tc-hint{color:#868e96;font-size:12px;font-style:italic}
    .tc-name{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .tc-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
    .tc-del{border:none;background:transparent;cursor:pointer;padding:4px 8px;line-height:1;border-radius:6px;color:#adb5bd;font-size:18px;transition:all 0.2s}
    .tc-del:hover{color:#fa5252;background:#ffe0e0;transform:scale(1.1)}
    .tc-del:focus-visible{outline:2px solid #fa5252;outline-offset:2px}
    .tc-table-wrapper{border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .tc-table-wrapper,.tc-composition-table,.tc-composition-table tfoot td{position:relative;overflow:visible}
    .tc-ac{position:relative;min-width:300px;z-index:20000}
    .tc-ac-input{padding:8px 10px;width:100%;border:1.5px solid #ced4da;border-radius:6px;transition:all 0.2s}
    .tc-ac-input:focus{border-color:#339af0;box-shadow:0 0 0 3px rgba(51,154,240,0.1);outline:none}
    .tc-ac-list{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#fff;border:1px solid #dee2e6;border-radius:8px;max-height:280px;overflow:auto;list-style:none;margin:0;padding:6px;box-shadow:0 10px 30px rgba(0,0,0,0.12);display:none;z-index:20001}
    .tc-ac-item{padding:10px 12px;cursor:pointer;display:flex;gap:8px;justify-content:space-between;border-radius:6px;transition:all 0.15s;margin-bottom:2px}
    .tc-ac-item:hover,.tc-ac-item.active{background:#e7f5ff;transform:translateX(2px)}
    .tc-ac-item .tc-ac-name{font-weight:600;color:#212529}
    .tc-ac-item .tc-ac-meta{color:#868e96;font-size:12px;white-space:nowrap}

    :root { --tc-card-min: 300px; }
    
    .tc-section-header{
            display:block;
            width:100%;
            padding:16px 20px;
            background:linear-gradient(to right, #f8f9fa 0%, #fff 100%);
            color:#495057;
            font-weight:600;
            font-size:14px;
             text-transform:uppercase;
            letter-spacing:1.2px;
            border-left:4px solid #667eea;
            border-bottom:2px solid #e9ecef;
            margin:0;
    }
    
    .tc-dashboard{
      margin-top:24px;
      display:grid;
      gap:16px;
      grid-template-columns: repeat(auto-fit, minmax(var(--tc-card-min), 1fr));
      align-items: stretch;
      width:100%;
    }
    
    .tc-card{
      border:1px solid #e9ecef;
      border-radius:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      min-width:0;
      transition:all 0.3s;
      animation:slideIn 0.4s ease-out;
      overflow:hidden;
    }
    
    .tc-card:hover{
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
      transform:translateY(-2px);
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–Ω–ø—É—Ç–∞–º–∏ - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ */
    .tc-card.tc-card-interactive{
      border:2px solid #74c0fc;
      background:linear-gradient(to bottom, #fff 0%, #e7f5ff 100%);
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ - –∞–∫—Ü–µ–Ω—Ç */
    .tc-card.tc-card-result{
      border:2px solid #51cf66;
      background:linear-gradient(to bottom, #fff 0%, #d3f9d8 100%);
    }
    
    .tc-card > .tc-card-h{
      padding:14px 16px;
      border-bottom:1px solid #e9ecef;
      font-weight:700;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      background:linear-gradient(to right, #f8f9fa 0%, #fff 100%);
    }
    
    .tc-card-interactive > .tc-card-h{
      background:linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
      color:#fff;
      border:none;
    }
    
    .tc-card-result > .tc-card-h{
      background:linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
      color:#fff;
      border:none;
    }
    
    .tc-card-icon{
      font-size:18px;
      opacity:0.9;
    }
    
    .tc-card > .tc-card-b{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    
    .tc-kv{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-radius:8px;
      background:#f8f9fa;
      transition:all 0.2s;
    }
    
    .tc-kv:hover{
      background:#e9ecef;
      transform:scale(1.01);
    }
    
    .tc-kv strong{
      font-size:16px;
      font-weight:700;
      color:#212529;
    }
    
    .tc-card-result .tc-kv strong{
      font-size:18px;
      color:#2b8a3e;
    }
    
    .tc-fig{
      font-variant-numeric:tabular-nums;
      font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
    }
    
    .tc-field{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .tc-input{
      width:100%;
      padding:10px 12px;
      border:2px solid #4dabf7;
      border-radius:8px;
      text-align:right;
      font-size:16px;
      font-weight:600;
      color:#1971c2;
      transition:all 0.2s;
      background:#fff;
    }
    
    .tc-input:focus{
      border-color:#1971c2;
      box-shadow:0 0 0 4px rgba(25,113,194,0.15);
      outline:none;
      transform:scale(1.02);
    }
    
    .tc-sub{
      font-size:12px;
      color:#495057;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    @media (max-width: 480px){
      :root { --tc-card-min: 260px; }
      .tc-qty-input{ width:90px; }
    }
  </style>
{% endblock %}

{% block after_field_sets %}
  {{ block.super }}

  <div class="module" id="tc-composition-block" style="margin-top:20px;">
    <h2 style="margin:0; padding:16px 20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(102,126,234,0.2);">
      <span style="font-size:20px;margin-right:8px">üìã</span>
      {% trans "–°–æ—Å—Ç–∞–≤ —Ç–µ—Ö–∫–∞—Ä—Ç—ã" %}
      <span id="tc-version-label" style="opacity:0.9; font-size:.9em; font-weight:400;">
        {% if not original.pk %}({% trans "—á–µ—Ä–Ω–æ–≤–∏–∫" %}){% endif %}
      </span>
    </h2>

    <div style="padding:20px;">
      <div id="tc-composition-loading" style="text-align:center; padding:60px; color:#868e96;">
        <div class="spinner" style="display:inline-block;"></div>
        <p style="margin-top:16px;font-weight:500;">{% trans "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–∞–≤–∞..." %}</p>
      </div>

      <div id="tc-composition-content" style="display:none;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:32px;">
          <div class="tc-section tc-materials">
            <h3 style="margin:0 0 14px 0; padding:10px 14px; background:linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color:#fff; border-radius:10px; font-size:15px; display:flex; align-items:center; gap:10px; box-shadow:0 3px 10px rgba(255,107,107,0.3);">
              <span style="font-size:20px">üß±</span>
              {% trans "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã" %}
            </h3>
            <div class="tc-table-wrapper">
              <table class="tc-composition-table" id="materials-table">
                <thead>
                  <tr>
                    <th>{% trans "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" %}</th>
                    <th style="text-align:right;">{% trans "–ö–æ–ª-–≤–æ" %}</th>
                    <th style="text-align:right;">{% trans "–ï–¥." %}</th>
                    <th style="text-align:right;">{% trans "–¶–µ–Ω–∞ (–≤–µ—Ä—Å–∏—è)" %}</th>
                    <th style="text-align:right;">{% trans "–¶–µ–Ω–∞ (—Ç–µ–∫—É—â–∞—è)" %}</th>
                    <th style="text-align:right;">{% trans "–°—É–º–º–∞" %}</th>
                  </tr>
                </thead>
                <tbody id="materials-tbody"></tbody>
                <tfoot>
                  <tr class="tc-total-row">
                    <td colspan="5" style="text-align:right;">{% trans "–ò—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:" %}</td>
                    <td id="materials-total" style="text-align:right;">‚Äî</td>
                  </tr>
                  <tr class="tc-inline-add">
                    <td colspan="6" style="background:#fafafa;padding:12px;">
                      <div class="tc-inline-add-wrap">
                        <span class="tc-inline-label">‚ûï {% trans "–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª:" %}</span>
                        <div class="tc-ac" data-kind="material">
                          <input type="text" class="tc-ac-input tc-ac-input-material" placeholder="{% trans '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–ª–∏ ID' %}">
                          <ul class="tc-ac-list"></ul>
                        </div>
                        <input type="number" min="0" step="0.001" class="tc-new-qty tc-new-qty-material" placeholder="{% trans '–ö–æ–ª-–≤–æ' %}">
                        <small class="tc-hint">{% trans "–í–≤–µ–¥–∏—Ç–µ 1+ —Å–∏–º–≤–æ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏." %}</small>
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="tc-section tc-works">
            <h3 style="margin:0 0 14px 0; padding:10px 14px; background:linear-gradient(135deg, #20c997 0%, #12b886 100%); color:#fff; border-radius:10px; font-size:15px; display:flex; align-items:center; gap:10px; box-shadow:0 3px 10px rgba(18,184,134,0.3);">
              <span style="font-size:20px">üîß</span>
              {% trans "–†–∞–±–æ—Ç—ã" %}
            </h3>
            <div class="tc-table-wrapper">
              <table class="tc-composition-table" id="works-table">
                <thead>
                  <tr>
                    <th>{% trans "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" %}</th>
                    <th style="text-align:right;">{% trans "–ö–æ–ª-–≤–æ" %}</th>
                    <th style="text-align:right;">{% trans "–ï–¥." %}</th>
                    <th style="text-align:right;">{% trans "–¶–µ–Ω–∞ (–≤–µ—Ä—Å–∏—è)" %}</th>
                    <th style="text-align:right;">{% trans "–¶–µ–Ω–∞ (—Ç–µ–∫—É—â–∞—è)" %}</th>
                    <th style="text-align:right;">{% trans "–°—É–º–º–∞" %}</th>
                  </tr>
                </thead>
                <tbody id="works-tbody"></tbody>
                <tfoot>
                  <tr class="tc-total-row">
                    <td colspan="5" style="text-align:right;">{% trans "–ò—Ç–æ–≥–æ —Ä–∞–±–æ—Ç—ã:" %}</td>
                    <td id="works-total" style="text-align:right;">‚Äî</td>
                  </tr>
                  <tr class="tc-inline-add">
                    <td colspan="6" style="background:#fafafa;padding:12px;">
                      <div class="tc-inline-add-wrap">
                        <span class="tc-inline-label">‚ûï {% trans "–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É:" %}</span>
                        <div class="tc-ac" data-kind="work">
                          <input type="text" class="tc-ac-input tc-ac-input-work" placeholder="{% trans '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏–ª–∏ ID' %}">
                          <ul class="tc-ac-list"></ul>
                        </div>
                        <input type="number" min="0" step="0.001" class="tc-new-qty tc-new-qty-work" placeholder="{% trans '–ö–æ–ª-–≤–æ' %}">
                        <small class="tc-hint">{% trans "–í–≤–µ–¥–∏—Ç–µ 1+ —Å–∏–º–≤–æ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏." %}</small>
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div class="tc-section-header" style="margin:40px 0 24px 0">
          <span>üí∞</span> –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        </div>

        <div class="tc-dashboard">
          <!-- 1. –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–∞–Ω–Ω—ã–µ) -->
          <div class="tc-card">
            <div class="tc-card-h">
              <span class="tc-card-icon">üìä</span>
              {% trans "–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–ø–æ —Ç–µ–∫—É—â–∏–º —Ü–µ–Ω–∞–º), –∑–∞ –µ–¥. –≤—ã–ø—É—Å–∫–∞" %}
            </div>
            <div class="tc-card-b">
              <div class="tc-kv"><span>{% trans "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã" %}</span> <strong class="tc-fig" id="d-cost-mats">‚Äî</strong></div>
              <div class="tc-kv"><span>{% trans "–†–∞–±–æ—Ç—ã" %}</span>     <strong class="tc-fig" id="d-cost-works">‚Äî</strong></div>
              <div class="tc-kv" style="background:#e7f5ff;border:2px solid #74c0fc"><span style="font-weight:700">{% trans "–ò—Ç–æ–≥–æ" %}</span> <strong class="tc-fig" id="d-cost-total" style="color:#1971c2;font-size:18px">‚Äî</strong></div>
            </div>
          </div>

          <!-- 2. –ù–∞–¥–±–∞–≤–∫–∏ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ) -->
          <div class="tc-card tc-card-interactive">
            <div class="tc-card-h">
              <span class="tc-card-icon">‚öôÔ∏è</span>
              {% trans "–ù–∞–¥–±–∞–≤–∫–∏ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (%)" %}
            </div>
            <div class="tc-card-b">
              <div class="tc-field">
                <label class="tc-sub" for="p-mat-markup">{% trans "–ù–∞–¥–±–∞–≤–∫–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, %" %}</label>
                <input id="p-mat-markup" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
              <div class="tc-field">
                <label class="tc-sub" for="p-work-markup">{% trans "–ù–∞–¥–±–∞–≤–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—ã, %" %}</label>
                <input id="p-work-markup" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
              <div class="tc-field">
                <label class="tc-sub" for="p-transport">{% trans "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, %" %}</label>
                <input id="p-transport" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
            </div>
          </div>

          <!-- 3. –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–∞–Ω–Ω—ã–µ) -->
          <div class="tc-card">
            <div class="tc-card-h">
              <span class="tc-card-icon">üìà</span>
              {% trans "–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—Å –Ω–∞–¥–±–∞–≤–∫–∞–º–∏ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º), –∑–∞ –µ–¥." %}
            </div>
            <div class="tc-card-b">
              <div class="tc-kv"><span>{% trans "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã" %}</span> <strong class="tc-fig" id="d-marked-mats">‚Äî</strong></div>
              <div class="tc-kv"><span>{% trans "–†–∞–±–æ—Ç—ã" %}</span>     <strong class="tc-fig" id="d-marked-works">‚Äî</strong></div>
              <div class="tc-kv" style="background:#e7f5ff;border:2px solid #74c0fc"><span style="font-weight:700">{% trans "–ò—Ç–æ–≥–æ" %}</span> <strong class="tc-fig" id="d-marked-total" style="color:#1971c2;font-size:18px">‚Äî</strong></div>
            </div>
          </div>

          <!-- 4. –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ) -->
          <div class="tc-card tc-card-interactive">
            <div class="tc-card-h">
              <span class="tc-card-icon">üíπ</span>
              {% trans "–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å (%)" %}
            </div>
            <div class="tc-card-b">
              <div class="tc-field">
                <label class="tc-sub" for="p-mat-margin">{% trans "–ú–∞—Ä–∂–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, %" %}</label>
                <input id="p-mat-margin" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
              <div class="tc-field">
                <label class="tc-sub" for="p-work-margin">{% trans "–ú–∞—Ä–∂–∞ –Ω–∞ —Ä–∞–±–æ—Ç—ã, %" %}</label>
                <input id="p-work-margin" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
            </div>
          </div>

          <!-- 5. –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç) -->
          <div class="tc-card tc-card-result">
            <div class="tc-card-h">
              <span class="tc-card-icon">‚úÖ</span>
              {% trans "–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏, –∑–∞ –µ–¥." %}
            </div>
            <div class="tc-card-b">
              <div class="tc-kv"><span>{% trans "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã" %}</span> <strong class="tc-fig" id="d-sale-mats">‚Äî</strong></div>
              <div class="tc-kv"><span>{% trans "–†–∞–±–æ—Ç—ã" %}</span>     <strong class="tc-fig" id="d-sale-works">‚Äî</strong></div>
              <div class="tc-kv" style="background:#d3f9d8;border:3px solid #51cf66;padding:14px"><span style="font-weight:700;font-size:15px">{% trans "–ò—Ç–æ–≥–æ" %}</span> <strong class="tc-fig" id="d-sale-total" style="color:#2b8a3e;font-size:22px">‚Äî</strong></div>
            </div>
          </div>

        </div>
      </div>

      <div id="tc-composition-error" style="display:none; padding:20px; background:#ffe0e0; border-left:4px solid #fa5252; border-radius:10px; color:#c92a2a;font-weight:500;box-shadow:0 3px 10px rgba(250,82,82,0.2)"></div>
    </div>
  </div>
{% endblock %}

{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>
  (function() {
    'use strict';

    const tcId = {{ original.pk|default:"null" }};
    const isNew = !tcId;

    const $  = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    const els = {
      loading: $('#tc-composition-loading'),
      content: $('#tc-composition-content'),
      err:     $('#tc-composition-error'),
      vlabel:  $('#tc-version-label'),
      matBody: $('#materials-tbody'),
      workBody: $('#works-tbody'),
      matTotal: $('#materials-total'),
      workTotal: $('#works-total'),
      verGrand: $('#version-grand-total'),
      liveGrand: $('#live-grand-total'),
      hiddenInit: $('#tc-initial-composition-input'),
      flagCreated: $('#tc-version-created-flag'),

      dCostMats: $('#d-cost-mats'),
      dCostWorks: $('#d-cost-works'),
      dCostTotal: $('#d-cost-total'),
      dMarkedMats: $('#d-marked-mats'),
      dMarkedWorks: $('#d-marked-works'),
      dMarkedTotal: $('#d-marked-total'),
      dSaleMats: $('#d-sale-mats'),
      dSaleWorks: $('#d-sale-works'),
      dSaleTotal: $('#d-sale-total'),

      pMatMarkup:  $('#p-mat-markup'),
      pWorkMarkup: $('#p-work-markup'),
      pTransport:  $('#p-transport'),
      pMatMargin:  $('#p-mat-margin'),
      pWorkMargin: $('#p-work-margin'),

      rMatMarkup:  document.querySelector('input[name="materials_markup_percent"]'),
      rWorkMarkup: document.querySelector('input[name="works_markup_percent"]'),
      rTransport:  document.querySelector('input[name="transport_costs_percent"]'),
      rMatMargin:  document.querySelector('input[name="materials_margin_percent"]'),
      rWorkMargin: document.querySelector('input[name="works_margin_percent"]'),
    };

    const API_LIVE = tcId ? `/api/v1/technical-cards/${tcId}/live-composition/` : null;
    const API_MATERIALS = "/api/v1/technical-cards/search/materials/";
    const API_WORKS     = "/api/v1/technical-cards/search/works/";

    const toNum = (x)=> {
      if (x == null) return 0;
      const s = String(x).trim().replace(/\s+/g,'').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const fmt2 = (n)=> Number(n).toFixed(2);

    function clearError(){ els.err.textContent=''; els.err.style.display='none'; }
    function showError(msg){ els.loading.style.display='none'; els.err.textContent=msg; els.err.style.display='block'; }

    function unhideRealPercentFieldsOnError(){
      const hasError = document.querySelector('.errornote, .errorlist');
      if (!hasError) return;
      ['materials_markup_percent','works_markup_percent','transport_costs_percent','materials_margin_percent','works_margin_percent']
        .forEach(name=>{
          const wrap = document.querySelector('.field-' + name);
          if (wrap) wrap.style.display = '';
        });
    }

    function hydrateDashboardFromRealFields(){
      const pairs = [
        [els.pMatMarkup, els.rMatMarkup],
        [els.pWorkMarkup, els.rWorkMarkup],
        [els.pTransport, els.rTransport],
        [els.pMatMargin, els.rMatMargin],
        [els.pWorkMargin, els.rWorkMargin],
      ];
      pairs.forEach(([vis, real])=>{
        if (!vis || !real) return;
        vis.value = String(toNum(real.value));
      });
    }

    function syncRealPercentFieldsFromDashboard(){
      if (els.rMatMarkup)  els.rMatMarkup.value  = fmt2(toNum(els.pMatMarkup.value));
      if (els.rWorkMarkup) els.rWorkMarkup.value = fmt2(toNum(els.pWorkMarkup.value));
      if (els.rTransport)  els.rTransport.value  = fmt2(toNum(els.pTransport.value));
      if (els.rMatMargin)  els.rMatMargin.value  = fmt2(toNum(els.pMatMargin.value));
      if (els.rWorkMargin) els.rWorkMargin.value = fmt2(toNum(els.pWorkMargin.value));
    }

    function recalcAll(){
      let live=0, ver=0, matsLive=0, worksLive=0;
      const fnum=(x)=>fmt2(x);

      const sumBlock=(tbody)=>{
        let l=0, v=0;
        $$('tr',tbody).forEach(tr=>{
          const qty = toNum(tr.querySelector('.tc-qty-input')?.value);
          const lp  = toNum(tr.dataset.livePrice);
          const vp  = toNum(tr.dataset.versionPrice);
          l += qty*lp; v += qty*vp;
          tr.lastElementChild.textContent = fnum(qty*lp);
        });
        return {l,v};
      };

      const mats = sumBlock(els.matBody); const works = sumBlock(els.workBody);
      matsLive = mats.l; worksLive = works.l;
      live = mats.l + works.l; ver = mats.v + works.v;

      if (els.matTotal)  els.matTotal.textContent  = fnum(matsLive);
      if (els.workTotal) els.workTotal.textContent = fnum(worksLive);
      if (els.liveGrand) els.liveGrand.textContent = fnum(live);
      if (els.verGrand)  els.verGrand.textContent  = fnum(ver);

      const p = {
        matMarkup:  toNum(els.pMatMarkup.value)/100,
        workMarkup: toNum(els.pWorkMarkup.value)/100,
        transport:  toNum(els.pTransport.value)/100,
        matMargin:  toNum(els.pMatMargin.value)/100,
        workMargin: toNum(els.pWorkMargin.value)/100,
      };

      const markedMats  = matsLive  * (1 + p.matMarkup  + p.transport);
      const markedWorks = worksLive * (1 + p.workMarkup + p.transport);
      const markedTotal = markedMats + markedWorks;

      const saleMats  = markedMats  * (1 + p.matMargin);
      const saleWorks = markedWorks * (1 + p.workMargin);
      const saleTotal = saleMats + saleWorks;

      els.dCostMats.textContent  = fnum(matsLive);
      els.dCostWorks.textContent = fnum(worksLive);
      els.dCostTotal.textContent = fnum(matsLive + worksLive);

      els.dMarkedMats.textContent  = fnum(markedMats);
      els.dMarkedWorks.textContent = fnum(markedWorks);
      els.dMarkedTotal.textContent = fnum(markedTotal);

      els.dSaleMats.textContent  = fnum(saleMats);
      els.dSaleWorks.textContent = fnum(saleWorks);
      els.dSaleTotal.textContent = fnum(saleTotal);

      syncRealPercentFieldsFromDashboard();
    }

    function createRow(item, kind){
      const refId = item.ref_id ?? item.id;
      const tr = document.createElement('tr');
      tr.dataset.kind = kind; tr.dataset.refId = String(refId || '');
      const versionPrice = Number(item.version_price ?? item.live_price ?? item.price ?? 0);
      const livePrice    = Number(item.live_price    ?? item.price      ?? 0);
      tr.dataset.versionPrice = isFinite(versionPrice) ? String(versionPrice) : "0";
      tr.dataset.livePrice    = isFinite(livePrice)    ? String(livePrice)    : "0";
      const priceChanged = !!item.price_changed;
      const priceClass = priceChanged ? 'tc-price-changed' : '';
      const badge = priceChanged ? '<span class="tc-price-badge">–∏–∑–º</span> ' : '';
      tr.innerHTML = `
        <td><div class="tc-name"><span class="tc-label">${item.name}</span>
        <button type="button" class="tc-del" title="{% trans '–£–¥–∞–ª–∏—Ç—å' %}" aria-label="{% trans '–£–¥–∞–ª–∏—Ç—å' %}">√ó</button></div></td>
        <td style="text-align:right;"><input class="tc-qty-input" type="number" step="0.001" min="0" value="${item.qty_per_unit}"></td>
        <td style="text-align:right;">${item.unit || "‚Äî"}</td>
        <td style="text-align:right;">${fmt2(versionPrice)}</td>
        <td style="text-align:right;" class="${priceClass}">${badge}${fmt2(livePrice)}</td>
        <td style="text-align:right; font-weight:600;">‚Äî</td>`;
      return tr;
    }

    function addOrMergeRow(kind, refId, name, unit, qty, price){
      const tbody = kind==='material'? els.matBody : els.workBody;
      const exist = Array.from(tbody.querySelectorAll('tr')).find(tr => parseInt(tr.dataset.refId,10) === refId);
      if (exist){
        const inp = exist.querySelector('.tc-qty-input');
        inp.value = (toNum(inp.value) + toNum(qty)).toString();
        recalcAll(); return;
      }
      const tr = document.createElement('tr');
      tr.dataset.kind = kind; tr.dataset.refId = String(refId);
      const p = Number(price ?? 0);
      tr.dataset.livePrice = isFinite(p) ? String(p) : "0";
      tr.dataset.versionPrice = isFinite(p) ? String(p) : "0";
      tr.innerHTML = `
        <td><div class="tc-name"><span class="tc-label">${name}</span>
        <button type="button" class="tc-del" title="{% trans '–£–¥–∞–ª–∏—Ç—å' %}" aria-label="{% trans '–£–¥–∞–ª–∏—Ç—å' %}">√ó</button></div></td>
        <td style="text-align:right;"><input class="tc-qty-input" type="number" step="0.001" min="0" value="${qty}"></td>
        <td style="text-align:right;">${unit || '‚Äî'}</td>
        <td style="text-align:right;">${fmt2(p)}</td>
        <td style="text-align:right;">${fmt2(p)}</td>
        <td style="text-align:right; font-weight:600;">‚Äî</td>`;
      tbody.appendChild(tr);
      recalcAll();
    }

    function snapshotFromDOM(){
      const grab=(tbody)=>$$('tr',tbody).map(tr=>({
        ref_id: parseInt(tr.dataset.refId,10),
        qty: toNum(tr.querySelector('.tc-qty-input')?.value)
      })).filter(x=>Number.isFinite(x.ref_id));
      return { materials: grab(els.matBody), works: grab(els.workBody) };
    }

    async function loadComposition(){
      clearError();
      if (isNew){
        els.loading.style.display='none'; els.content.style.display='';
        hydrateDashboardFromRealFields();
        recalcAll();
        return;
      }
      els.content.style.display='none'; els.loading.style.display='';
      els.matBody.innerHTML=''; els.workBody.innerHTML=''; els.vlabel.textContent='';
      try{
        const r = await fetch(API_LIVE, {credentials:'same-origin'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const verNum = data.version_number ?? data.version ?? '‚Äî';
        els.vlabel.textContent = ` (v${verNum})`;
        (data.materials||[]).forEach(item=>els.matBody.appendChild(createRow(item,'material')));
        (data.works||[]).forEach(item=>els.workBody.appendChild(createRow(item,'work')));
        els.loading.style.display='none'; els.content.style.display='';

        hydrateDashboardFromRealFields();
        recalcAll();
      }catch(e){
        showError(e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–∞–≤');
      }
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    async function fetchSearch(kind,q){
      if(!q || q.trim().length<1) return [];
      const url=(kind==='material'?API_MATERIALS:API_WORKS)+`?q=${encodeURIComponent(q)}&limit=10`;
      const r=await fetch(url,{credentials:'same-origin'}); if(!r.ok) return [];
      return await r.json();
    }
    function renderSuggestions(listEl, items, activeIdx){
      listEl.innerHTML='';
      items.forEach((it,idx)=>{
        const li=document.createElement('li');
        li.className='tc-ac-item'+(idx===activeIdx?' active':'');
        li.dataset.id=it.id; li.dataset.name=it.name; li.dataset.unit=(it.unit||''); li.dataset.price = it.price ?? '';
        li.innerHTML=`<span class="tc-ac-name">${it.name}</span><span class="tc-ac-meta">#${it.id}${it.unit?' ¬∑ '+it.unit:''}${it.price?' ¬∑ '+it.price:''}</span>`;
        listEl.appendChild(li);
      });
      listEl.style.display = items.length ? 'block' : 'none';
    }
    function attachAutocomplete(root){
      const kind=root.dataset.kind;
      const input=root.querySelector('.tc-ac-input');
      const list =root.querySelector('.tc-ac-list');
      const qtyInput=document.querySelector(kind==='material'?'.tc-new-qty-material':'.tc-new-qty-work');
      let items=[], active=-1;
      const doSearch = debounce(async ()=>{ items=await fetchSearch(kind,input.value); active=items.length?0:-1; renderSuggestions(list,items,active); },160);
      input.addEventListener('input', doSearch);
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') e.preventDefault();
        if(list.style.display==='none') return;
        if(e.key==='ArrowDown'){ e.preventDefault(); active=Math.min(items.length-1,active+1); renderSuggestions(list,items,active); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); active=Math.max(0,active-1); renderSuggestions(list,items,active); }
        else if(e.key==='Enter'){ e.preventDefault(); if(active>=0&&items[active]){ apply(items[active]); } else if(items.length===1){ apply(items[0]); } }
        else if(e.key==='Escape'){ list.style.display='none'; }
      });
      list.addEventListener('click',(e)=>{
        const li=e.target.closest('.tc-ac-item'); if(!li) return;
        apply({ id: parseInt(li.dataset.id,10), name: li.dataset.name, unit: (li.dataset.unit || ''), price: li.dataset.price ? Number(li.dataset.price) : undefined });
      });
      function apply(chosen){
        if(!chosen) return;
        const q=Number(qtyInput.value||1); const qty=Number.isFinite(q)&&q>=0 ? q:1;
        addOrMergeRow(kind, chosen.id, chosen.name, chosen.unit, qty, chosen.price);
        input.value=''; qtyInput.value=''; items=[]; active=-1; list.style.display='none'; input.focus();
      }
    }

    function bindDeleteAndQty(){
      const onClick=(e)=>{
        const btn = e.target.closest('.tc-del');
        if(!btn) return;
        e.preventDefault();
        const tr = btn.closest('tr');
        if(tr){ tr.remove(); recalcAll(); }
      };
      const onChange=(e)=>{
        if(!e.target.classList.contains('tc-qty-input')) return;
        recalcAll();
      };
      $('#materials-tbody').addEventListener('click', onClick);
      $('#works-tbody').addEventListener('click', onClick);
      $('#materials-tbody').addEventListener('input', onChange);
      $('#works-tbody').addEventListener('input', onChange);
    }

    function collect(kind){
      const tbody = kind==='material'? $('#materials-tbody') : $('#works-tbody');
      return Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const ref = parseInt(tr.dataset.refId,10);
        const qty = Number(toNum(tr.querySelector('.tc-qty-input')?.value));
        return Number.isFinite(ref)&&Number.isFinite(qty)&&qty>=0 ? {ref_id:ref, qty:qty} : null;
      }).filter(Boolean);
    }

    function findAdminForm(){
      return document.querySelector('main form[id$="_form"][method="post"]')
          || document.querySelector('form[id$="_form"][method="post"]')
          || document.querySelector('form[method="post"][action]')
          || document.querySelector('form[method="post"]')
          || document.forms[0] || null;
    }

    function handleSubmit(form){
      if (form.__tcSubmitting) return;
      form.__tcSubmitting = true;

      syncRealPercentFieldsFromDashboard();

      const current = { materials: collect('material'), works: collect('work') };
      els.hiddenInit.value = JSON.stringify(current);
      form.submit();
    }

    function attachSubmitHooks(){
      const form = findAdminForm();
      window.addEventListener('submit', function(ev){
        const target = ev.target;
        if (!(target instanceof HTMLFormElement)) return;
        if (!document.getElementById('tc-composition-block')) return;
        ev.preventDefault();
        handleSubmit(target);
      }, true);
    }

    function bindPercents(){
      [els.pMatMarkup, els.pWorkMarkup, els.pTransport, els.pMatMargin, els.pWorkMargin]
        .forEach(inp => inp.addEventListener('input', recalcAll));
    }

    async function start(){
      await loadComposition();
      attachAutocomplete($('.tc-ac[data-kind="material"]'));
      attachAutocomplete($('.tc-ac[data-kind="work"]'));
      bindDeleteAndQty();
      bindPercents();
      attachSubmitHooks();
      unhideRealPercentFieldsOnError();
      if (isNew){ els.loading.style.display='none'; els.content.style.display=''; }
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', start); else start();
  })();
  </script>
{% endblock %}