{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>
  (function() {
    'use strict';

    function getCsrfToken() {
      const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (el && el.value) return el.value;
      const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }

    const tcId = {{ original.pk|default:"null" }};
    const isNew = !tcId;

    const $  = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    const els = {
      loading: $('#tc-composition-loading'),
      content: $('#tc-composition-content'),
      err:     $('#tc-composition-error'),
      vlabel:  $('#tc-version-label'),
      matBody: $('#materials-tbody'),
      workBody: $('#works-tbody'),
      matTotal: $('#materials-total'),
      workTotal: $('#works-total'),
      verGrand: $('#version-grand-total'),
      liveGrand: $('#live-grand-total'),
      hiddenInit: $('#tc-initial-composition-input'),
      flagCreated: $('#tc-version-created-flag'),

      dCostMats: $('#d-cost-mats'),
      dCostWorks: $('#d-cost-works'),
      dCostTotal: $('#d-cost-total'),
      dMarkedMats: $('#d-marked-mats'),
      dMarkedWorks: $('#d-marked-works'),
      dMarkedTotal: $('#d-marked-total'),
      dSaleMats: $('#d-sale-mats'),
      dSaleWorks: $('#d-sale-works'),
      dSaleTotal: $('#d-sale-total'),

      pMatMarkup:  $('#p-mat-markup'),
      pWorkMarkup: $('#p-work-markup'),
      pTransport:  $('#p-transport'),
      pMatMargin:  $('#p-mat-margin'),
      pWorkMargin: $('#p-work-margin'),

      rMatMarkup:  document.querySelector('input[name="materials_markup_percent"]'),
      rWorkMarkup: document.querySelector('input[name="works_markup_percent"]'),
      rTransport:  document.querySelector('input[name="transport_costs_percent"]'),
      rMatMargin:  document.querySelector('input[name="materials_margin_percent"]'),
      rWorkMargin: document.querySelector('input[name="works_margin_percent"]'),
    };

    const API_LIVE = tcId ? `/api/v1/technical-cards/${tcId}/live-composition/` : null;
    const API_MATERIALS = "/api/v1/technical-cards/search/materials/";
    const API_WORKS     = "/api/v1/technical-cards/search/works/";
    const API_DUPLICATE = tcId ? `/api/v1/technical-cards/${tcId}/duplicate/` : null;

    const toNum = (x)=> {
      if (x == null) return 0;
      const s = String(x).trim().replace(/\s+/g,'').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const fmt2 = (n)=> Number(n).toFixed(2);

    // Утилита: определение единицы измерения для отображения
    const getDisplayUnit = (kind, methodCode, unit) => {
      return (kind === 'work' && methodCode === 'labor') ? 'Ч/Ч' : (unit || '—');
    };

    function clearError(){ els.err.textContent=''; els.err.style.display='none'; }
    function showError(msg){ els.loading.style.display='none'; els.err.textContent=msg; els.err.style.display='block'; }

    function unhideRealPercentFieldsOnError(){
      const hasError = document.querySelector('.errornote, .errorlist');
      if (!hasError) return;
      ['materials_markup_percent','works_markup_percent','transport_costs_percent','materials_margin_percent','works_margin_percent']
        .forEach(name=>{
          const wrap = document.querySelector('.field-' + name);
          if (wrap) wrap.style.display = '';
        });
    }

    function hydrateDashboardFromRealFields(){
      const pairs = [
        [els.pMatMarkup, els.rMatMarkup],
        [els.pWorkMarkup, els.rWorkMarkup],
        [els.pTransport, els.rTransport],
        [els.pMatMargin, els.rMatMargin],
        [els.pWorkMargin, els.rWorkMargin],
      ];
      pairs.forEach(([vis, real])=>{
        if (!vis || !real) return;
        vis.value = String(toNum(real.value));
      });
    }

    function syncRealPercentFieldsFromDashboard(){
      if (els.rMatMarkup)  els.rMatMarkup.value  = fmt2(toNum(els.pMatMarkup.value));
      if (els.rWorkMarkup) els.rWorkMarkup.value = fmt2(toNum(els.pWorkMarkup.value));
      if (els.rTransport)  els.rTransport.value  = fmt2(toNum(els.pTransport.value));
      if (els.rMatMargin)  els.rMatMargin.value  = fmt2(toNum(els.pMatMargin.value));
      if (els.rWorkMargin) els.rWorkMargin.value = fmt2(toNum(els.pWorkMargin.value));
    }

    function recalcAll(){
      let live=0, ver=0, matsLive=0, worksLive=0;
      const fnum=(x)=>fmt2(x);

      const sumBlock=(tbody)=>{
        let l=0, v=0;
        $$('tr',tbody).forEach(tr=>{
          const qty = toNum(tr.querySelector('.tc-qty-input')?.value);
          const lp  = toNum(tr.dataset.livePrice);
          const vp  = toNum(tr.dataset.versionPrice);
          l += qty*lp; v += qty*vp;
          tr.lastElementChild.textContent = fnum(qty*lp);
        });
        return {l,v};
      };

      const mats = sumBlock(els.matBody); const works = sumBlock(els.workBody);
      matsLive = mats.l; worksLive = works.l;
      live = mats.l + works.l; ver = mats.v + works.v;

      if (els.matTotal)  els.matTotal.textContent  = fnum(matsLive);
      if (els.workTotal) els.workTotal.textContent = fnum(worksLive);
      if (els.liveGrand) els.liveGrand.textContent = fnum(live);
      if (els.verGrand)  els.verGrand.textContent  = fnum(ver);

      const p = {
        matMarkup:  toNum(els.pMatMarkup.value)/100,
        workMarkup: toNum(els.pWorkMarkup.value)/100,
        transport:  toNum(els.pTransport.value)/100,
        matMargin:  toNum(els.pMatMargin.value)/100,
        workMargin: toNum(els.pWorkMargin.value)/100,
      };

      const markedMats  = matsLive  * (1 + p.matMarkup  + p.transport);
      const markedWorks = worksLive * (1 + p.workMarkup + p.transport);
      const markedTotal = markedMats + markedWorks;

      const saleMats  = markedMats  * (1 + p.matMargin);
      const saleWorks = markedWorks * (1 + p.workMargin);
      const saleTotal = saleMats + saleWorks;

      els.dCostMats.textContent  = fnum(matsLive);
      els.dCostWorks.textContent = fnum(worksLive);
      els.dCostTotal.textContent = fnum(matsLive + worksLive);

      els.dMarkedMats.textContent  = fnum(markedMats);
      els.dMarkedWorks.textContent = fnum(markedWorks);
      els.dMarkedTotal.textContent = fnum(markedTotal);

      els.dSaleMats.textContent  = fnum(saleMats);
      els.dSaleWorks.textContent = fnum(saleWorks);
      els.dSaleTotal.textContent = fnum(saleTotal);

      syncRealPercentFieldsFromDashboard();
    }

    function createRow(item, kind){
      const refId = item.ref_id ?? item.id;
      const tr = document.createElement('tr');
      tr.dataset.kind = kind; tr.dataset.refId = String(refId || '');
      const versionPrice = Number(item.version_price ?? item.live_price ?? item.price ?? 0);
      const livePrice    = Number(item.live_price    ?? item.price      ?? 0);
      tr.dataset.versionPrice = isFinite(versionPrice) ? String(versionPrice) : "0";
      tr.dataset.livePrice    = isFinite(livePrice)    ? String(livePrice)    : "0";
      const priceChanged = !!item.price_changed;
      const priceClass = priceChanged ? 'tc-price-changed' : '';
      const badge = priceChanged ? '<span class="tc-price-badge">изм</span> ' : '';

      // Для работ с методом "labor" показываем "Ч/Ч" вместо единицы из справочника
      const displayUnit = (kind === 'work' && (item.calculation_method || item.method) === 'labor') ? 'Ч/Ч' : (item.unit || '—');

      let methodBadge = '';
      if (kind === 'work'){
        methodCode = item.calculation_method || item.method || '';
        const methodLabel = item.calculation_method_label || item.method_label || '';
        tr.dataset.method = methodCode || '';
        tr.dataset.methodLabel = methodLabel || '';
        if (methodLabel){
          const cls = methodCode === 'labor' ? 'tc-tag tc-tag-labor' : 'tc-tag tc-tag-service';
          methodBadge = `<span class="${cls}" data-method="${methodCode}">${methodLabel}</span>`;
        }
      }

      const displayUnit = (kind === 'work' && methodCode === 'labor') ? 'Ч/Ч' : (unit || '—');

      tr.innerHTML = `
        <td><div class="tc-name"><span class="tc-label-wrap"><span class="tc-label">${item.name}</span>${methodBadge}</span>
        <button type="button" class="tc-del" title="{% trans 'Удалить' %}" aria-label="{% trans 'Удалить' %}">×</button></div></td>
        <td style="text-align:right;"><input class="tc-qty-input" type="number" step="0.001" min="0" value="${item.qty_per_unit}"></td>
        <td style="text-align:right;">${displayUnit}</td>
        <td style="text-align:right;">${fmt2(versionPrice)}</td>
        <td style="text-align:right;" class="${priceClass}">${badge}${fmt2(livePrice)}</td>
        <td style="text-align:right; font-weight:600;">—</td>`;
      return tr;
    }

    function addOrMergeRow(kind, refId, name, unit, qty, price, method){
      const tbody = kind==='material'? els.matBody : els.workBody;
      const methodCode = kind==='work' && method ? (method.code || method) : '';
      const methodLabel = kind==='work' && method ? (method.label || method.method_label || '') : '';
      const exist = Array.from(tbody.querySelectorAll('tr')).find(tr => {
        if (parseInt(tr.dataset.refId,10) !== refId) return false;
        if (kind !== 'work') return true;
        return (tr.dataset.method || '') === (methodCode || '');
      });
      if (exist){
        const inp = exist.querySelector('.tc-qty-input');
        inp.value = (toNum(inp.value) + toNum(qty)).toString();
        recalcAll(); return;
      }
      const tr = document.createElement('tr');
      tr.dataset.kind = kind; tr.dataset.refId = String(refId);
      const p = Number(price ?? 0);
      tr.dataset.livePrice = isFinite(p) ? String(p) : "0";
      tr.dataset.versionPrice = isFinite(p) ? String(p) : "0";
      if (kind==='work'){
        tr.dataset.method = methodCode || '';
        tr.dataset.methodLabel = methodLabel || '';
      }
      
      const displayUnit = getDisplayUnit(kind, methodCode, unit);
      const badge = kind==='work' && methodLabel
        ? `<span class="${(methodCode==='labor'?'tc-tag tc-tag-labor':'tc-tag tc-tag-service')}" data-method="${methodCode}">${methodLabel}</span>`
        : '';
      tr.innerHTML = `
        <td><div class="tc-name"><span class="tc-label-wrap"><span class="tc-label">${name}</span>${badge}</span>
        <button type="button" class="tc-del" title="{% trans 'Удалить' %}" aria-label="{% trans 'Удалить' %}">×</button></div></td>
        <td style="text-align:right;"><input class="tc-qty-input" type="number" step="0.001" min="0" value="${qty}"></td>
        <td style="text-align:right;">${displayUnit}</td>
        <td style="text-align:right;">${fmt2(p)}</td>
        <td style="text-align:right;">${fmt2(p)}</td>
        <td style="text-align:right; font-weight:600;">—</td>`;
      tbody.appendChild(tr);
      recalcAll();
    }

    function snapshotFromDOM(){
      const grab=(tbody, kind)=>$$('tr',tbody).map(tr=>{
        const payload = {
          ref_id: parseInt(tr.dataset.refId,10),
          qty: toNum(tr.querySelector('.tc-qty-input')?.value)
        };
        if (kind === 'work'){
          const method = tr.dataset.method || '';
          if (method) payload.method = method;
        }
        return payload;
      }).filter(x=>Number.isFinite(x.ref_id));
      return { materials: grab(els.matBody,'material'), works: grab(els.workBody,'work') };
    }

    async function loadComposition(){
      clearError();
      if (isNew){
        els.loading.style.display='none'; els.content.style.display='';
        hydrateDashboardFromRealFields();
        recalcAll();
        return;
      }
      els.content.style.display='none'; els.loading.style.display='';
      els.matBody.innerHTML=''; els.workBody.innerHTML=''; els.vlabel.textContent='';
      try{
        const r = await fetch(API_LIVE, {credentials:'same-origin'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const verNum = data.version_number ?? data.version ?? '—';
        els.vlabel.textContent = ` (v${verNum})`;
        (data.materials||[]).forEach(item=>els.matBody.appendChild(createRow(item,'material')));
        (data.works||[]).forEach(item=>els.workBody.appendChild(createRow(item,'work')));
        els.loading.style.display='none'; els.content.style.display='';

        hydrateDashboardFromRealFields();
        recalcAll();
      }catch(e){
        showError(e.message || 'Не удалось загрузить состав');
      }
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    async function fetchSearch(kind,q){
      if(!q || q.trim().length<1) return [];
      const url=(kind==='material'?API_MATERIALS:API_WORKS)+`?q=${encodeURIComponent(q)}&limit=10`;
      const r=await fetch(url,{credentials:'same-origin'}); if(!r.ok) return [];
      return await r.json();
    }
    function renderSuggestions(listEl, items, activeIdx){
      listEl.innerHTML='';
      const kind = listEl.closest('.tc-ac')?.dataset.kind || '';
      items.forEach((it,idx)=>{
        const li=document.createElement('li');
        li.className='tc-ac-item'+(idx===activeIdx?' active':'');
        li.dataset.idx = String(idx);
        li.dataset.id=it.id; li.dataset.name=it.name;
        li.dataset.unit=(it.unit||''); li.dataset.price = it.price ?? '';
        const metaParts = [`#${it.id}`];
        if (kind==='work'){
          const methods = Array.isArray(it.methods) ? it.methods : [];
          if (methods.length){
            metaParts.push(methods.map(m=>`${m.label}: ${fmt2(m.price ?? 0)}`).join(' / '));
          } else if (it.price){
            metaParts.push(fmt2(it.price));
          }
        } else {
          if (it.unit) metaParts.push(it.unit);
          if (it.price) metaParts.push(fmt2(it.price));
        }
        li.innerHTML=`<span class="tc-ac-name">${it.name}</span><span class="tc-ac-meta">${metaParts.filter(Boolean).join(' · ')}</span>`;
        listEl.appendChild(li);
      });
      listEl.style.display = items.length ? 'block' : 'none';
    }
    function attachAutocomplete(root){
      const kind=root.dataset.kind;
      const input=root.querySelector('.tc-ac-input');
      const list =root.querySelector('.tc-ac-list');
      const qtyInput=document.querySelector(kind==='material'?'.tc-new-qty-material':'.tc-new-qty-work');
      let items=[], active=-1;
      const doSearch = debounce(async ()=>{ items=await fetchSearch(kind,input.value); active=items.length?0:-1; renderSuggestions(list,items,active); },160);
      input.addEventListener('input', doSearch);
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') e.preventDefault();
        if(list.style.display==='none') return;
        if(e.key==='ArrowDown'){ e.preventDefault(); active=Math.min(items.length-1,active+1); renderSuggestions(list,items,active); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); active=Math.max(0,active-1); renderSuggestions(list,items,active); }
        else if(e.key==='Enter'){ e.preventDefault(); if(active>=0&&items[active]){ apply(items[active]); } else if(items.length===1){ apply(items[0]); } }
        else if(e.key==='Escape'){ list.style.display='none'; }
      });
      list.addEventListener('click',(e)=>{
        const li=e.target.closest('.tc-ac-item'); if(!li) return;
        const idx = Number.parseInt(li.dataset.idx || '-1', 10);
        apply(items[idx] || items.find(it=>it.id===parseInt(li.dataset.id,10)));
      });

      function pickWorkMethod(workItem){
        const methods = Array.isArray(workItem?.methods) ? workItem.methods.filter(m=>m && m.code) : [];
        if (!methods.length){
          if (workItem?.price !== undefined){
            const defaultCode = workItem.default_method || 'service';
            return {
              code: defaultCode,
              label: defaultCode === 'labor' ? 'Человеко-часы' : 'Услуга',
              unit: workItem.unit || '',
              price: workItem.price ?? 0,
            };
          }
          if (workItem?.default_method){
            return {
              code: workItem.default_method,
              label: '',
              unit: workItem.unit || '',
              price: workItem.price ?? 0,
            };
          }
          return null;
        }
        if (methods.length === 1) return methods[0];
        const service = methods.find(m=>m.code==='service');
        const labor = methods.find(m=>m.code==='labor');
        if (service && labor){
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999';
          modal.innerHTML = `
            <div style="background:#fff;padding:24px;border-radius:12px;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
              <h3 style="margin:0 0 16px 0;font-size:18px;color:#212529">Выберите метод расчёта</h3>
              <p style="margin:0 0 20px 0;color:#495057">Работа: <strong>${workItem.name}</strong></p>
              <div style="display:flex;gap:12px;flex-direction:column">
                <button type="button" class="method-choice" data-method="service" style="padding:16px;border:2px solid #4dabf7;border-radius:8px;background:#fff;cursor:pointer;text-align:left;transition:all 0.2s">
                  <div style="font-weight:700;color:#1971c2;margin-bottom:4px">${service.label}</div>
                  <div style="color:#868e96;font-size:13px">${fmt2(service.price ?? 0)} ₽${service.unit ? ' / '+service.unit : ''}</div>
                </button>
                <button type="button" class="method-choice" data-method="labor" style="padding:16px;border:2px solid #fab005;border-radius:8px;background:#fff;cursor:pointer;text-align:left;transition:all 0.2s">
                  <div style="font-weight:700;color:#d9480f;margin-bottom:4px">${labor.label}</div>
                  <div style="color:#868e96;font-size:13px">${fmt2(labor.price ?? 0)} ₽${labor.unit ? ' / '+labor.unit : ''}</div>
                </button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          
          return new Promise(resolve=>{
            modal.querySelectorAll('.method-choice').forEach(btn=>{
              btn.addEventListener('mouseenter',()=>btn.style.transform='scale(1.02)');
              btn.addEventListener('mouseleave',()=>btn.style.transform='');
              btn.addEventListener('click',()=>{
                const choice = btn.dataset.method === 'labor' ? labor : service;
                document.body.removeChild(modal);
                resolve(choice);
              });
            });
          });
        }
        return methods[0];
      }

      async function apply(chosen){
        if(!chosen) return;
        const q=Number(qtyInput.value||1); const qty=Number.isFinite(q)&&q>=0 ? q:1;
        let methodPayload = null;
        if (kind==='work'){
          methodPayload = await pickWorkMethod(chosen);
          if (!methodPayload) return;
        }
        const unit = methodPayload?.unit ?? chosen.unit ?? '';
        const price = Number(methodPayload?.price ?? chosen.price ?? 0);
        addOrMergeRow(kind, chosen.id, chosen.name, unit, qty, price, methodPayload);
        input.value=''; qtyInput.value=''; items=[]; active=-1; list.style.display='none'; input.focus();
      }
    }

    function bindDeleteAndQty(){
      const onClick=(e)=>{
        const btn = e.target.closest('.tc-del');
        if(!btn) return;
        e.preventDefault();
        const tr = btn.closest('tr');
        if(tr){ tr.remove(); recalcAll(); }
      };
      const onChange=(e)=>{
        if(!e.target.classList.contains('tc-qty-input')) return;
        recalcAll();
      };
      $('#materials-tbody').addEventListener('click', onClick);
      $('#works-tbody').addEventListener('click', onClick);
      $('#materials-tbody').addEventListener('input', onChange);
      $('#works-tbody').addEventListener('input', onChange);
    }

    function collect(kind){
      const tbody = kind==='material'? $('#materials-tbody') : $('#works-tbody');
      return Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const ref = parseInt(tr.dataset.refId,10);
        const qty = Number(toNum(tr.querySelector('.tc-qty-input')?.value));
        if (!Number.isFinite(ref) || !Number.isFinite(qty) || qty < 0) return null;
        const payload = {ref_id:ref, qty:qty};
        if (kind==='work'){
          const method = tr.dataset.method || '';
          if (method) payload.method = method;
        }
        return payload;
      }).filter(Boolean);
    }

    function findAdminForm(){
      return document.querySelector('main form[id$="_form"][method="post"]')
          || document.querySelector('form[id$="_form"][method="post"]')
          || document.querySelector('form[method="post"][action]')
          || document.querySelector('form[method="post"]')
          || document.forms[0] || null;
    }

    function handleSubmit(form){
      if (form.__tcSubmitting) return;
      form.__tcSubmitting = true;

      syncRealPercentFieldsFromDashboard();

      const current = { materials: collect('material'), works: collect('work') };
      els.hiddenInit.value = JSON.stringify(current);
      form.submit();
    }

    function attachSubmitHooks(){
      const form = findAdminForm();
      window.addEventListener('submit', function(ev){
        const target = ev.target;
        if (!(target instanceof HTMLFormElement)) return;
        if (!document.getElementById('tc-composition-block')) return;
        ev.preventDefault();
        handleSubmit(target);
      }, true);
    }

    function bindPercents(){
      [els.pMatMarkup, els.pWorkMarkup, els.pTransport, els.pMatMargin, els.pWorkMargin]
        .forEach(inp => inp.addEventListener('input', recalcAll));
    }

    async function start(){
      await loadComposition();
      attachAutocomplete($('.tc-ac[data-kind="material"]'));
      attachAutocomplete($('.tc-ac[data-kind="work"]'));
      bindDeleteAndQty();
      bindPercents();
      attachSubmitHooks();
      unhideRealPercentFieldsOnError();
      if (isNew){ els.loading.style.display='none'; els.content.style.display=''; }

      const dupBtn = document.getElementById('tc-duplicate-btn');
      if (dupBtn) {
        dupBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          if (!confirm('Вы создаете копию данной ТК и будете перенаправлены на страницу копии.')) {
            return;
          }

          dupBtn.style.opacity = '0.5';
          dupBtn.style.pointerEvents = 'none';

          try {
            const response = await fetch(API_DUPLICATE, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: '{}'
            })
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            window.location.href = `/ru/admin/app_technical_cards/technicalcard/${data.id}/change/`;
          } catch(err) {
            alert('Ошибка при создании копии: ' + err.message);
            dupBtn.style.opacity = ''; dupBtn.style.pointerEvents = '';
          }
        });
      }
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', start); else start();
  })();
  </script>
{% endblock %}