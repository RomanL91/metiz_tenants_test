{% extends "admin/change_form.html" %}
{% load i18n static l10n %}

{% block form_top %}
  {{ block.super }}
  <input type="hidden" name="_tc_version_created_by_js" id="tc-version-created-flag" value="">
  <input type="hidden" name="_tc_initial_composition"  id="tc-initial-composition-input" value="">
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .tc-hide-percents { display: none !important; }

    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #tc-composition-block .spinner{width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}

    .tc-composition-table{width:100%;border-collapse:collapse;font-size:13px}
    .tc-composition-table th{background:#f8f9fa;padding:8px;border-bottom:2px solid #dee2e6;font-weight:600;text-align:left}
    .tc-composition-table td{padding:8px;border-bottom:1px solid #e9ecef}
    .tc-composition-table tbody tr:hover{background:#f8f9fa}
    .tc-total-row td{background:#f8f9fa!important;border-top:2px solid #dee2e6;padding-top:10px!important}
    .tc-price-changed{color:#dc3545;font-weight:600}
    .tc-price-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:600;background:#ffc107;color:#000}
    .tc-qty-input{width:110px;text-align:right;padding:4px 6px}
    .tc-inline-add-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 0}
    .tc-inline-label{color:#555;font-weight:600}
    .tc-hint{color:#777}
    .tc-name{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .tc-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .tc-del{border:none;background:transparent;cursor:pointer;padding:2px 6px;line-height:1;border-radius:6px;color:#9ca3af;font-size:16px}
    .tc-del:hover{color:#ef4444;background:#fee2e2}
    .tc-del:focus-visible{outline:2px solid #ef4444;outline-offset:2px}
    .tc-table-wrapper,.tc-composition-table,.tc-composition-table tfoot td{position:relative;overflow:visible}
    .tc-ac{position:relative;min-width:300px;z-index:20000}
    .tc-ac-input{padding:6px 8px;width:100%}
    .tc-ac-list{position:absolute;left:0;right:0;top:calc(100% + 2px);background:#fff;border:1px solid #e5e7eb;border-radius:6px;max-height:260px;overflow:auto;list-style:none;margin:0;padding:4px 0;box-shadow:0 8px 20px rgba(0,0,0,.06);display:none;z-index:20001}
    .tc-ac-item{padding:6px 10px;cursor:pointer;display:flex;gap:8px;justify-content:space-between}
    .tc-ac-item:hover,.tc-ac-item.active{background:#f3f4f6}
    .tc-ac-item .tc-ac-name{font-weight:600;color:#111827}
    .tc-ac-item .tc-ac-meta{color:#6b7280;font-size:12px;white-space:nowrap}

    :root { --tc-card-min: 280px; }
    .tc-dashboard{
      margin-top:18px;
      display:grid;
      gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(var(--tc-card-min), 1fr));
      align-items: stretch;
      width:100%;
    }
    .tc-card{
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .tc-card > .tc-card-h{padding:10px 12px;border-bottom:1px solid #eef2f7;font-weight:600}
    .tc-card > .tc-card-b{padding:12px;display:flex;flex-direction:column;gap:10px}
    .tc-kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;background:#f9fafb}
    .tc-kv strong{font-size:14px}
    .tc-fig{font-variant-numeric:tabular-nums}
    .tc-field{display:flex;flex-direction:column;gap:6px}
    .tc-input{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;text-align:right}
    .tc-sub{font-size:12px;color:#6b7280}
    .tc-grand-total{background:rgba(59,130,246,.08); border-radius:8px; padding:15px; text-align:right; margin-top:8px;}

    @media (max-width: 480px){
      :root { --tc-card-min: 240px; }
      .tc-qty-input{ width:90px; }
    }
  </style>
{% endblock %}

{% block after_field_sets %}
  {{ block.super }}

  <div class="module" id="tc-composition-block" style="margin-top:20px;">
    <h2 style="margin:0; padding:12px 15px; background:rgba(59,130,246,.06); border-left:3px solid rgba(59,130,246,.35); border-radius:8px;">
      {% trans "Состав техкарты" %}
      <span id="tc-version-label" style="color:#666; font-size:.9em;">
        {% if not original.pk %}({% trans "черновик" %}){% endif %}
      </span>
    </h2>

    <div style="padding:15px;">
      <div id="tc-composition-loading" style="text-align:center; padding:40px; color:#666;">
        <div class="spinner" style="display:inline-block;"></div>
        <p style="margin-top:10px;">{% trans "Загрузка состава..." %}</p>
      </div>

      <div id="tc-composition-content" style="display:none;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
          <div class="tc-section tc-materials">
            <h3 style="margin:0 0 10px 0; padding:8px 10px; background:rgba(239,68,68,.05); border-left:3px solid rgba(239,68,68,.30); border-radius:8px;">
              <span style="display:inline-block; width:20px; height:20px; background:#ef4444; border-radius:50%; margin-right:8px;"></span>
              {% trans "Материалы" %}
            </h3>
            <div class="tc-table-wrapper">
              <table class="tc-composition-table" id="materials-table">
                <thead>
                  <tr>
                    <th>{% trans "Наименование" %}</th>
                    <th style="text-align:right;">{% trans "Кол-во" %}</th>
                    <th style="text-align:right;">{% trans "Ед." %}</th>
                    <th style="text-align:right;">{% trans "Цена (версия)" %}</th>
                    <th style="text-align:right;">{% trans "Цена (текущая)" %}</th>
                    <th style="text-align:right;">{% trans "Сумма" %}</th>
                  </tr>
                </thead>
                <tbody id="materials-tbody"></tbody>
                <tfoot>
                  <tr class="tc-total-row">
                    <td colspan="5" style="text-align:right; font-weight:600;">{% trans "Итого материалы:" %}</td>
                    <td id="materials-total" style="text-align:right; font-weight:600;">—</td>
                  </tr>
                  <tr class="tc-inline-add">
                    <td colspan="6" style="background:#fafafa;">
                      <div class="tc-inline-add-wrap">
                        <span class="tc-inline-label">{% trans "Добавить материал:" %}</span>
                        <div class="tc-ac" data-kind="material">
                          <input type="text" class="tc-ac-input tc-ac-input-material" placeholder="{% trans 'Название материала или ID' %}">
                          <ul class="tc-ac-list"></ul>
                        </div>
                        <input type="number" min="0" step="0.001" class="tc-new-qty tc-new-qty-material" placeholder="{% trans 'Кол-во' %}">
                        <small class="tc-hint">{% trans "Введите 1+ символ для поиска. Выберите элемент и укажите количество — строка добавится автоматически." %}</small>
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="tc-section tc-works">
            <h3 style="margin:0 0 10px 0; padding:8px 10px; background:rgba(16,185,129,.06); border-left:3px solid rgba(16,185,129,.35); border-radius:8px;">
              <span style="display:inline-block; width:20px; height:20px; background:#10b981; border-radius:50%; margin-right:8px;"></span>
              {% trans "Работы" %}
            </h3>
            <div class="tc-table-wrapper">
              <table class="tc-composition-table" id="works-table">
                <thead>
                  <tr>
                    <th>{% trans "Наименование" %}</th>
                    <th style="text-align:right;">{% trans "Кол-во" %}</th>
                    <th style="text-align:right;">{% trans "Ед." %}</th>
                    <th style="text-align:right;">{% trans "Цена (версия)" %}</th>
                    <th style="text-align:right;">{% trans "Цена (текущая)" %}</th>
                    <th style="text-align:right;">{% trans "Сумма" %}</th>
                  </tr>
                </thead>
                <tbody id="works-tbody"></tbody>
                <tfoot>
                  <tr class="tc-total-row">
                    <td colspan="5" style="text-align:right; font-weight:600;">{% trans "Итого работы:" %}</td>
                    <td id="works-total" style="text-align:right; font-weight:600;">—</td>
                  </tr>
                  <tr class="tc-inline-add">
                    <td colspan="6" style="background:#fafafa;">
                      <div class="tc-inline-add-wrap">
                        <span class="tc-inline-label">{% trans "Добавить работу:" %}</span>
                        <div class="tc-ac" data-kind="work">
                          <input type="text" class="tc-ac-input tc-ac-input-work" placeholder="{% trans 'Название работы или ID' %}">
                          <ul class="tc-ac-list"></ul>
                        </div>
                        <input type="number" min="0" step="0.001" class="tc-new-qty tc-new-qty-work" placeholder="{% trans 'Кол-во' %}">
                        <small class="tc-hint">{% trans "Введите 1+ символ для поиска. Выберите элемент и укажите количество — строка добавится автоматически." %}</small>
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div class="tc-dashboard">
          <div class="tc-card">
            <div class="tc-card-h">{% trans "Себестоимость (по текущим ценам), за ед. выпуска" %}</div>
            <div class="tc-card-b">
              <div class="tc-kv"><span>{% trans "Материалы" %}</span> <strong class="tc-fig" id="d-cost-mats">—</strong></div>
              <div class="tc-kv"><span>{% trans "Работы" %}</span>     <strong class="tc-fig" id="d-cost-works">—</strong></div>
              <div class="tc-kv"><span>{% trans "Итого" %}</span>      <strong class="tc-fig" id="d-cost-total">—</strong></div>
            </div>
          </div>

          <div class="tc-card">
            <div class="tc-card-h">{% trans "Надбавки и транспорт (%)" %}</div>
            <div class="tc-card-b">
              <div class="tc-field">
                <label class="tc-sub" for="p-mat-markup">{% trans "Надбавка на материалы, %" %}</label>
                <input id="p-mat-markup" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
              <div class="tc-field">
                <label class="tc-sub" for="p-work-markup">{% trans "Надбавка на работы, %" %}</label>
                <input id="p-work-markup" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
              <div class="tc-field">
                <label class="tc-sub" for="p-transport">{% trans "Транспортные расходы, %" %}</label>
                <input id="p-transport" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
            </div>
          </div>

          <div class="tc-card">
            <div class="tc-card-h">{% trans "Общая стоимость (с надбавками и транспортом), за ед." %}</div>
            <div class="tc-card-b">
              <div class="tc-kv"><span>{% trans "Материалы" %}</span> <strong class="tc-fig" id="d-marked-mats">—</strong></div>
              <div class="tc-kv"><span>{% trans "Работы" %}</span>     <strong class="tc-fig" id="d-marked-works">—</strong></div>
              <div class="tc-kv"><span>{% trans "Итого" %}</span>      <strong class="tc-fig" id="d-marked-total">—</strong></div>
            </div>
          </div>

          <div class="tc-card">
            <div class="tc-card-h">{% trans "Маржинальность (%)" %}</div>
            <div class="tc-card-b">
              <div class="tc-field">
                <label class="tc-sub" for="p-mat-margin">{% trans "Маржа на материалы, %" %}</label>
                <input id="p-mat-margin" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
              <div class="tc-field">
                <label class="tc-sub" for="p-work-margin">{% trans "Маржа на работы, %" %}</label>
                <input id="p-work-margin" class="tc-input" type="number" inputmode="decimal" step="0.01" min="0" value="">
              </div>
            </div>
          </div>

          <div class="tc-card">
            <div class="tc-card-h">{% trans "Цена продажи, за ед." %}</div>
            <div class="tc-card-b">
              <div class="tc-kv"><span>{% trans "Материалы" %}</span> <strong class="tc-fig" id="d-sale-mats">—</strong></div>
              <div class="tc-kv"><span>{% trans "Работы" %}</span>     <strong class="tc-fig" id="d-sale-works">—</strong></div>
              <div class="tc-kv"><span>{% trans "Итого" %}</span>      <strong class="tc-fig" id="d-sale-total">—</strong></div>
            </div>
          </div>

        </div>
      </div>

      <div id="tc-composition-error" style="display:none; padding:20px; background:#fee; border-left:3px solid #dc3545; border-radius:8px; color:#721c24;"></div>
    </div>
  </div>
{% endblock %}

{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>
  (function() {
    'use strict';

    const tcId = {{ original.pk|default:"null" }};
    const isNew = !tcId;

    const $  = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    const els = {
      loading: $('#tc-composition-loading'),
      content: $('#tc-composition-content'),
      err:     $('#tc-composition-error'),
      vlabel:  $('#tc-version-label'),
      matBody: $('#materials-tbody'),
      workBody: $('#works-tbody'),
      matTotal: $('#materials-total'),
      workTotal: $('#works-total'),
      verGrand: $('#version-grand-total'),
      liveGrand: $('#live-grand-total'),
      hiddenInit: $('#tc-initial-composition-input'),
      flagCreated: $('#tc-version-created-flag'),

      dCostMats: $('#d-cost-mats'),
      dCostWorks: $('#d-cost-works'),
      dCostTotal: $('#d-cost-total'),
      dMarkedMats: $('#d-marked-mats'),
      dMarkedWorks: $('#d-marked-works'),
      dMarkedTotal: $('#d-marked-total'),
      dSaleMats: $('#d-sale-mats'),
      dSaleWorks: $('#d-sale-works'),
      dSaleTotal: $('#d-sale-total'),

      pMatMarkup:  $('#p-mat-markup'),
      pWorkMarkup: $('#p-work-markup'),
      pTransport:  $('#p-transport'),
      pMatMargin:  $('#p-mat-margin'),
      pWorkMargin: $('#p-work-margin'),

      rMatMarkup:  document.querySelector('input[name="materials_markup_percent"]'),
      rWorkMarkup: document.querySelector('input[name="works_markup_percent"]'),
      rTransport:  document.querySelector('input[name="transport_costs_percent"]'),
      rMatMargin:  document.querySelector('input[name="materials_margin_percent"]'),
      rWorkMargin: document.querySelector('input[name="works_margin_percent"]'),
    };

    const API_LIVE = tcId ? `/api/v1/technical-cards/${tcId}/live-composition/` : null;
    const API_MATERIALS = "/api/v1/technical-cards/search/materials/";
    const API_WORKS     = "/api/v1/technical-cards/search/works/";

    const toNum = (x)=> {
      if (x == null) return 0;
      const s = String(x).trim().replace(/\s+/g,'').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const fmt2 = (n)=> Number(n).toFixed(2);

    function clearError(){ els.err.textContent=''; els.err.style.display='none'; }
    function showError(msg){ els.loading.style.display='none'; els.err.textContent=msg; els.err.style.display='block'; }

    function unhideRealPercentFieldsOnError(){
      const hasError = document.querySelector('.errornote, .errorlist');
      if (!hasError) return;
      ['materials_markup_percent','works_markup_percent','transport_costs_percent','materials_margin_percent','works_margin_percent']
        .forEach(name=>{
          const wrap = document.querySelector('.field-' + name);
          if (wrap) wrap.style.display = '';
        });
    }

    function hydrateDashboardFromRealFields(){
      const pairs = [
        [els.pMatMarkup, els.rMatMarkup],
        [els.pWorkMarkup, els.rWorkMarkup],
        [els.pTransport, els.rTransport],
        [els.pMatMargin, els.rMatMargin],
        [els.pWorkMargin, els.rWorkMargin],
      ];
      pairs.forEach(([vis, real])=>{
        if (!vis || !real) return;
        vis.value = String(toNum(real.value));
      });
    }

    function syncRealPercentFieldsFromDashboard(){
      // ВАЖНО: для type="number" нужна ТОЧКА, а не запятая!
      if (els.rMatMarkup)  els.rMatMarkup.value  = fmt2(toNum(els.pMatMarkup.value));
      if (els.rWorkMarkup) els.rWorkMarkup.value = fmt2(toNum(els.pWorkMarkup.value));
      if (els.rTransport)  els.rTransport.value  = fmt2(toNum(els.pTransport.value));
      if (els.rMatMargin)  els.rMatMargin.value  = fmt2(toNum(els.pMatMargin.value));
      if (els.rWorkMargin) els.rWorkMargin.value = fmt2(toNum(els.pWorkMargin.value));
    }

    function recalcAll(){
      let live=0, ver=0, matsLive=0, worksLive=0;
      const fnum=(x)=>fmt2(x);

      const sumBlock=(tbody)=>{
        let l=0, v=0;
        $$('tr',tbody).forEach(tr=>{
          const qty = toNum(tr.querySelector('.tc-qty-input')?.value);
          const lp  = toNum(tr.dataset.livePrice);
          const vp  = toNum(tr.dataset.versionPrice);
          l += qty*lp; v += qty*vp;
          tr.lastElementChild.textContent = fnum(qty*lp);
        });
        return {l,v};
      };

      const mats = sumBlock(els.matBody); const works = sumBlock(els.workBody);
      matsLive = mats.l; worksLive = works.l;
      live = mats.l + works.l; ver = mats.v + works.v;

      if (els.matTotal)  els.matTotal.textContent  = fnum(matsLive);
      if (els.workTotal) els.workTotal.textContent = fnum(worksLive);
      if (els.liveGrand) els.liveGrand.textContent = fnum(live);
      if (els.verGrand)  els.verGrand.textContent  = fnum(ver);

      const p = {
        matMarkup:  toNum(els.pMatMarkup.value)/100,
        workMarkup: toNum(els.pWorkMarkup.value)/100,
        transport:  toNum(els.pTransport.value)/100,
        matMargin:  toNum(els.pMatMargin.value)/100,
        workMargin: toNum(els.pWorkMargin.value)/100,
      };

      const markedMats  = matsLive  * (1 + p.matMarkup  + p.transport);
      const markedWorks = worksLive * (1 + p.workMarkup + p.transport);
      const markedTotal = markedMats + markedWorks;

      const saleMats  = markedMats  * (1 + p.matMargin);
      const saleWorks = markedWorks * (1 + p.workMargin);
      const saleTotal = saleMats + saleWorks;

      els.dCostMats.textContent  = fnum(matsLive);
      els.dCostWorks.textContent = fnum(worksLive);
      els.dCostTotal.textContent = fnum(matsLive + worksLive);

      els.dMarkedMats.textContent  = fnum(markedMats);
      els.dMarkedWorks.textContent = fnum(markedWorks);
      els.dMarkedTotal.textContent = fnum(markedTotal);

      els.dSaleMats.textContent  = fnum(saleMats);
      els.dSaleWorks.textContent = fnum(saleWorks);
      els.dSaleTotal.textContent = fnum(saleTotal);

      syncRealPercentFieldsFromDashboard();
    }

    function createRow(item, kind){
      const refId = item.ref_id ?? item.id;
      const tr = document.createElement('tr');
      tr.dataset.kind = kind; tr.dataset.refId = String(refId || '');
      const versionPrice = Number(item.version_price ?? item.live_price ?? item.price ?? 0);
      const livePrice    = Number(item.live_price    ?? item.price      ?? 0);
      tr.dataset.versionPrice = isFinite(versionPrice) ? String(versionPrice) : "0";
      tr.dataset.livePrice    = isFinite(livePrice)    ? String(livePrice)    : "0";
      const priceChanged = !!item.price_changed;
      const priceClass = priceChanged ? 'tc-price-changed' : '';
      const badge = priceChanged ? '<span class="tc-price-badge">изм.</span> ' : '';
      tr.innerHTML = `
        <td><div class="tc-name"><span class="tc-label">${item.name}</span>
        <button type="button" class="tc-del" title="{% trans 'Удалить' %}" aria-label="{% trans 'Удалить' %}">×</button></div></td>
        <td style="text-align:right;"><input class="tc-qty-input" type="number" step="0.001" min="0" value="${item.qty_per_unit}"></td>
        <td style="text-align:right;">${item.unit || "—"}</td>
        <td style="text-align:right;">${fmt2(versionPrice)}</td>
        <td style="text-align:right;" class="${priceClass}">${badge}${fmt2(livePrice)}</td>
        <td style="text-align:right; font-weight:600;">—</td>`;
      return tr;
    }

    function addOrMergeRow(kind, refId, name, unit, qty, price){
      const tbody = kind==='material'? els.matBody : els.workBody;
      const exist = Array.from(tbody.querySelectorAll('tr')).find(tr => parseInt(tr.dataset.refId,10) === refId);
      if (exist){
        const inp = exist.querySelector('.tc-qty-input');
        inp.value = (toNum(inp.value) + toNum(qty)).toString();
        recalcAll(); return;
      }
      const tr = document.createElement('tr');
      tr.dataset.kind = kind; tr.dataset.refId = String(refId);
      const p = Number(price ?? 0);
      tr.dataset.livePrice = isFinite(p) ? String(p) : "0";
      tr.dataset.versionPrice = isFinite(p) ? String(p) : "0";
      tr.innerHTML = `
        <td><div class="tc-name"><span class="tc-label">${name}</span>
        <button type="button" class="tc-del" title="{% trans 'Удалить' %}" aria-label="{% trans 'Удалить' %}">×</button></div></td>
        <td style="text-align:right;"><input class="tc-qty-input" type="number" step="0.001" min="0" value="${qty}"></td>
        <td style="text-align:right;">${unit || '—'}</td>
        <td style="text-align:right;">${fmt2(p)}</td>
        <td style="text-align:right;">${fmt2(p)}</td>
        <td style="text-align:right; font-weight:600;">—</td>`;
      tbody.appendChild(tr);
      recalcAll();
    }

    function snapshotFromDOM(){
      const grab=(tbody)=>$$('tr',tbody).map(tr=>({
        ref_id: parseInt(tr.dataset.refId,10),
        qty: toNum(tr.querySelector('.tc-qty-input')?.value)
      })).filter(x=>Number.isFinite(x.ref_id));
      return { materials: grab(els.matBody), works: grab(els.workBody) };
    }

    async function loadComposition(){
      clearError();
      if (isNew){
        els.loading.style.display='none'; els.content.style.display='';
        hydrateDashboardFromRealFields();
        recalcAll();
        return;
      }
      els.content.style.display='none'; els.loading.style.display='';
      els.matBody.innerHTML=''; els.workBody.innerHTML=''; els.vlabel.textContent='';
      try{
        const r = await fetch(API_LIVE, {credentials:'same-origin'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const verNum = data.version_number ?? data.version ?? '—';
        els.vlabel.textContent = ` (v${verNum})`;
        (data.materials||[]).forEach(item=>els.matBody.appendChild(createRow(item,'material')));
        (data.works||[]).forEach(item=>els.workBody.appendChild(createRow(item,'work')));
        els.loading.style.display='none'; els.content.style.display='';

        hydrateDashboardFromRealFields();
        recalcAll();
      }catch(e){
        showError(e.message || 'Не удалось загрузить состав');
      }
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    async function fetchSearch(kind,q){
      if(!q || q.trim().length<1) return [];
      const url=(kind==='material'?API_MATERIALS:API_WORKS)+`?q=${encodeURIComponent(q)}&limit=10`;
      const r=await fetch(url,{credentials:'same-origin'}); if(!r.ok) return [];
      return await r.json();
    }
    function renderSuggestions(listEl, items, activeIdx){
      listEl.innerHTML='';
      items.forEach((it,idx)=>{
        const li=document.createElement('li');
        li.className='tc-ac-item'+(idx===activeIdx?' active':'');
        li.dataset.id=it.id; li.dataset.name=it.name; li.dataset.unit=(it.unit||''); li.dataset.price = it.price ?? '';
        li.innerHTML=`<span class="tc-ac-name">${it.name}</span><span class="tc-ac-meta">#${it.id}${it.unit?' · '+it.unit:''}${it.price?' · '+it.price:''}</span>`;
        listEl.appendChild(li);
      });
      listEl.style.display = items.length ? 'block' : 'none';
    }
    function attachAutocomplete(root){
      const kind=root.dataset.kind;
      const input=root.querySelector('.tc-ac-input');
      const list =root.querySelector('.tc-ac-list');
      const qtyInput=document.querySelector(kind==='material'?'.tc-new-qty-material':'.tc-new-qty-work');
      let items=[], active=-1;
      const doSearch = debounce(async ()=>{ items=await fetchSearch(kind,input.value); active=items.length?0:-1; renderSuggestions(list,items,active); },160);
      input.addEventListener('input', doSearch);
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') e.preventDefault();
        if(list.style.display==='none') return;
        if(e.key==='ArrowDown'){ e.preventDefault(); active=Math.min(items.length-1,active+1); renderSuggestions(list,items,active); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); active=Math.max(0,active-1); renderSuggestions(list,items,active); }
        else if(e.key==='Enter'){ e.preventDefault(); if(active>=0&&items[active]){ apply(items[active]); } else if(items.length===1){ apply(items[0]); } }
        else if(e.key==='Escape'){ list.style.display='none'; }
      });
      list.addEventListener('click',(e)=>{
        const li=e.target.closest('.tc-ac-item'); if(!li) return;
        apply({ id: parseInt(li.dataset.id,10), name: li.dataset.name, unit: (li.dataset.unit || ''), price: li.dataset.price ? Number(li.dataset.price) : undefined });
      });
      function apply(chosen){
        if(!chosen) return;
        const q=Number(qtyInput.value||1); const qty=Number.isFinite(q)&&q>=0 ? q:1;
        addOrMergeRow(kind, chosen.id, chosen.name, chosen.unit, qty, chosen.price);
        input.value=''; qtyInput.value=''; items=[]; active=-1; list.style.display='none'; input.focus();
      }
    }

    function bindDeleteAndQty(){
      const onClick=(e)=>{
        const btn = e.target.closest('.tc-del');
        if(!btn) return;
        e.preventDefault();
        const tr = btn.closest('tr');
        if(tr){ tr.remove(); recalcAll(); }
      };
      const onChange=(e)=>{
        if(!e.target.classList.contains('tc-qty-input')) return;
        recalcAll();
      };
      $('#materials-tbody').addEventListener('click', onClick);
      $('#works-tbody').addEventListener('click', onClick);
      $('#materials-tbody').addEventListener('input', onChange);
      $('#works-tbody').addEventListener('input', onChange);
    }

    function collect(kind){
      const tbody = kind==='material'? $('#materials-tbody') : $('#works-tbody');
      return Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const ref = parseInt(tr.dataset.refId,10);
        const qty = Number(toNum(tr.querySelector('.tc-qty-input')?.value));
        return Number.isFinite(ref)&&Number.isFinite(qty)&&qty>=0 ? {ref_id:ref, qty:qty} : null;
      }).filter(Boolean);
    }

    function findAdminForm(){
      return document.querySelector('main form[id$="_form"][method="post"]')
          || document.querySelector('form[id$="_form"][method="post"]')
          || document.querySelector('form[method="post"][action]')
          || document.querySelector('form[method="post"]')
          || document.forms[0] || null;
    }

    function handleSubmit(form){
      if (form.__tcSubmitting) return;
      form.__tcSubmitting = true;

      syncRealPercentFieldsFromDashboard();

      const current = { materials: collect('material'), works: collect('work') };
      els.hiddenInit.value = JSON.stringify(current);
      form.submit();
    }

    function attachSubmitHooks(){
      const form = findAdminForm();
      window.addEventListener('submit', function(ev){
        const target = ev.target;
        if (!(target instanceof HTMLFormElement)) return;
        if (!document.getElementById('tc-composition-block')) return;
        ev.preventDefault();
        handleSubmit(target);
      }, true);
    }

    function bindPercents(){
      [els.pMatMarkup, els.pWorkMarkup, els.pTransport, els.pMatMargin, els.pWorkMargin]
        .forEach(inp => inp.addEventListener('input', recalcAll));
    }

    async function start(){
      await loadComposition();
      attachAutocomplete($('.tc-ac[data-kind="material"]'));
      attachAutocomplete($('.tc-ac[data-kind="work"]'));
      bindDeleteAndQty();
      bindPercents();
      attachSubmitHooks();
      unhideRealPercentFieldsOnError();
      if (isNew){ els.loading.style.display='none'; els.content.style.display=''; }
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', start); else start();
  })();
  </script>
{% endblock %}